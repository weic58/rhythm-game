<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯€å¥éŠæˆ² Plus</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    <style>
        :root {
            --primary-color: #ff4757;
            --secondary-color: #2ed573;
            --accent-color: #54a0ff;
            --bg-color: #f1f2f6;
            --box-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .icon-btn {
            background: white; border: 2px solid #ddd; width: 50px; height: 50px;
            border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); }

        .btn-primary {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 30px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); transition: 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-action {
            background-color: var(--accent-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: auto; flex-shrink: 0;
        }

        .btn-upload {
            background-color: var(--secondary-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: 100%; margin-top: 5px;
        }

        .btn-test {
            background-color: #a4b0be; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-left: 5px;
        }

        /* é è¦½å€åŸŸæ¨£å¼ */
        #preview-area {
            display: none; margin-top: 15px;
            background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        #preview-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;
        }

        .preview-item { 
            position: relative; border: 1px solid #ddd; border-radius: 8px; 
            overflow: hidden; background: #fff; display: flex; flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .preview-toolbar {
            display: flex; justify-content: flex-end; gap: 8px; padding: 6px;
            background: #f8f9fa; border-bottom: 1px solid #eee;
        }

        .btn-mini {
            color: white; border: none; border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        /* æ–°å¢ï¼šè£åˆ‡æŒ‰éˆ• (æ©˜è‰²) */
        .btn-crop { background: rgba(230, 126, 34, 0.9); }
        .btn-swap { background: rgba(84, 160, 255, 0.9); }
        .btn-remove { background: rgba(255, 107, 107, 0.9); }
        .btn-mini:hover { transform: scale(1.1); }
        /* --- CSS æ–°å¢éƒ¨åˆ† --- */
        .btn-ai-mini { 
            background: #a55eea; /* ç´«è‰² */
            color: white; border: none; border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-ai-mini:hover { transform: scale(1.1); }
        
        .preview-header-controls {
            display: flex; justify-content: space-between; margin-bottom: 10px;
        }

        .preview-img {
            width: 100%; height: 160px; 
            object-fit: contain; display: block; background: #fff;
            padding: 5px; box-sizing: border-box;
        }

        .preview-edit {
            display: flex; width: 100%; border-top: 1px solid #eee;
        }
        .preview-input {
            flex: 1; border: none; padding: 8px; font-size: 0.9rem; text-align: center;
            background: #fff; outline: none; color: #333; font-weight: bold;
        }
        .preview-input:focus { background: #f0f8ff; }
        
        .preview-btn-search {
            width: 35px; border: none; background: #eee; cursor: pointer; 
            font-size: 1rem; display: flex; align-items: center; justify-content: center;
            border-left: 1px solid #ddd;
        }
        .preview-btn-search:hover { background: var(--accent-color); color: white; }

        .preview-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }

        /* ä¸»ç•«é¢ */
        #home-screen {
            text-align: center; position: relative; width: 100%; max-width: 500px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        #settings-trigger { position: absolute; top: -80px; right: 20px; }
        #mute-home { position: absolute; top: -80px; left: 20px; }
        
        h1 { font-size: 2.5rem; color: #333; margin-bottom: 5px; }

        .theme-selector {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 80%;
        }
        select {
            padding: 10px; font-size: 1.2rem; border-radius: 8px;
            border: 1px solid #ccc; width: 100%; margin-top: 5px;
        }

        /* å½ˆçª— */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto;
            position: relative; animation: popUp 0.3s ease;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }

        .control-group {
            margin-bottom: 15px; text-align: left; background: #f8f9fa;
            padding: 12px; border-radius: 10px;
        }
        .control-group label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="range"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; }
        input[type="text"] { border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        
        #file-status { color: #2ed573; font-weight: bold; font-size: 0.85rem; margin-top: 5px; word-break: break-all; }
        #upload-status { font-size: 0.85rem; color: #2ed573; margin-top: 5px; }
        #search-status { font-size: 0.85rem; color: var(--accent-color); margin-top: 5px; font-weight: bold; }

        /* éŠæˆ²ç•«é¢ */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; max-width: 800px; position: relative;
        }
        .top-bar {
            position: absolute; top: -80px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .top-right-controls { display: flex; gap: 10px; }
        #info-bar {
            font-size: 2rem; margin-bottom: 20px; font-weight: 900; color: #555;
            background: white; padding: 5px 20px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #grid-container {
            display: grid; grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 15px; width: 95%; aspect-ratio: 2/1;
        }
        .card {
            background-color: var(--box-bg); border-radius: 12px; display: flex;
            align-items: center; justify-content: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 5px solid #eee;
            transition: transform 0.1s; overflow: hidden; position: relative;
            flex-direction: column; 
        }
        
        .card-content {
            flex: 1; width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center; overflow: hidden;
            font-size: 4rem; 
        }
        
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card.contain-img img { object-fit: contain; width: 90%; height: 90%; }
        
        .card.chinese-mode .card-content { font-family: "Microsoft JhengHei", sans-serif; font-weight: 900; color: #d63031; }
        .card.math-mode .card-content { font-family: 'Times New Roman', serif; font-weight: bold; color: #0984e3; }

        /* ç­”æ¡ˆæ¨™ç±¤ */
        .answer-label {
            display: none; 
            width: 100%; background: rgba(0,0,0,0.7); color: white;
            font-size: 1.2rem; padding: 5px 0; text-align: center;
            position: absolute; bottom: 0; left: 0; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        .card.show-hint .answer-label { display: block; }

        .card.active {
            border-color: var(--primary-color) !important; transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.8); z-index: 5;
        }
        .card.active:not(.color-card) { background-color: #ffeaa7; }

        #pause-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50; display: none;
            align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        #pause-overlay h2 { color: white; font-size: 4rem; margin: 0 0 20px 0; }

        /* çµæŸç•«é¢ */
        #end-screen {
            display: none; flex-direction: column; align-items: center; gap: 20px;
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
        }
        
        #audio-player-container {
            width: 100%; background: #f1f2f6; padding: 10px; border-radius: 10px;
            text-align: center; display: none; margin-bottom: 10px;
        }
        audio { width: 100%; margin-top: 5px; }

        /* éŠæˆ²æ­·å²æ¸…å–® */
        #game-history {
            width: 100%; text-align: left; background: #fafafa; padding: 10px;
            border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px;
        }
        .history-round { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #ddd; }
        .history-title { font-weight:bold; color: var(--primary-color); margin-bottom: 5px; }
        .history-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        .history-item {
            display: flex; flex-direction: column; align-items: center; 
            border: 1px solid #eee; border-radius: 5px; padding: 5px; background: white;
        }
        .history-thumb { 
            width: 100%; aspect-ratio: 1; object-fit: contain; 
            display:flex; align-items:center; justify-content:center; font-size:1.5rem;
        }
        .history-name { font-size: 0.8rem; color: #555; text-align: center; margin-top: 2px; font-weight: bold; overflow-wrap: break-word; word-break: break-all; width: 100%;}

        .hidden { display: none !important; }
        #folder-input { display: none; }

        /* --- ä¿®æ”¹åˆ—è¡¨æ¨£å¼ï¼šæ”¯æ´ç¸®åœ–é¡¯ç¤º --- */
        .selection-item {
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;
            text-align: left; font-size: 0.9rem; color: #333;
            background: white; margin-bottom: 2px; border-radius: 4px;
            /* â˜… æ–°å¢ï¼šè®“åœ–æ–‡æ©«å‘æ’åˆ— */
            display: flex; align-items: center; gap: 10px;
            min-height: 50px; 
        }
        .selection-item:hover {
            background-color: var(--accent-color); color: white;
        }
        /* â˜… æ–°å¢ï¼šåˆ—è¡¨ç¸®åœ–æ¨£å¼ */
        .selection-thumb {
            width: 50px; height: 50px; border-radius: 4px; 
            object-fit: cover; background: #eee; flex-shrink: 0;
            border: 1px solid #ddd;
        }
        /* --- èƒŒæ™¯èˆ‡è£åˆ‡å™¨æ¨£å¼ --- */
        
        /* è£åˆ‡ä»‹é¢ (é è¨­éš±è—) */
        #cropper-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        #cropper-container {
            position: relative; max-width: 90%; max-height: 80%;
            border: 2px solid #555; overflow: hidden;
            user-select: none; touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹• */
        }

        #cropper-img {
            display: block; max-width: 100%; max-height: 60vh;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°å®¹å™¨ */
        }

        /* è£åˆ‡æ¡† (è¦–è¦ºä¸Šçš„é¸å–å€) */
        #crop-box {
            position: absolute; border: 2px dashed #fff;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* è®“æ¡†æ¡†ä»¥å¤–è®Šæš— */
            cursor: move; display: none; pointer-events: none;
        }

        .cropper-controls {
            margin-top: 15px; display: flex; gap: 15px;
        }

        /* æ‡‰ç”¨åˆ° Body çš„èƒŒæ™¯æ¨£å¼ */
        body.has-custom-bg {
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
        }
        /* ç•¶æœ‰èƒŒæ™¯åœ–æ™‚ï¼Œè®“ä¸»è¦å…§å®¹å€åŠ æ·±ä¸€é»åº•è‰²ï¼Œä»¥å…å­—çœ‹ä¸æ¸…æ¥š */
        body.has-custom-bg #home-screen, 
        body.has-custom-bg #game-screen {
            background: rgba(255, 255, 255, 0.85);
            padding: 20px; border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="home-screen">
        <button id="mute-home" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
        <button id="settings-trigger" class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
        
        <h1>ğŸµ ç¯€å¥éŠæˆ²</h1>
        <p style="color: #888; font-size: 1rem; margin-top: -10px; font-weight: bold;">
            Created by weic58 and Google Gemini
        </p>
        
        <div class="theme-selector">
            <label style="font-weight:bold; color:#555;">é¸æ“‡ä¸»é¡Œ</label>
            <select id="theme-select" onchange="saveSettings()">
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
                
                <optgroup label="ğŸ” è‡ªè¨‚æœå°‹">
                    </optgroup>

                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="flags">ğŸ—ºï¸ åœ‹æ——æŒ‘æˆ°</option>
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>

                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
            </select>
        </div>

        <div class="theme-selector" style="margin-top:10px;">
            <label style="font-weight:bold; color:#555;">ç¸½å›åˆæ•¸</label>
            <select id="round-select" onchange="saveSettings()">
                <option value="3">3 å›åˆ</option>
                <option value="5">5 å›åˆ</option>
                <option value="10">10 å›åˆ</option>
                <option value="999">ç„¡é™ç·´ç¿’</option>
            </select>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:200px;" onclick="startGame()">START</button>
    </div>

    <div id="settings-modal" onclick="closeSettings(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
                <button class="close-btn" onclick="closeSettingsBtn()">âœ•</button>
            </div>

            <div class="control-group" style="border: 2px solid #54a0ff; background: #f0f8ff;">
                <label style="color:#54a0ff;">ğŸ” é—œéµå­—æœå°‹ / è‡ªè¨‚ç·¨è¼¯</label>
                
                <div style="margin-bottom:8px; display:flex; gap:5px;">
                    <select id="search-source" style="width: 40%; font-size: 0.9rem; padding: 5px;">
                        <option value="wiki">ğŸ“– ç™¾ç§‘æ¢ç›® (é è¨­)</option>
                        <option value="commons">ğŸŒ å»£æ³›åœ–åº« (å¤šå…ƒ)</option>
                    </select>
                    <input type="text" id="custom-theme-title" style="width: 60%;" placeholder="ä¸»é¡Œåç¨± (é¸å¡«)">
                </div>

                <div style="display:flex; gap:5px; margin-bottom: 8px;">
                    <input type="text" id="search-input" style="flex:1;" placeholder="ä¾‹: è²“, ç‹—, 'Iron Man'">
                    <button class="btn-action" onclick="searchImages()" style="min-width: 60px;">ğŸ” æœå°‹</button>
                </div>

                <div style="display:flex; gap:5px;">
                    <button class="btn-action" style="background:#48dbfb; flex:1;" onclick="editCurrentTheme()" title="ä¿®æ”¹ç›®å‰é è¦½å…§å®¹">âœï¸ ä¿®æ”¹</button>
                    <button class="btn-action" style="background:#ff9f43; flex:1;" onclick="manualSaveData()" title="å°‡ç›®å‰ä¸»é¡Œæ°¸ä¹…å­˜æª”">ğŸ’¾ å­˜æª”</button>
                    <button class="btn-action" style="background:#ff7675; flex:1;" onclick="deleteCustomTheme()" title="åˆªé™¤é¸å–çš„ä¸»é¡Œ">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
                
                <div id="preview-area">
                    <div class="preview-header-controls">
                        <div style="font-size:0.8rem; color:#555; align-self:center;">é è¦½ç·¨è¼¯å€:</div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-test" onclick="addPreviewSlot()">â• åŠ ä¸€æ ¼</button>
                            <button class="btn-test" style="background:#ff6b6b; color:white;" onclick="clearPreviewSlots()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        </div>
                    </div>

                    <div id="preview-grid"></div>
                    
                    <div class="preview-controls">
                        <button class="btn-action" style="background:#2ed573;" onclick="confirmSearchTheme()">âœ… ç¢ºèªä½¿ç”¨</button>
                    </div>
                </div>
            </div>

            <div class="control-group" style="border: 2px dashed #2ed573; background: #eafff2;">
                <label>ğŸ“‚ ä¸Šå‚³è‡ªè¨‚ä¸»é¡Œè³‡æ–™å¤¾</label>
                <input type="file" id="folder-input" webkitdirectory directory multiple>
                <button class="btn-upload" onclick="document.getElementById('folder-input').click()">
                    é»æ“Šé¸æ“‡è³‡æ–™å¤¾...
                </button>
                <div id="upload-status">æª”åå³ç‚ºç­”æ¡ˆ (ä¾‹: çš®å¡ä¸˜.jpg)</div>
            </div>

            <div class="control-group" style="border: 2px solid #a55eea; background: #f3e5f5;">
                <label style="color:#a55eea;">ğŸ–¼ï¸ è‡ªè¨‚éŠæˆ²èƒŒæ™¯</label>
                <input type="file" id="bg-upload" accept="image/*" onchange="startCropper(this)">
                
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-action" style="background:#ff7675;" onclick="clearBackground()">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯</button>
                    <div style="font-size:0.8rem; color:#666; align-self:center;">(è£åˆ‡å¾Œè‡ªå‹•å„²å­˜)</div>
                </div>
            </div>

            <div class="control-group">
                <label>ğŸµ èƒŒæ™¯éŸ³æ¨‚</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size:0.85rem; color:#666;">ä¸Šå‚³æª”æ¡ˆ (MP3/WAV):</label>
                    <input type="file" id="music-file">
                </div>
                <div style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                    <span id="file-status">æœªé¸æ“‡æª”æ¡ˆ</span>
                    <button class="btn-test" onclick="testAudio()">ğŸ”Š è©¦è½</button>
                </div>
            </div>

            <div class="control-group">
                <label>ğŸ’¡ ç­”æ¡ˆæç¤º (æ¼¸é€²å¼è¨˜æ†¶):</label>
                <select id="hint-mode" onchange="saveSettings()">
                    <option value="first">åƒ…ç¬¬ä¸€å›åˆ (è¨˜æ†¶æ¨¡å¼)</option>
                    <option value="always">æ¯å›åˆéƒ½é¡¯ç¤º (ç·´ç¿’)</option>
                    <option value="none">éš±è— (è€ƒè©¦)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ”‚ åŒä¸€å›åˆé¡Œç›®é‡è¤‡åº¦:</label>
                <select id="unique-count" onchange="saveSettings()">
                    <option value="8">8 å¼µéƒ½ä¸ä¸€æ¨£ (é è¨­)</option>
                    <option value="4">4 ç¨®åœ– (å„å‡ºç¾2æ¬¡)</option>
                    <option value="2">2 ç¨®åœ– (å„å‡ºç¾4æ¬¡)</option>
                    <option value="1">1 ç¨®åœ– (å…¨éƒ¨ç›¸åŒ)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ™ï¸ éŠæˆ²éŒ„éŸ³ (çµæŸå¾Œå›æ”¾):</label>
                <select id="record-toggle" onchange="saveSettings()">
                    <option value="off">é—œé–‰</option>
                    <option value="on">é–‹å•Ÿ (éœ€éº¥å…‹é¢¨æ¬Šé™)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ¢â© éŸ³æ¨‚å€é€Ÿ: <span id="rate-display" style="color:#e056fd;">1.0</span>x</label>
                <input type="range" id="rate-input" min="0.5" max="2.0" step="0.1" value="1.0" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â±ï¸ åŸæ›²é€Ÿåº¦ (BPM): <span id="bpm-display" style="color:var(--primary-color);">165</span></label>
                <input type="range" id="bpm-input" min="60" max="180" value="165" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â¯ï¸ éŸ³æ¨‚èµ·é» (ç§’):</label>
                <input type="number" id="offset-input" value="0" step="0.1" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â³ éŸ³æ¨‚å¾Œç­‰å¾… (ç§’):</label>
                <input type="number" id="intro-seconds-input" value="2.5" step="0.1" placeholder="ä¾‹å¦‚: 2.5" oninput="saveSettings()">
                <div style="text-align:right; font-weight:bold; color:#555;">0.5å€é€Ÿè«‹èª¿æˆ5ç§’</div>
            </div>

            <div class="control-group">
                <label>ğŸ›Œ å›åˆé–“éš” (ç§’):</label>
                <input type="range" id="interval-input" min="0" max="5" value="0" step="0.5" oninput="saveSettings()">
                <div style="text-align:right; font-weight:bold; color:#555;"><span id="interval-display">0</span> ç§’</div>
            </div>
            
            <button class="btn-primary" style="width:100%; font-size:1rem;" onclick="closeSettingsBtn()">å®Œæˆ</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goHome()" title="å›é¦–é ">ğŸ </button>
            <div class="top-right-controls">
                <button id="mute-game" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
                <button class="icon-btn" id="pause-btn" onclick="togglePause()" title="æš«åœ">â¸</button>
                <button class="icon-btn" onclick="restartGame()" title="é‡ç½®">ğŸ”„</button>
            </div>
        </div>
        <div id="info-bar">Round <span id="current-round">1</span> / <span id="total-rounds">3</span></div>
        <div id="grid-container"></div>
    </div>

    <div id="pause-overlay">
        <h2>PAUSED</h2>
        <button class="btn-primary" style="width: 200px;" onclick="togglePause()">ç¹¼çºŒ</button>
    </div>

    <div id="end-screen">
        <h1>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h1>
        
        <div id="audio-player-container">
            <h3>ğŸ™ï¸ ä½ çš„è¡¨ç¾å›æ”¾</h3>
            <audio id="record-player" controls></audio>
        </div>

        <div style="width:100%;">
            <h3 style="margin-bottom:10px;">ğŸ“œ æœ¬å±€é¡Œç›®å›é¡§ (æ‰€æœ‰ç­”æ¡ˆ)</h3>
            <div id="game-history"></div>
        </div>

        <div style="display:flex; gap:20px; margin-top:10px;">
            <button class="icon-btn" onclick="goHome()">ğŸ </button>
            <button class="btn-primary" onclick="restartGame()">å†ä¾†ä¸€æ¬¡</button>
        </div>
    </div>

    <div id="cropper-modal">
        <h3 style="color:white; margin-bottom:10px;">âœ‚ï¸ è«‹æ‹–æ›³æ»‘é¼ é¸æ“‡ç¯„åœ</h3>
        <div id="cropper-container" onmousedown="cropDragStart(event)" onmousemove="cropDragMove(event)" onmouseup="cropDragEnd(event)"
             ontouchstart="cropDragStart(event)" ontouchmove="cropDragMove(event)" ontouchend="cropDragEnd(event)">
            <img id="cropper-img" src="">
            <div id="crop-box"></div>
        </div>
        <div class="cropper-controls">
            <button class="btn-primary" onclick="confirmCrop()">âœ… ç¢ºèªè£åˆ‡</button>
            <button class="btn-action" style="background:#777;" onclick="closeCropper()">âŒ å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« ---
        const flagsData = [
            { c: 'tw', n: 'å°ç£' }, { c: 'jp', n: 'æ—¥æœ¬' }, { c: 'us', n: 'ç¾åœ‹' }, { c: 'kr', n: 'éŸ“åœ‹' },
            { c: 'cn', n: 'ä¸­åœ‹' }, { c: 'gb', n: 'è‹±åœ‹' }, { c: 'fr', n: 'æ³•åœ‹' }, { c: 'de', n: 'å¾·åœ‹' },
            { c: 'it', n: 'ç¾©å¤§åˆ©' }, { c: 'ca', n: 'åŠ æ‹¿å¤§' }, { c: 'au', n: 'æ¾³æ´²' }, { c: 'br', n: 'å·´è¥¿' },
            { c: 'in', n: 'å°åº¦' }, { c: 'th', n: 'æ³°åœ‹' }, { c: 'vn', n: 'è¶Šå—' }, { c: 'ph', n: 'è²å¾‹è³“' },
            { c: 'my', n: 'é¦¬ä¾†è¥¿äº' }, { c: 'sg', n: 'æ–°åŠ å¡' }, { c: 'ch', n: 'ç‘å£«' }, { c: 'es', n: 'è¥¿ç­ç‰™' },
            { c: 'ru', n: 'ä¿„ç¾…æ–¯' }, { c: 'id', n: 'å°å°¼' }, { c: 'mx', n: 'å¢¨è¥¿å“¥' }, { c: 'tr', n: 'åœŸè€³å…¶' }
        ];

        const commonData = {
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'],
            numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            colors: [
                {c:'#ff0000', n:'ç´…'}, {c:'#00ff00', n:'ç¶ '}, {c:'#0000ff', n:'è—'}, 
                {c:'#ffff00', n:'é»ƒ'}, {c:'#000000', n:'é»‘'}, {c:'#ffffff', n:'ç™½'}, 
                {c:'#ff00ff', n:'ç´«'}, {c:'#00ffff', n:'é’'}, {c:'#ffa500', n:'æ©˜'}
            ],
            math: ['+','-','Ã—','Ã·','=','â‰ ','â‰ˆ','>','<','Ï€','âˆš','âˆ','âˆ«','âˆ†','âˆ‘','Î©'],
            food: [
                { u: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&q=80', n: 'Pizza' },
                { u: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&q=80', n: 'Burger' },
                { u: 'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=400&q=80', n: 'Sushi' },
                { u: 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80', n: 'Pancake' },
                { u: 'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=400&q=80', n: 'Pasta' },
                { u: 'https://images.unsplash.com/photo-1529042410759-befb1204b468?w=400&q=80', n: 'Meatball' },
                { u: 'https://images.unsplash.com/photo-1551024709-8f23befc6f87?w=400&q=80', n: 'Drink' },
                { u: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&q=80', n: 'BBQ' }
            ]
        };

        const chineseGroups = {
            'shi': ['æ˜¯','äº‹','ä¸–','å¸‚','å¼','è©¦','å£«','ç¤º','è¦–','èª“','æ–½','æ¿•','ç…','å¤±','å²','ä½¿','å§‹','çŸ³','é£Ÿ','å','å¯¦'],
            'ji': ['æ©Ÿ','é›','åŸº','ç©','ç¸¾','è·¡','æ¿€','æ¥µ','æ€¥','å‰','å³','é›†','æ“Š','è¨ˆ','è¨˜','å­£','æŠ€','æ—¢','æ¿Ÿ','ç¹¼'],
            'yi': ['ä¸€','é†«','è¡£','ä¾','ä¼Š','ç§»','ç–‘','å„€','å®œ','éº','ä¹™','å·²','ä»¥','èŸ»','å€š','æ„','ç¾©','è­°','ç›Š','è—'],
            'fu': ['å¤«','è†š','ç¦','æœ','å¹…','åºœ','çˆ¶','ä»˜','è² ','å©¦','å¯Œ','å‰¯','å¾©','è…¹','è¦†','æµ®','æ‰¶','ç¬¦'],
            'yu': ['é­š','æ¼','æ–¼','é¤˜','å¨›','æ„š','é›¨','èˆ‡','äºˆ','èª','ç¾½','ç‰','è‚²','é ','é‡','æ¬²','ç„','åŸŸ']
        };

        let customData = {}; 
        let searchData = {}; 
        let tempSearchItems = []; 

        // --- æ–°å¢è®Šæ•¸ï¼šè¨˜éŒ„è£åˆ‡ç›®æ¨™ ---
        let cropTargetType = 'bg'; // 'bg' (èƒŒæ™¯) æˆ– 'card' (å¡ç‰‡)
        let cropTargetIndex = -1;  // å¦‚æœæ˜¯å¡ç‰‡ï¼Œè¨˜éŒ„æ˜¯ç¬¬å¹¾æ ¼

        let gameState = {
            round: 0, maxRounds: 3, theme: 'flags', bpm: 165,
            offset: 0, interval: 0, introSeconds: 2.4, playbackRate: 1.0, 
            isPaused: false, abortController: null, selectedTheme: 'flags',
            isRecording: false, 
            activePool: [], 
            hintMode: 'first',
            uniqueCount: 8, 
            isMuted: false, 
            history: [] 
        };

        let audioCtx;
        let bgmAudio = new Audio();
        bgmAudio.preload = "auto"; 
        
        let mediaRecorder;
        let audioChunks = [];

        // --- 1. ç¶œåˆæœå°‹ (V8.6: é‚è¼¯åˆ¤æ–· - å–®çµ„ç…§æ¢ç›®ï¼Œå¤šçµ„ç…§è¼¸å…¥) ---
        async function searchImages() {
            const inputVal = document.getElementById('search-input').value.trim();
            if (!inputVal) return;

            // æ™ºæ…§åˆ†è©
            let keywords = inputVal.split(/[,ï¼Œã€]|\s+(?=[\u4e00-\u9fa5])|(?<=[\u4e00-\u9fa5])\s+/).map(k => k.trim()).filter(k => k);

            if (keywords.length === 0) return;

            const previewArea = document.getElementById('preview-area');
            const grid = document.getElementById('preview-grid');
            
            previewArea.style.display = 'block';
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ğŸ” æ™ºæ…§æœå°‹ä¸­...</div>';
            tempSearchItems = [];

            const source = document.getElementById('search-source').value;

            // â˜…â˜…â˜… åˆ¤æ–·æ˜¯ã€Œå–®çµ„ã€é‚„æ˜¯ã€Œå¤šçµ„ã€ â˜…â˜…â˜…
            const isSingleSearch = (keywords.length === 1);

            for (let i = 0; i < keywords.length; i++) {
                // å–®çµ„æŠ“12å¼µï¼Œå¤šçµ„æŠ“1å¼µ
                const limit = isSingleSearch ? 12 : 1;
                
                // â˜… å°‡ isSingleSearch å‚³å…¥ fetchWikiSmart
                // true -> ä½¿ç”¨ Wiki æ¢ç›®å (ä¾‹å¦‚ "Iron Man (film)")
                // false -> å¼·åˆ¶ä½¿ç”¨ keywords[i] (ä¾‹å¦‚ "Iron Man")
                const items = await fetchWikiSmart(keywords[i], source, limit, isSingleSearch);
                
                if (items.length > 0) {
                    if(isSingleSearch) {
                         tempSearchItems = items; 
                    } else {
                         tempSearchItems.push(items[0]);
                    }
                } else {
                    tempSearchItems.push({
                        label: keywords[i],
                        images: [`https://placehold.co/200x200?text=${keywords[i]}`],
                        currentIndex: 0
                    });
                }
            }

            if (tempSearchItems.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">æ‰¾ä¸åˆ°åœ–ç‰‡</div>';
            } else {
                renderPreviewGrid();
                
                // ç‹€æ…‹æç¤º
                const statusDiv = document.getElementById('search-status');
                if (keywords.length > 1) {
                    statusDiv.innerText = "âœ… æ‰¹é‡æ¨¡å¼ï¼šåç¨±å·²é–å®šç‚ºæ‚¨è¼¸å…¥çš„é—œéµå­—";
                } else {
                    statusDiv.innerText = "âœ… å–®è©æ¨¡å¼ï¼šåç¨±é¡¯ç¤ºç‚ºç¶­åŸºç™¾ç§‘æ¢ç›®";
                }
            }
        }

        // --- â˜…â˜…â˜… æ™ºæ…§æœå°‹ Helper (V9: æ”¯æ´å¤šåœ–åº«å­˜ + å°é¢åœ–å„ªå…ˆ) â˜…â˜…â˜… ---
        async function fetchWikiSmart(keyword, source, limit, useWikiTitle = false) {
            const isChinese = /[\u4e00-\u9fa5]/.test(keyword);
            const baseUrl = (source === 'wiki' && isChinese)
                ? 'https://zh.wikipedia.org/w/api.php?variant=zh-tw' 
                : (source === 'wiki' ? 'https://en.wikipedia.org/w/api.php' : 'https://commons.wikimedia.org/w/api.php');

            // èª¿æ•´ç­–ç•¥ï¼šæˆ‘å€‘éœ€è¦æŠ“å–ã€Œå°é¢åœ– (PageImages)ã€è€Œéé å…§åœ–ï¼Œå› ç‚ºé€™æ¨£è·Ÿæœå°‹åˆ—è¡¨æœ€ä¸€è‡´ï¼Œä¸”é©åˆã€Œæ›ä¸€å¼µã€
            const searchUrl = `${baseUrl}&action=query&generator=search&gsrsearch=${encodeURIComponent(keyword)}&gsrlimit=${limit * 5}&prop=pageimages|info&pithumbsize=600&format=json&origin=*`;
            
            const cleanKw = encodeURIComponent(keyword);
            const commonsUrl = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${cleanKw}%20filetype:bitmap%20-icon%20-logo%20-flag%20-map%20-diagram&gsrnamespace=6&gsrlimit=${limit * 5}&prop=imageinfo&iiprop=url&format=json&origin=*`;

            try {
                const targetUrl = (source === 'commons') ? commonsUrl : searchUrl;
                const res = await fetch(targetUrl);
                const data = await res.json();
                const items = [];
                const seenUrls = new Set();

                // æš«å­˜æ± ï¼šå¦‚æœæ˜¯å¤šé—œéµå­—æ¨¡å¼ï¼Œæˆ‘å€‘è¦æ”¶é›†å¤šå¼µåœ–çµ¦åŒä¸€å€‹ Item
                let collectedImages = [];

                if (data.query && data.query.pages) {
                    const pages = Object.values(data.query.pages);
                    pages.sort((a, b) => (a.index || 999) - (b.index || 999));

                    for(let page of pages) {
                        let imgUrl = null;
                        let title = page.title;

                        if (source !== 'wiki') {
                            title = title.replace(/^File:/, '').replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                        }

                        if (source === 'wiki') {
                            if (page.thumbnail) imgUrl = page.thumbnail.source;
                        } else {
                            if (page.imageinfo && page.imageinfo[0]) imgUrl = page.imageinfo[0].url;
                        }

                        // éæ¿¾
                        if (imgUrl) {
                            const lowerU = imgUrl.toLowerCase();
                            if (!lowerU.endsWith('.svg') && !lowerU.includes('icon') && !seenUrls.has(imgUrl)) {
                                seenUrls.add(imgUrl);
                                collectedImages.push(imgUrl);

                                // å¦‚æœæ˜¯ã€Œå–®é—œéµå­—æœå°‹ã€(limit > 1)ï¼Œæˆ‘å€‘è¦ç”¢å‡ºå¤šå€‹ä¸åŒçš„ Item
                                if (limit > 1) {
                                    const finalLabel = useWikiTitle ? title : keyword;
                                    items.push({
                                        label: finalLabel,
                                        images: [imgUrl], // é€™è£¡æš«æ™‚åªæ”¾ä¸€å¼µï¼Œä¹‹å¾Œæ›åœ–éœ€é å–®æ ¼æœå°‹
                                        currentIndex: 0
                                    });
                                }
                            }
                        }
                    }

                    // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå¦‚æœæ˜¯ã€Œå¤šé—œéµå­—æœå°‹ã€(limit == 1)ï¼ŒæŠŠæ”¶é›†åˆ°çš„åœ–éƒ½å¡çµ¦å®ƒ â˜…â˜…â˜…
                    if (limit === 1 && collectedImages.length > 0) {
                        items.push({
                            label: keyword,
                            images: collectedImages, // é€™è£¡æœƒæœ‰ [åœ–1, åœ–2, åœ–3...]ï¼Œæ‰€ä»¥æ›ä¸€å¼µæœ‰ç”¨ï¼
                            currentIndex: 0
                        });
                    }
                }
                
                // å¦‚æœæ˜¯å–®é—œéµå­—æ¨¡å¼ï¼Œåªå›å‚³å‰ N å€‹
                if (limit > 1) return items.slice(0, limit);
                // å¦‚æœæ˜¯å¤šé—œéµå­—æ¨¡å¼ï¼Œå›å‚³é€™ä¸€å€‹æ•´åˆå¥½çš„ Item
                return items;

            } catch(e) {
                console.error(e);
                return [];
            }
        }

        // é€šç”¨è§£æå™¨
        async function fetchAndParse(url, type) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                const items = [];
                const seenUrls = new Set();

                if (data.query && data.query.pages) {
                    Object.values(data.query.pages).forEach(page => {
                        let imgUrl = null;
                        let title = page.title;

                        if (type === 'wiki') {
                            if (page.thumbnail) imgUrl = page.thumbnail.source;
                        } else {
                            if (page.imageinfo && page.imageinfo[0]) imgUrl = page.imageinfo[0].url;
                            title = title.replace(/^File:/, '').replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                        }

                        // æ’é™¤é è¨­çš„ç¶­åŸºç™¾ç§‘ä½”ä½åœ– (æœ‰äº›æ¢ç›®æœ‰åœ–ç¤ºä½†ä¸æ˜¯ç…§ç‰‡)
                        if (imgUrl && !imgUrl.includes('Defaut') && !imgUrl.includes('Icon') && !seenUrls.has(imgUrl)) {
                            seenUrls.add(imgUrl);
                            items.push({
                                label: title,
                                images: [imgUrl],
                                currentIndex: 0
                            });
                        }
                    });
                }
                return items;
            } catch(e) {
                console.error(e);
                return [];
            }
        }

        // å¹«å–®ä¸€é—œéµå­—æ‰¾åœ– (ç²¾æº–åŒ–)
        async function fetchSpecificKeyword(keyword, source) {
            try {
                let url = '';
                if (source === 'wiki') {
                    const isChinese = /[\u4e00-\u9fa5]/.test(keyword);
                    const baseUrl = isChinese 
                        ? 'https://zh.wikipedia.org/w/api.php?variant=zh-tw' 
                        : 'https://en.wikipedia.org/w/api.php';

                    // â˜…â˜…â˜… æ”¹ç”¨ prefixsearch â˜…â˜…â˜…
                    url = `${baseUrl}&action=query&generator=prefixsearch&gpssearch=${encodeURIComponent(keyword)}&gpslimit=5&prop=pageimages&pithumbsize=400&format=json&origin=*`;
                } else {
                    const cleanKw = encodeURIComponent(keyword);
                    url = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${cleanKw}%20filetype:bitmap&gsrnamespace=6&gsrlimit=5&prop=imageinfo&iiprop=url&format=json&origin=*`;
                }

                const res = await fetch(url);
                const data = await res.json();
                
                let foundItem = null;

                if (data.query && data.query.pages) {
                    const pages = Object.values(data.query.pages);
                    for (let page of pages) {
                        let imgUrl = null;
                        let title = page.title;

                        if (source === 'wiki') {
                            if (page.thumbnail) imgUrl = page.thumbnail.source;
                        } else {
                            if (page.imageinfo && page.imageinfo[0]) imgUrl = page.imageinfo[0].url;
                            title = title.replace(/^File:/, '').replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                        }

                        if (imgUrl) {
                            foundItem = {
                                label: title, 
                                images: [imgUrl],
                                currentIndex: 0
                            };
                            break;
                        }
                    }
                }

                if (foundItem) {
                    tempSearchItems.push(foundItem);
                } else {
                    tempSearchItems.push({
                        label: keyword,
                        images: [`https://placehold.co/200x200?text=${keyword}`],
                        currentIndex: 0
                    });
                }

            } catch(e) { console.error(e); }
        }

        // --- 2. å–®æ ¼æ›´æ–° (V8.7: åˆ—è¡¨é¡¯ç¤ºç¸®åœ– + Proxy æ”¯æ´) ---
        async function updateSingleSlot(index) {
            const inputEl = document.getElementById(`input-${index}`);
            const newKeyword = inputEl.value.trim();
            if (!newKeyword) return;
            
            // åŒæ­¥è¼¸å…¥æ¡†
            if(tempSearchItems[index]) tempSearchItems[index].label = newKeyword;

            const source = document.getElementById('search-source').value;
            const container = document.getElementById(`prev-img-${index}`).parentNode;

            const oldOverlay = container.querySelector('.selection-overlay');
            if (oldOverlay) oldOverlay.remove();

            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'selection-overlay';
            loadingOverlay.innerHTML = '<div style="margin:auto;">ğŸ” æœå°‹ä¸­...</div>';
            container.appendChild(loadingOverlay);

            const processData = (data) => {
                loadingOverlay.innerHTML = '';
                const closeBtn = document.createElement('div');
                closeBtn.className = 'selection-close';
                closeBtn.innerText = 'å–æ¶ˆ âœ•';
                closeBtn.onclick = () => loadingOverlay.remove();
                loadingOverlay.appendChild(closeBtn);

                if (data.query && data.query.pages) {
                    let pages = Object.values(data.query.pages);
                    pages.sort((a, b) => (a.index || 999) - (b.index || 999));

                    pages.forEach(page => {
                        // 1. è™•ç†æ¨™é¡Œ
                        let title = page.title;
                        if (source !== 'wiki') {
                            title = title.replace(/^File:/, '').replace(/\.[^/.]+$/, "").replace(/_/g, ' ');
                        }

                        // 2. â˜…â˜…â˜… è™•ç†ç¸®åœ– URL â˜…â˜…â˜…
                        let thumbUrl = 'https://placehold.co/100x100?text=NoImg'; // é è¨­åœ–
                        if (source === 'wiki') {
                            if (page.thumbnail && page.thumbnail.source) {
                                thumbUrl = page.thumbnail.source;
                            } else {
                                thumbUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Text_document_with_red_question_mark.svg/50px-Text_document_with_red_question_mark.svg.png'; // æ–‡ä»¶åœ–ç¤º
                            }
                        } else {
                            // Commons
                            if (page.imageinfo && page.imageinfo[0] && page.imageinfo[0].thumburl) {
                                thumbUrl = page.imageinfo[0].thumburl;
                            }
                        }

                        // 3. å»ºç«‹é …ç›® (å«åœ–ç‰‡)
                        const item = document.createElement('div');
                        item.className = 'selection-item';
                        
                        // æ’å…¥ HTML: [åœ–ç‰‡] + [æ–‡å­—]
                        item.innerHTML = `
                            <img src="${thumbUrl}" class="selection-thumb" onerror="this.src='https://placehold.co/50?text=Err'">
                            <span style="flex:1;">${title}</span>
                        `;
                        
                        item.onclick = () => {
                            if (typeof selectWikiEntry === 'function') {
                                selectWikiEntry(index, page.title, source, loadingOverlay);
                            }
                        };
                        loadingOverlay.appendChild(item);
                    });
                } else {
                    loadingOverlay.innerHTML += `<div style="margin:auto; color:red;">æ‰¾ä¸åˆ°ã€Œ${newKeyword}ã€</div>`;
                }
            };

            // â˜…â˜…â˜… API åƒæ•¸èª¿æ•´ï¼šè«‹æ±‚ç¸®åœ– (Thumbnail) â˜…â˜…â˜…
            let targetUrl = '';
            if (source === 'wiki') {
                const isChinese = /[\u4e00-\u9fa5]/.test(newKeyword);
                const baseUrl = isChinese 
                    ? 'https://zh.wikipedia.org/w/api.php?variant=zh-tw' 
                    : 'https://en.wikipedia.org/w/api.php';
                
                // åŠ å…¥ pithumbsize=100 (è¦æ±‚100pxç¸®åœ–)
                targetUrl = `${baseUrl}&action=query&generator=search&gsrsearch=${encodeURIComponent(newKeyword)}&gsrlimit=10&prop=pageimages|info&pithumbsize=100&format=json&origin=*`;
            } else {
                const cleanKw = encodeURIComponent(newKeyword);
                // åŠ å…¥ iiurlwidth=100 (Commonsè¦æ±‚ç¸®åœ–)
                targetUrl = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${cleanKw}%20filetype:bitmap&gsrnamespace=6&gsrlimit=10&prop=imageinfo&iiprop=url&iiurlwidth=100&format=json&origin=*`;
            }

            try {
                const res = await fetch(targetUrl);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                processData(data);
            } catch(e) {
                console.warn("ç›´æ¥é€£ç·šå¤±æ•—ï¼Œåˆ‡æ› Proxy...", e);
                loadingOverlay.innerHTML = '<div style="margin:auto;">âš ï¸ å˜—è©¦å‚™ç”¨ç·šè·¯...</div>';
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                    const resProxy = await fetch(proxyUrl);
                    if (!resProxy.ok) throw new Error(`Proxy Error`);
                    const dataProxy = await resProxy.json();
                    processData(dataProxy);
                } catch(proxyError) {
                    loadingOverlay.innerHTML = `<div style="margin:auto; color:red; padding:10px;">é€£ç·šå¤±æ•—<br>è«‹æª¢æŸ¥ç¶²è·¯</div>`;
                    const errClose = document.createElement('div');
                    errClose.className = 'selection-close';
                    errClose.innerText = 'é—œé–‰';
                    errClose.onclick = () => loadingOverlay.remove();
                    loadingOverlay.prepend(errClose);
                }
            }
        }

        // --- ä¿®å¾©ç‰ˆï¼šé»æ“Šåˆ—è¡¨æŠ“åœ– (å« Proxy æ•‘æ´æ©Ÿåˆ¶) ---
        async function selectWikiEntry(index, exactTitle, source, overlay) {
            overlay.innerHTML = '<div style="margin:auto; color:#333;">â³ æ­£åœ¨ä¸‹è¼‰è³‡æ–™...</div>';
            
            // å®šç¾©æ•‘æ´å‡½å¼ï¼šå¦‚æœç›´é€£å¤±æ•—ï¼Œå°±èµ°ä»£ç†ä¼ºæœå™¨
            const fetchWithProxy = async (targetUrl) => {
                try {
                    // 1. å…ˆå˜—è©¦ç›´é€£ (æœ‰äº›ç¶²ç«™å…è¨±)
                    const res = await fetch(targetUrl); 
                    if (!res.ok) throw new Error("Direct fail");
                    return await res.json();
                } catch (e) {
                    // 2. ç›´é€£å¤±æ•—ï¼Œæ”¹ç”¨ Proxy (è§£æ±ºæœ¬æ©Ÿ file:/// è·¨åŸŸå•é¡Œ)
                    console.warn("ç›´é€£å¤±æ•—ï¼Œåˆ‡æ›ç·šè·¯...");
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                    const resProxy = await fetch(proxyUrl);
                    return await resProxy.json();
                }
            };

            try {
                let imgUrl = null;
                const isChinese = /[\u4e00-\u9fa5]/.test(exactTitle);
                const baseUrl = (source === 'wiki' && isChinese)
                    ? 'https://zh.wikipedia.org/w/api.php?variant=zh-tw' 
                    : (source === 'wiki' ? 'https://en.wikipedia.org/w/api.php' : 'https://commons.wikimedia.org/w/api.php');

                // æ­¥é©Ÿ A: æŠ“å°é¢åœ–
                if (source === 'wiki') {
                    const coverUrl = `${baseUrl}&action=query&titles=${encodeURIComponent(exactTitle)}&prop=pageimages&pithumbsize=600&format=json&origin=*`;
                    const dataCover = await fetchWithProxy(coverUrl);
                    if (dataCover.query && dataCover.query.pages) {
                        const p = Object.values(dataCover.query.pages)[0];
                        if (p.thumbnail) imgUrl = p.thumbnail.source;
                    }
                }

                // æ­¥é©Ÿ B: æŠ“é å…§åœ– (å‚™ç”¨)
                let imagesUrl = '';
                if (source === 'wiki') {
                    imagesUrl = `${baseUrl}&action=query&titles=${encodeURIComponent(exactTitle)}&generator=images&gimlimit=10&prop=imageinfo&iiprop=url&format=json&origin=*`;
                } else {
                    imagesUrl = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(exactTitle)}&prop=imageinfo&iiprop=url&format=json&origin=*`;
                }

                const dataImages = await fetchWithProxy(imagesUrl);
                let otherImages = [];
                if (dataImages.query && dataImages.query.pages) {
                    Object.values(dataImages.query.pages).forEach(p => {
                        if (p.imageinfo && p.imageinfo[0]) {
                            const u = p.imageinfo[0].url;
                            const lowerU = u.toLowerCase();
                            if (!lowerU.endsWith('.svg') && !lowerU.includes('icon') && u !== imgUrl) {
                                otherImages.push(u);
                            }
                        }
                    });
                }

                // æ•´åˆåœ–ç‰‡
                let finalImages = [];
                if (imgUrl) finalImages.push(imgUrl);
                if (!imgUrl && otherImages.length > 0) finalImages.push(otherImages[0]);
                else if (imgUrl) finalImages = [...finalImages, ...otherImages];

                finalImages = [...new Set(finalImages)]; // å»é™¤é‡è¤‡

                if (finalImages.length > 0) {
                    // æ›´æ–°ä»‹é¢
                    tempSearchItems[index].images = finalImages;
                    tempSearchItems[index].currentIndex = 0;
                    
                    // æ›´æ–°é è¦½ç•«é¢ (é€™è£¡ä¸éœ€è¦è‡ªå‹•é–‹å•Ÿè£åˆ‡ï¼Œåªæ›´æ–°åœ–ç‰‡)
                    const imgEl = document.getElementById(`prev-img-${index}`);
                    if(imgEl) imgEl.src = finalImages[0];
                    
                    overlay.remove();
                } else {
                    alert("é€™å‰‡æ¢ç›®æ‰¾ä¸åˆ°é©åˆçš„åœ–ç‰‡ï¼Œè«‹è©¦è©¦åˆ¥çš„ã€‚");
                    overlay.remove();
                }

            } catch(e) {
                console.error(e);
                alert("æŠ“åœ–ç™¼ç”ŸéŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š)");
                overlay.remove();
            }
        }

        // --- 13. å®Œæˆå¡ç‰‡æ›´æ–° (è£åˆ‡å¾Œå‘¼å«) ---
        function finishCardUpdate(imgData, index) {
            const imgEl = document.getElementById(`prev-img-${index}`);
            const inputEl = document.getElementById(`input-${index}`);

            // æ›´æ–°æ•¸æ“š
            tempSearchItems[index].images = [imgData]; // è¨­å®šç‚ºè£åˆ‡å¾Œçš„åœ–
            
            // å¦‚æœæœ‰ä¹‹å‰æŠ“åˆ°çš„å‚™ç”¨åœ– (æ›ä¸€å¼µç”¨)ï¼Œå¯ä»¥è£œå›å»
            // (æ³¨æ„ï¼šæ›ä¸€å¼µæœƒæŠŠè£åˆ‡éçš„åœ–æ›æ‰ï¼Œè®Šå›åŸå§‹çš„ç¶­åŸºåœ–)
            if (tempSearchItems[index].backupImages) {
                // æŠŠè£åˆ‡åœ–æ”¾åœ¨ç¬¬ä¸€å¼µï¼Œå¾Œé¢æ¥åŸæœ¬çš„ç¶­åŸºåœ–
                const backups = tempSearchItems[index].backupImages;
                tempSearchItems[index].images = [imgData, ...backups];
            }

            tempSearchItems[index].currentIndex = 0;
            tempSearchItems[index].isAI = false;
            
            // é–å®šæ¨™é¡Œ
            if(inputEl) tempSearchItems[index].label = inputEl.value;

            // æ›´æ–°ç•«é¢
            if(imgEl) imgEl.src = imgData;
        }

        // --- 8. ç³»çµ±å­˜æª”èˆ‡ç®¡ç†å“¡åŠŸèƒ½ (æ–°åŠŸèƒ½) ---

        // å„²å­˜è‡ªè¨‚ä¸»é¡Œåˆ°ç€è¦½å™¨
        function saveSearchData() {
            try {
                localStorage.setItem('rg_search_data_v2', JSON.stringify(searchData));
            } catch(e) {
                console.error("å­˜æª”å¤±æ•— (å¯èƒ½å®¹é‡ä¸è¶³)", e);
            }
        }

        // è®€å–å­˜æª”
        function loadSearchData() {
            const saved = localStorage.getItem('rg_search_data_v2');
            if (saved) {
                try {
                    searchData = JSON.parse(saved);
                    updateThemeSelect(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
                } catch(e) {
                    console.error("è®€å–å­˜æª”å¤±æ•—");
                }
            }
        }

        // ç®¡ç†å“¡æ¨¡å¼ï¼šåˆªé™¤è‡ªè¨‚ä¸»é¡Œ
        function deleteCustomTheme() {
            const select = document.getElementById('theme-select');
            const currentKey = select.value;

            // 1. æª¢æŸ¥æ˜¯å¦é¸ä¸­è‡ªè¨‚ä¸»é¡Œ
            if (!currentKey.startsWith('search_') || !searchData[currentKey]) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹ã€Œè‡ªè¨‚æœå°‹ä¸»é¡Œã€ï¼\n(å…§å»ºä¸»é¡Œç„¡æ³•åˆªé™¤)");
                return;
            }

            // 2. å¯†ç¢¼é©—è­‰ (ç°¡å–®é˜²è­·)
            const password = prompt("ğŸ”’ è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥åˆªé™¤æ­¤ä¸»é¡Œï¼š", "");
            if (password !== "8888") { // ä½ å¯ä»¥æŠŠ 1234 æ”¹æˆä½ æƒ³è¦çš„å¯†ç¢¼
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                return;
            }

            // 3. åŸ·è¡Œåˆªé™¤
            if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${searchData[currentKey].title}ã€å—ï¼Ÿ`)) {
                delete searchData[currentKey]; // å¾è¨˜æ†¶é«”åˆªé™¤
                saveSearchData(); // æ›´æ–°å­˜æª”
                updateThemeSelect(); // æ›´æ–°é¸å–®
                
                // åˆ‡æ›å›é è¨­å€¼
                select.value = "flags";
                saveSettings(); // å„²å­˜ç›®å‰çš„é¸æ“‡
                alert("âœ… ä¸»é¡Œå·²åˆªé™¤");
            }
        }

        // --- 9. ç®¡ç†å“¡æ‰‹å‹•å­˜æª” (æ¬Šé™æ§åˆ¶) ---
        function manualSaveData() {
            // 1. æª¢æŸ¥æ˜¯å¦æœ‰æ±è¥¿å¯ä»¥å­˜
            if (Object.keys(searchData).length === 0) {
                alert("ç›®å‰æ²’æœ‰ä»»ä½•è‡ªè¨‚ä¸»é¡Œå¯ä»¥å„²å­˜ã€‚");
                return;
            }

            // 2. å¯†ç¢¼é©—è­‰
            const password = prompt("ğŸ”’ã€ç®¡ç†å“¡æ¨¡å¼ã€‘\nè«‹è¼¸å…¥å¯†ç¢¼ä»¥å°‡ç›®å‰æ‰€æœ‰è‡ªè¨‚ä¸»é¡Œã€Œæ°¸ä¹…å­˜æª”ã€ï¼š", "");
            
            if (password === "8888") { // é è¨­å¯†ç¢¼ 1234
                saveSearchData(); // å‘¼å«çœŸæ­£çš„å¯«å…¥å‡½å¼
                alert("âœ… å­˜æª”æˆåŠŸï¼\nå³ä½¿é—œé–‰ç€è¦½å™¨ï¼Œé€™äº›ä¸»é¡Œä¹Ÿæœƒä¿ç•™ã€‚");
                document.getElementById('search-status').innerText = "âœ… ç³»çµ±å·²å­˜æª”";
            } else {
                if(password !== null) alert("â›” å¯†ç¢¼éŒ¯èª¤ï¼Œå–æ¶ˆå­˜æª”ã€‚");
            }
        }

        // --- JS æ–°å¢èˆ‡ä¿®æ”¹éƒ¨åˆ† ---

        // 1. æ–°å¢ç©ºç™½æ ¼å­
        function addPreviewSlot() {
            tempSearchItems.push({
                label: "New Item",
                images: [],
                currentIndex: 0
            });
            renderPreviewGrid();
        }

        // 2. æ¸…é™¤æ‰€æœ‰æ ¼å­
        function clearPreviewSlots() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰é è¦½çš„æ‰€æœ‰åœ–ç‰‡å—ï¼Ÿ")) {
                tempSearchItems = [];
                renderPreviewGrid();
            }
        }

        // 3. å–®æ ¼ AI ç”Ÿæˆ (æ–°åŠŸèƒ½)
        async function generateSingleSlotAI(index) {
            const inputEl = document.getElementById(`input-${index}`);
            const keyword = inputEl.value.trim();
            if (!keyword) { alert("è«‹å…ˆè¼¸å…¥é—œéµå­—"); return; }

            const imgEl = document.getElementById(`prev-img-${index}`);
            imgEl.style.opacity = 0.5; // è®€å–ä¸­æ•ˆæœ

            const seed = Math.floor(Math.random() * 100000);
            const prompt = `photo of ${keyword}, realistic, 8k, highly detailed`;
            const newUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}&nologo=true`;

            // é åŠ è¼‰åœ–ç‰‡ç¢ºä¿æˆåŠŸ
            const tempImg = new Image();
            tempImg.onload = () => {
                tempSearchItems[index].label = keyword;
                tempSearchItems[index].images = [newUrl]; // AIåœ–ç›´æ¥è¦†è“‹
                tempSearchItems[index].currentIndex = 0;
                imgEl.src = newUrl;
                imgEl.style.opacity = 1;
            };
            tempImg.onerror = () => {
                alert("AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                imgEl.style.opacity = 1;
            };
            tempImg.src = newUrl;
        }

        // --- ä¿®æ­£ç‰ˆ 3ï¼šæ¸²æŸ“ä»‹é¢ (åŠ å…¥è£åˆ‡æŒ‰éˆ•) ---
        function renderPreviewGrid() {
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            tempSearchItems.forEach((slot, index) => {
                if (slot.deleted) return;

                const div = document.createElement('div');
                div.className = 'preview-item';
                
                const currentImg = slot.images[slot.currentIndex % slot.images.length] || 'https://placehold.co/200x200?text=NoImg';
                
                div.innerHTML = `
                    <div class="preview-toolbar">
                        <button class="btn-mini btn-crop" onclick="cropPreviewImage(${index})" title="è£åˆ‡é€™å¼µåœ–">âœ‚ï¸</button>
                        
                        <button class="btn-ai-mini" onclick="generateSingleSlotAI(${index})" title="ç”¨é—œéµå­—AIç”Ÿæˆ">âœ¨</button>
                        <button class="btn-mini btn-swap" onclick="swapPreviewImage(${index})" title="æ›ä¸€å¼µ(ç¶­åŸº)">ğŸ”„</button>
                        <button class="btn-mini btn-remove" onclick="removePreviewImage(${index})" title="ç§»é™¤">âŒ</button>
                    </div>
                    
                    <img src="${currentImg}" class="preview-img" id="prev-img-${index}">
                    
                    <div class="preview-edit">
                        <input type="text" class="preview-input" 
                            value="${slot.label}" 
                            id="input-${index}" 
                            oninput="tempSearchItems[${index}].label = this.value"
                            onkeydown="if(event.key==='Enter') updateSingleSlot(${index})">
                        <button class="preview-btn-search" onclick="updateSingleSlot(${index})" title="æœå°‹ç¶­åŸº">ğŸ”</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function swapPreviewImage(index) {
            const slot = tempSearchItems[index];
            if (slot && slot.images.length > 1) {
                slot.currentIndex++;
                const newImg = slot.images[slot.currentIndex % slot.images.length];
                const imgEl = document.getElementById(`prev-img-${index}`);
                if(imgEl) imgEl.src = newImg;
            }
        }

        function removePreviewImage(index) {
            if(tempSearchItems[index]) {
                tempSearchItems[index].deleted = true;
                renderPreviewGrid();
            }
        }

        // --- 3. æ–°å¢ï¼šä¿®æ”¹ç›®å‰å·²é¸çš„ä¸»é¡Œ ---
        function editCurrentTheme() {
            const select = document.getElementById('theme-select');
            const currentKey = select.value;

            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªè¨‚æœå°‹ä¸»é¡Œ (key é–‹é ­æ˜¯ search_)
            if (!currentKey.startsWith('search_') || !searchData[currentKey]) {
                alert("ç›®å‰é¸æ“‡çš„ä¸æ˜¯ã€Œè‡ªè¨‚æœå°‹ä¸»é¡Œã€ï¼Œç„¡æ³•ä¿®æ”¹ã€‚\n(å…§å»ºä¸»é¡Œæˆ–è³‡æ–™å¤¾ç„¡æ³•åœ¨æ­¤ç·¨è¼¯)");
                return;
            }

            const data = searchData[currentKey];
            
            // 1. é‚„åŸæ¨™é¡Œè¼¸å…¥æ¡†
            document.getElementById('custom-theme-title').value = data.title;
            
            // 2. é‚„åŸæš«å­˜é™£åˆ— tempSearchItems
            // æˆ‘å€‘éœ€è¦æŠŠå„²å­˜çš„æ ¼å¼ (url, label) è½‰å›ç·¨è¼¯æ ¼å¼
            tempSearchItems = data.images.map(img => ({
                label: img.label,
                images: [img.content || img.url], // ç›¸å®¹èˆŠæ ¼å¼
                currentIndex: 0,
                deleted: false
            }));

            // 3. é¡¯ç¤ºé è¦½å€ä¸¦æ¸²æŸ“
            document.getElementById('preview-area').style.display = 'block';
            renderPreviewGrid();
            
            // 4. æç¤º
            document.getElementById('search-status').innerText = `âœï¸ æ­£åœ¨ç·¨è¼¯: ${data.title}`;
        }

        // --- ä¿®æ­£ç‰ˆ 5ï¼šç¢ºèªå¥—ç”¨ (åªæš«å­˜ï¼Œä¸è‡ªå‹•å¯«å…¥ç¡¬ç¢Ÿ) ---
        function confirmSearchTheme() {
            const activeItems = tempSearchItems.filter(item => !item.deleted);
            if (activeItems.length === 0) {
                alert("è«‹è‡³å°‘ä¿ç•™ä¸€å¼µåœ–ç‰‡ï¼");
                return;
            }

            // åŒæ­¥è¼¸å…¥æ¡†
            const finalImages = activeItems.map((slot, idx) => {
                return {
                    url: slot.images[slot.currentIndex % slot.images.length],
                    label: slot.label
                };
            });

            const titleInput = document.getElementById('custom-theme-title').value.trim();
            const firstKeyword = activeItems[0].label;
            const themeTitle = titleInput || `ğŸ” è‡ªè¨‚: ${firstKeyword}...`;

            // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯è¦†è“‹
            let themeKey = "search_" + Date.now();
            const currentSelect = document.getElementById('theme-select').value;
            if (currentSelect.startsWith('search_') && searchData[currentSelect]) {
                 themeKey = currentSelect;
            }

            // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„è³‡æ–™
            searchData[themeKey] = {
                images: finalImages,
                title: themeTitle
            };

            updateThemeSelect();
            document.getElementById('theme-select').value = themeKey;
            
            // â˜…â˜…â˜… æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† saveSearchData(); â˜…â˜…â˜…
            // ç¾åœ¨é€™è£¡åªæ˜¯ã€Œæš«å­˜ã€ï¼Œé‡æ–°æ•´ç†å¾Œæœƒæ¶ˆå¤±ï¼Œé™¤éä½ æ‰‹å‹•æŒ‰å­˜æª”
            saveSettings(); 
            
            document.getElementById('preview-area').style.display = 'none'; 
            document.getElementById('search-status').innerText = `âœ… å·²æš«å­˜: ${themeTitle} (æœªæ°¸ä¹…å„²å­˜)`;
        }

        // --- 2. è³‡æ–™å¤¾ & éŸ³æ¨‚ ---
        document.getElementById('folder-input').addEventListener('change', function(e) {
            const files = e.target.files;
            let count = 0;
            customData = {}; 
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;
                const pathParts = file.webkitRelativePath.split('/');
                let themeName = (pathParts.length > 1) ? pathParts[pathParts.length - 2] : "è‡ªè¨‚ç›¸ç°¿";
                if (!customData[themeName]) customData[themeName] = [];
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                customData[themeName].push({ url: URL.createObjectURL(file), label: fileName });
                count++;
            }
            updateThemeSelect();
            document.getElementById('upload-status').innerText = `âœ… æˆåŠŸè¼‰å…¥ ${Object.keys(customData).length} å€‹ä¸»é¡Œï¼Œå…± ${count} å¼µåœ–ç‰‡`;
        });

        document.getElementById('music-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('file-status').innerText = `âŒ› è®€å–ä¸­...`;

            const reader = new FileReader();
            reader.onload = function(evt) {
                bgmAudio.src = evt.target.result;
                bgmAudio.load();
                document.getElementById('file-status').innerText = `âœ… æœ¬åœ°æª”æ¡ˆ: ${file.name}`;
            };
            reader.onerror = function() { alert("è®€å–å¤±æ•—"); };
            reader.readAsDataURL(file);
            this.value = ''; 
        });

        function testAudio() {
            if (!bgmAudio.src) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
            bgmAudio.volume = gameState.isMuted ? 0 : 1.0;
            bgmAudio.playbackRate = parseFloat(document.getElementById('rate-input').value);
            
            const playPromise = bgmAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    document.getElementById('file-status').innerText += " (æ’­æ”¾ä¸­)";
                    setTimeout(() => { bgmAudio.pause(); bgmAudio.currentTime = 0; }, 3000); 
                })
                .catch(error => {
                    alert(`æ’­æ”¾å¤±æ•— (Error: ${error.name})`);
                });
            }
        }

        // --- éœéŸ³åŠŸèƒ½ ---
        function toggleMute() {
            gameState.isMuted = !gameState.isMuted;
            bgmAudio.muted = gameState.isMuted;
            const icon = gameState.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            document.getElementById('mute-home').innerText = icon;
            document.getElementById('mute-game').innerText = icon;
        }

        // --- 3. éŒ„éŸ³ ---
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            // HTTPS warning
        }

        async function startRecording() {
            if (document.getElementById('record-toggle').value !== 'on') return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; 
                }
                const options = mimeType ? { mimeType } : undefined;
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.start();
                gameState.isRecording = true;
            } catch (err) {
                console.error("Mic Error:", err);
                document.getElementById('record-toggle').value = 'off';
            }
        }

        function stopRecording() {
            if (gameState.isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(blob);
                    const player = document.getElementById('record-player');
                    player.src = audioUrl;
                    document.getElementById('audio-player-container').style.display = 'block';
                };
                gameState.isRecording = false;
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // --- 4. UI æ§åˆ¶ ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettingsBtn() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeSettings(e) { if(e.target.id === 'settings-modal') closeSettingsBtn(); }

        function saveSettings() {
            localStorage.setItem('rg_theme', document.getElementById('theme-select').value);
            localStorage.setItem('rg_rounds', document.getElementById('round-select').value);
            localStorage.setItem('rg_bpm', document.getElementById('bpm-input').value);
            localStorage.setItem('rg_offset', document.getElementById('offset-input').value);
            localStorage.setItem('rg_intro', document.getElementById('intro-seconds-input').value);
            localStorage.setItem('rg_interval', document.getElementById('interval-input').value);
            localStorage.setItem('rg_rate', document.getElementById('rate-input').value);
            localStorage.setItem('rg_record', document.getElementById('record-toggle').value);
            localStorage.setItem('rg_hint', document.getElementById('hint-mode').value);
            localStorage.setItem('rg_unique', document.getElementById('unique-count').value);
            
            document.getElementById('bpm-display').innerText = document.getElementById('bpm-input').value;
            document.getElementById('interval-display').innerText = document.getElementById('interval-input').value;
            document.getElementById('rate-display').innerText = document.getElementById('rate-input').value;
        }

        function loadSettings() {
            const s = localStorage;
            if(s.getItem('rg_rounds')) document.getElementById('round-select').value = s.getItem('rg_rounds');
            if(s.getItem('rg_bpm')) {
                document.getElementById('bpm-input').value = s.getItem('rg_bpm');
                document.getElementById('bpm-display').innerText = s.getItem('rg_bpm');
            }
            if(s.getItem('rg_offset')) document.getElementById('offset-input').value = s.getItem('rg_offset');
            if(s.getItem('rg_intro')) document.getElementById('intro-seconds-input').value = s.getItem('rg_intro');
            if(s.getItem('rg_interval')) {
                document.getElementById('interval-input').value = s.getItem('rg_interval');
                document.getElementById('interval-display').innerText = s.getItem('rg_interval');
            }
            if(s.getItem('rg_rate')) {
                document.getElementById('rate-input').value = s.getItem('rg_rate');
                document.getElementById('rate-display').innerText = s.getItem('rg_rate');
            }
            if(s.getItem('rg_record')) document.getElementById('record-toggle').value = s.getItem('rg_record');
            if(s.getItem('rg_hint')) document.getElementById('hint-mode').value = s.getItem('rg_hint');
            if(s.getItem('rg_unique')) document.getElementById('unique-count').value = s.getItem('rg_unique');
        }

        function updateThemeSelect() {
            const select = document.getElementById('theme-select');
            
            select.innerHTML = `
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
            `;

            const searchGroup = document.createElement('optgroup');
            searchGroup.label = "ğŸ” è‡ªè¨‚æœå°‹çµæœ";
            for (let theme in searchData) {
                const opt = document.createElement('option');
                opt.value = theme;
                // å„ªå…ˆé¡¯ç¤ºè‡ªè¨‚æ¨™é¡Œ
                opt.innerText = searchData[theme].title || `ğŸ” è‡ªè¨‚: ${searchData[theme].images[0].label}...`;
                searchGroup.appendChild(opt);
            }
            select.appendChild(searchGroup);

            if (Object.keys(customData).length > 0) {
                const group = document.createElement('optgroup');
                group.label = "ğŸ“‚ æœ¬åœ°è³‡æ–™å¤¾";
                for (let theme in customData) {
                    if (customData[theme].length > 0) {
                        const opt = document.createElement('option');
                        opt.value = "custom_" + theme;
                        opt.innerText = `ğŸ“ ${theme} (${customData[theme].length}å¼µ)`;
                        group.appendChild(opt);
                    }
                }
                select.appendChild(group);
            }

            select.innerHTML += `
                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="flags">ğŸ—ºï¸ åœ‹æ——æŒ‘æˆ°</option>
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>
                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
            `;
            
            const lastTheme = localStorage.getItem('rg_theme');
            if (lastTheme && select.querySelector(`option[value="${lastTheme}"]`)) {
                select.value = lastTheme;
            }
        }

        // --- èƒŒæ™¯è£åˆ‡èˆ‡è¨­å®šé‚è¼¯ ---
        let cropState = {
            startX: 0, startY: 0,
            isDragging: false,
            imgScale: 1, // åœ–ç‰‡é¡¯ç¤ºæ¯”ä¾‹
            rect: {} // æœ€çµ‚è£åˆ‡åº§æ¨™
        };

        // 1. é–‹å§‹ä¸Šå‚³èˆ‡é–‹å•Ÿè£åˆ‡å™¨
        function startCropper(input) {
            if (!input.files || !input.files[0]) return;
            
            cropTargetType = 'bg'; // â˜… åŠ å…¥é€™è¡Œï¼šæ¨™è¨˜ç¾åœ¨æ˜¯åˆ‡èƒŒæ™¯
            
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.getElementById('cropper-img');
                img.src = e.target.result;
                img.onload = () => {
                    document.getElementById('cropper-modal').style.display = 'flex';
                    // é‡ç½®è£åˆ‡æ¡†
                    document.getElementById('crop-box').style.display = 'none';
                    document.getElementById('bg-upload').value = ''; // æ¸…ç©º input è®“åŒæª”åå¯é‡è¤‡é¸
                };
            };
            reader.readAsDataURL(file);
        }

        function closeCropper() {
            document.getElementById('cropper-modal').style.display = 'none';
        }

        // --- 14. æ‰‹å‹•è§¸ç™¼è£åˆ‡ (æ–°æŒ‰éˆ•åŠŸèƒ½) ---
        function cropPreviewImage(index) {
            const slot = tempSearchItems[index];
            if (!slot || slot.images.length === 0) return;

            // å–å¾—ç›®å‰é¡¯ç¤ºçš„é‚£å¼µåœ–
            const currentImgUrl = slot.images[slot.currentIndex % slot.images.length];
            
            // å‘¼å«è£åˆ‡å•Ÿå‹•å™¨
            startCropperForWiki(currentImgUrl, index);
        }

        // --- ä¿®å¾©ç‰ˆï¼šè£åˆ‡å•Ÿå‹•å™¨ (å¼·åˆ¶ Proxy ä¸‹è¼‰æ¨¡å¼) ---
        async function startCropperForWiki(imgUrl, index) {
            const statusDiv = document.getElementById('search-status');
            statusDiv.innerText = "â³ æ­£åœ¨ä¸‹è¼‰åœ–ç‰‡...";
            
            try {
                let objectUrl = imgUrl;

                // â˜… å¼·åˆ¶ä¸‹è¼‰ï¼šåªè¦æ˜¯ç¶²è·¯ç¶²å€ï¼Œå…¨éƒ¨èµ° Proxy ä¸‹è¼‰æˆ Blob
                // é€™èƒ½è§£æ±º 99% çš„ã€Œæœ¬æ©Ÿé–‹å•Ÿç„¡æ³•è£åˆ‡ã€å•é¡Œ
                if (imgUrl.startsWith('http')) {
                    // åŠ ä¸€å€‹æ™‚é–“æˆ³è¨˜ t=... é˜²æ­¢å¿«å–å•é¡Œ
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(imgUrl)}&t=${Date.now()}`;
                    
                    const res = await fetch(proxyUrl);
                    if(!res.ok) throw new Error("Proxy download failed");
                    
                    const blob = await res.blob();
                    objectUrl = URL.createObjectURL(blob);
                }

                // è¨­å®šè£åˆ‡ç›®æ¨™
                cropTargetType = 'card';
                cropTargetIndex = index;

                // è¼‰å…¥åœ–ç‰‡åˆ°è£åˆ‡å™¨
                const img = document.getElementById('cropper-img');
                // æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½ï¼Œé˜²æ­¢å¹²æ“¾
                img.onload = null;
                img.onerror = null;
                
                img.src = objectUrl;
                
                img.onload = () => {
                    document.getElementById('cropper-modal').style.display = 'flex';
                    document.getElementById('crop-box').style.display = 'none';
                    cropState = { startX: 0, startY: 0, isDragging: false, rect: {} };
                    statusDiv.innerText = "âœ‚ï¸ è«‹æ‹–æ›³è£åˆ‡ç¯„åœ";
                };

                img.onerror = () => {
                    alert("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´ã€‚");
                    statusDiv.innerText = "";
                    // å¤±æ•—æ™‚ï¼Œç›´æ¥æŠŠåŸåœ–å­˜é€²å»ï¼Œä¸è£åˆ‡äº†
                    finishCardUpdate(imgUrl, index);
                };

            } catch(e) {
                console.error(e);
                alert("åœ–ç‰‡ä¸‹è¼‰å¤±æ•— (ä»£ç†ä¼ºæœå™¨å¿™ç¢Œä¸­)ï¼Œå°‡ç›´æ¥ä½¿ç”¨åŸåœ–ã€‚");
                statusDiv.innerText = "";
                finishCardUpdate(imgUrl, index);
            }
        }

        // 2. æ»‘é¼ /è§¸æ§ æ‹–æ›³é‚è¼¯
        function getPos(e) {
            // å–å¾—ç›¸å°æ–¼ container çš„åº§æ¨™
            const container = document.getElementById('cropper-container');
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function cropDragStart(e) {
            e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ²å‹•
            cropState.isDragging = true;
            const pos = getPos(e);
            cropState.startX = pos.x;
            cropState.startY = pos.y;
            
            const box = document.getElementById('crop-box');
            box.style.display = 'block';
            box.style.left = pos.x + 'px';
            box.style.top = pos.y + 'px';
            box.style.width = '0px';
            box.style.height = '0px';
        }

        function cropDragMove(e) {
            if (!cropState.isDragging) return;
            e.preventDefault();
            const pos = getPos(e);
            
            const currentX = pos.x;
            const currentY = pos.y;
            
            // è¨ˆç®—å¯¬é«˜èˆ‡å·¦ä¸Šè§’ä½ç½® (æ”¯æ´å¾€å›æ‹‰)
            const width = Math.abs(currentX - cropState.startX);
            const height = Math.abs(currentY - cropState.startY);
            const left = Math.min(currentX, cropState.startX);
            const top = Math.min(currentY, cropState.startY);

            const box = document.getElementById('crop-box');
            box.style.width = width + 'px';
            box.style.height = height + 'px';
            box.style.left = left + 'px';
            box.style.top = top + 'px';

            // ç´€éŒ„ç•¶å‰è£åˆ‡è³‡è¨Š
            cropState.rect = { left, top, width, height };
        }

        function cropDragEnd(e) {
            cropState.isDragging = false;
        }

        // --- ä¿®æ­£ç‰ˆï¼šç¢ºèªè£åˆ‡ (æ”¯æ´ èƒŒæ™¯/å¡ç‰‡ é›™æ¨¡å¼) ---
        async function confirmCrop() {
            const img = document.getElementById('cropper-img');
            const rect = cropState.rect;

            if (!rect.width || !rect.height) {
                alert("è«‹å…ˆæ‹–æ›³æ»‘é¼ æ¡†é¸ç¯„åœï¼");
                return;
            }

            // è¨ˆç®—æ¯”ä¾‹
            const scaleX = img.naturalWidth / img.offsetWidth;
            const scaleY = img.naturalHeight / img.offsetHeight;

            // å…§éƒ¨å‡½å¼ï¼šåŸ·è¡Œè£åˆ‡ä¸¦å›å‚³ Base64
            const doCrop = (maxSide, quality) => {
                const canvas = document.createElement('canvas');
                let targetW = rect.width * scaleX;
                let targetH = rect.height * scaleY;

                // ç¸®æ”¾é™åˆ¶ (é¿å…æª”æ¡ˆéå¤§)
                if (targetW > maxSide || targetH > maxSide) {
                    const ratio = Math.min(maxSide / targetW, maxSide / targetH);
                    targetW *= ratio;
                    targetH *= ratio;
                }

                canvas.width = targetW;
                canvas.height = targetH;
                const ctx = canvas.getContext('2d');

                ctx.drawImage(
                    img, 
                    rect.left * scaleX, rect.top * scaleY, 
                    rect.width * scaleX, rect.height * scaleY, 
                    0, 0, 
                    canvas.width, canvas.height
                );

                return canvas.toDataURL('image/jpeg', quality);
            };

            try {
                // 1. ç”¢ç”Ÿè£åˆ‡å¾Œçš„åœ–ç‰‡ (å¡ç‰‡ä¸ç”¨å¤ªå¤§ï¼Œ800pxå¤ äº†)
                const finalData = doCrop(1000, 0.8);

                // 2. åˆ¤æ–·è¦å­˜å»å“ªè£¡
                if (cropTargetType === 'bg') {
                    // --- å­˜èƒŒæ™¯ ---
                    try {
                        localStorage.removeItem('rg_bg_image');
                        localStorage.setItem('rg_bg_image', finalData);
                        applyBackground();
                        document.getElementById('search-status').innerText = "âœ… èƒŒæ™¯è¨­å®šå®Œæˆ";
                    } catch (e) {
                        alert("èƒŒæ™¯åœ–å¤ªå¤§å­˜ä¸ä¸‹ï¼Œè«‹è©¦è‘—åˆ‡å°ä¸€é»ã€‚");
                    }
                } else {
                    // --- å­˜å¡ç‰‡ ---
                    // å‘¼å«æ›´æ–°å‡½å¼ï¼ŒæŠŠé€™å¼µ Base64 åœ–å¡é€²å»
                    finishCardUpdate(finalData, cropTargetIndex);
                    document.getElementById('search-status').innerText = "âœ… åœ–ç‰‡è£åˆ‡å®Œæˆ";
                }

                closeCropper();

            } catch (e) {
                console.error(e);
                alert("è£åˆ‡ç™¼ç”ŸéŒ¯èª¤");
            }
        }

        // 4. æ‡‰ç”¨èˆ‡æ¸…é™¤èƒŒæ™¯
        function applyBackground() {
            const bgData = localStorage.getItem('rg_bg_image');
            if (bgData) {
                document.body.style.backgroundImage = `url('${bgData}')`;
                document.body.classList.add('has-custom-bg');
            } else {
                document.body.style.backgroundImage = '';
                document.body.classList.remove('has-custom-bg');
            }
        }

        function clearBackground() {
            if(confirm("ç¢ºå®šè¦ç§»é™¤è‡ªè¨‚èƒŒæ™¯å—ï¼Ÿ")) {
                localStorage.removeItem('rg_bg_image');
                applyBackground();
            }
        }

        window.addEventListener('load', async () => {
            loadSearchData(); // â˜… åŠ å…¥é€™è¡Œï¼šè®€å–è‡ªè¨‚ä¸»é¡Œ
            loadSettings();
            applyBackground();
            updateThemeSelect();
        });

        // --- 5. éŠæˆ²æ ¸å¿ƒ ---
        class SmartTimer {
            constructor(callback, delay) {
                this.remaining = delay; this.callback = callback;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), delay);
            }
            pause() {
                window.clearTimeout(this.timerId); this.timerId = null;
                this.remaining -= Date.now() - this.start;
            }
            resume() {
                if (this.timerId) return;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), this.remaining);
            }
            finish() { this.callback(); }
        }

        function wait(ms) {
            if (ms <= 0) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const timer = new SmartTimer(resolve, ms);
                if (!window.currentTimers) window.currentTimers = [];
                window.currentTimers.push(timer);
                if (gameState.abortController.signal.aborted) reject(new Error("Aborted"));
                gameState.abortController.signal.addEventListener('abort', () => {
                    window.clearTimeout(timer.timerId); reject(new Error("Aborted"));
                });
            });
        }

        // --- æ•¸æ“šæ± åˆå§‹åŒ–å‡½å¼ (è‡ªå‹•è£œæ»¿ & é‡è¤‡è™•ç†) ---
        function initActivePool(theme) {
            let pool = [];
            
            if (theme === 'flags') {
                pool = flagsData.map(f => ({ content: `https://flagcdn.com/w640/${f.c}.png`, label: f.n, theme: 'flags' }));
            } else if (theme.startsWith('search_')) {
                // ä½¿ç”¨æœå°‹çµæœ (å·²ç¶“æ˜¯å›ºå®šå¥½çš„åœ–ç‰‡)
                // searchData ç¾åœ¨çš„çµæ§‹æ˜¯ { images: [], title: "" }
                pool = searchData[theme].images.map(item => ({ content: item.url, label: item.label, theme: 'search' }));
            } else if (theme.startsWith('custom_')) {
                const real = theme.replace('custom_', '');
                if (customData[real]) pool = customData[real].map(i => ({ content: i.url, label: i.label, theme: 'custom' }));
            } else if (theme === 'pokemon') {
                for(let i=0; i<30; i++) {
                    const id = Math.floor(Math.random() * 151) + 1;
                    pool.push({ content: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`, label: 'Pokemon', theme: 'pokemon' });
                }
            } else if (theme === 'robots') {
                for(let i=0; i<30; i++) {
                    const txt = Math.random().toString(36).substring(7);
                    pool.push({ content: `https://robohash.org/${txt}?set=set1`, label: 'Robot', theme: 'robots' });
                }
            } else if (theme === 'food') {
                pool = commonData.food.map(f => ({ content: f.u, label: f.n, theme: 'food' }));
            } else if (theme === 'colors') {
                pool = commonData.colors.map(c => ({ content: c.c, label: c.n, theme: 'colors' }));
            } else if (theme === 'chinese_phonetic') {
                const keys = Object.keys(chineseGroups);
                const k = keys[Math.floor(Math.random() * keys.length)];
                pool = chineseGroups[k].map(word => ({ content: word, label: word, theme: 'chinese_phonetic' }));
            } else if (commonData[theme]) {
                pool = commonData[theme].map(item => ({ content: item, label: item, theme: theme }));
            } else {
                pool = commonData.animals.map(item => ({ content: item, label: 'Animal', theme: 'animals' }));
            }

            // é˜²å‘†è£œæ»¿
            if (pool.length > 0 && pool.length < 8) {
                while (pool.length < 8) {
                    pool = pool.concat(pool);
                }
            }

            // è™•ç†ã€Œé‡è¤‡å‡ºé¡Œæ•¸ã€
            const uCount = parseInt(gameState.uniqueCount) || 8;
            const uniqueItems = pool.sort(() => 0.5 - Math.random()).slice(0, uCount);
            
            let final8 = [];
            while(final8.length < 8) {
                final8 = final8.concat(uniqueItems);
            }
            return final8.slice(0, 8);
        }

        async function startGame() {
            gameState.maxRounds = parseInt(document.getElementById('round-select').value);
            gameState.selectedTheme = document.getElementById('theme-select').value;
            gameState.bpm = parseInt(document.getElementById('bpm-input').value);
            gameState.offset = parseFloat(document.getElementById('offset-input').value);
            gameState.interval = parseFloat(document.getElementById('interval-input').value);
            gameState.introSeconds = parseFloat(document.getElementById('intro-seconds-input').value) || 0;
            gameState.playbackRate = parseFloat(document.getElementById('rate-input').value) || 1.0;
            gameState.hintMode = document.getElementById('hint-mode').value;
            gameState.uniqueCount = parseInt(document.getElementById('unique-count').value);
            
            gameState.round = 0;
            gameState.abortController = new AbortController();
            gameState.history = []; 
            window.currentTimers = [];

            let finalTheme = gameState.selectedTheme;
            if (finalTheme === 'random_locked') {
                const allT = getAllThemes().filter(t => !t.startsWith('random'));
                finalTheme = allT[Math.floor(Math.random() * allT.length)];
            }
            
            if (finalTheme !== 'random_mixed' && finalTheme !== 'random_round') {
                gameState.activePool = initActivePool(finalTheme);
            }
            gameState.currentRunTheme = finalTheme;

            // ç¢ºä¿éœéŸ³ç‹€æ…‹
            bgmAudio.muted = gameState.isMuted;

            if (bgmAudio.src) {
                try {
                    bgmAudio.volume = 0; 
                    await bgmAudio.play();
                    bgmAudio.pause();
                    bgmAudio.currentTime = 0;
                    if (!gameState.isMuted) bgmAudio.volume = 1; 
                } catch (e) { console.log("Unlock failed"); }
            }

            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('audio-player-container').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('total-rounds').innerText = gameState.maxRounds;

            startRecording();
            runGameLoop();
        }

        function getAllThemes() {
            let t = ['flags', 'pokemon', 'robots', 'food', 'math', 'chinese_phonetic', 'animals', 'numbers', 'colors'];
            for (let k in customData) t.push('custom_' + k);
            for (let k in searchData) t.push(k);
            return t;
        }

        function getMixedItems() {
            const allT = getAllThemes();
            let items = [];
            for(let i=0; i<8; i++) {
                const t = allT[Math.floor(Math.random() * allT.length)];
                const pool = initActivePool(t);
                items.push(pool[0]);
            }
            return items;
        }

        async function runGameLoop() {
            try {
                bgmAudio.playbackRate = gameState.playbackRate;

                while (gameState.round < gameState.maxRounds) {
                    gameState.round++;
                    document.getElementById('current-round').innerText = gameState.round;
                    
                    if (bgmAudio.src) {
                        if (gameState.offset < 0) {
                            bgmAudio.currentTime = 0;
                            await wait(Math.abs(gameState.offset) * 1000);
                            bgmAudio.play().catch(e=>console.log(e));
                        } else {
                            bgmAudio.currentTime = gameState.offset;
                            bgmAudio.play().catch(e=>console.log(e));
                        }
                    }

                    const grid = document.getElementById('grid-container');
                    grid.innerHTML = '';
                    let items = [];

                    if (gameState.currentRunTheme === 'random_mixed') {
                        items = getMixedItems();
                    } else if (gameState.currentRunTheme === 'random_round') {
                        const allT = getAllThemes();
                        const t = allT[Math.floor(Math.random() * allT.length)];
                        items = initActivePool(t);
                    } else {
                        items = [...gameState.activePool].sort(() => 0.5 - Math.random());
                    }
                    
                    gameState.history.push({ round: gameState.round, items: items });

                    let showHint = false;
                    if (gameState.hintMode === 'always') showHint = true;
                    if (gameState.hintMode === 'first' && gameState.round === 1) showHint = true;

                    items.forEach(obj => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        if (showHint) card.classList.add('show-hint');

                        const content = document.createElement('div');
                        content.className = 'card-content';

                        const isUrl = typeof obj.content === 'string' && (obj.content.startsWith('http') || obj.content.startsWith('blob:'));
                        
                        if (isUrl) {
                            card.classList.add('contain-img');
                            content.innerHTML = `<img src="${obj.content}" onerror="this.src='https://placehold.co/200x200?text=Error'">`;
                        } else if (obj.theme === 'colors') {
                            card.classList.add('color-card');
                            card.style.backgroundColor = obj.content;
                            if(obj.content === '#ffffff') card.style.borderColor = '#ddd';
                        } else {
                            content.innerText = obj.content;
                            if(obj.theme === 'numbers') card.classList.add('number-mode');
                            if(obj.theme === 'math') card.classList.add('math-mode');
                            if(obj.theme === 'chinese_phonetic') card.classList.add('chinese-mode');
                        }
                        
                        const label = document.createElement('div');
                        label.className = 'answer-label';
                        label.innerText = obj.label;

                        card.appendChild(content);
                        card.appendChild(label);
                        grid.appendChild(card);
                    });

                    if (gameState.introSeconds > 0) await wait(gameState.introSeconds * 1000);

                    const msPerBeat = (60000 / gameState.bpm) / gameState.playbackRate;
                    const cards = document.querySelectorAll('.card');
                    for (let i = 0; i < 8; i++) {
                        if (i>0) cards[i-1].classList.remove('active');
                        cards[i].classList.add('active');
                        await wait(msPerBeat);
                    }
                    if(cards.length>0) cards[7].classList.remove('active');

                    if (bgmAudio.src) bgmAudio.pause();
                    if (gameState.round < gameState.maxRounds) await wait(gameState.interval * 1000);
                }
                showEndScreen();
            } catch (error) {
                if (error.message !== "Aborted") console.error(error);
            }
        }

        function showEndScreen() {
            stopRecording();
            bgmAudio.pause();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('home-screen').classList.add('hidden');

            const historyDiv = document.getElementById('game-history');
            historyDiv.innerHTML = '';
            
            gameState.history.forEach(h => {
                const roundBlock = document.createElement('div');
                roundBlock.className = 'history-round';
                
                const title = document.createElement('div');
                title.className = 'history-title';
                title.innerText = `Round ${h.round}`;
                roundBlock.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'history-grid';

                h.items.forEach(item => {
                    const cell = document.createElement('div');
                    cell.className = 'history-item';
                    
                    let visual = '';
                    if (item.theme === 'colors') {
                        visual = `<div class="history-thumb" style="background:${item.content};"></div>`;
                    } else if (item.content.startsWith && (item.content.startsWith('http') || item.content.startsWith('blob:'))) {
                        visual = `<img class="history-thumb" src="${item.content}">`;
                    } else {
                        visual = `<div class="history-thumb">${item.content}</div>`;
                    }
                    
                    cell.innerHTML = `${visual}<div class="history-name">${item.label}</div>`;
                    grid.appendChild(cell);
                });

                roundBlock.appendChild(grid);
                historyDiv.appendChild(roundBlock);
            });
        }

        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const overlay = document.getElementById('pause-overlay');
            const btn = document.getElementById('pause-btn');
            if (gameState.isPaused) {
                overlay.style.display = 'flex'; btn.innerText = 'â–¶ï¸';
                bgmAudio.pause(); 
                if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.pause();
                window.currentTimers.forEach(t => t.pause());
            } else {
                overlay.style.display = 'none'; btn.innerText = 'â¸';
                bgmAudio.play(); 
                if(mediaRecorder && mediaRecorder.state === 'paused') mediaRecorder.resume();
                window.currentTimers.forEach(t => t.resume());
            }
        }

        function resetLogic() {
            if (gameState.abortController) gameState.abortController.abort();
            bgmAudio.pause(); gameState.isPaused = false;
            stopRecording();
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('pause-btn').innerText = 'â¸';
        }

        function restartGame() { resetLogic(); setTimeout(startGame, 100); }
        function goHome() {
            resetLogic();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('home-screen').style.display = 'flex';
        }
    </script>
</body>
</html>
