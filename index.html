<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯€å¥éŠæˆ²</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #ff4757;
            --secondary-color: #2ed573;
            --accent-color: #54a0ff;
            --bg-color: #f1f2f6;
            --box-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- èƒŒæ™¯æ¨£å¼ --- */
        body.has-custom-bg {
            background-repeat: no-repeat; background-position: center;
            background-size: cover; background-attachment: fixed;
        }
        /* 1. é¦–é  (Home) ä¿æŒæœ‰ç™½æ¡†ï¼Œæ¯”è¼ƒå¥½çœ‹ */
        body.has-custom-bg #home-screen {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px; border-radius: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        /* 2. â˜… ä¿®æ”¹ï¼šéŠæˆ²ç•«é¢ (Game) å»æ‰ç™½æ¡† */
        body.has-custom-bg #game-screen {
            background: none;        /* èƒŒæ™¯é€æ˜ */
            box-shadow: none;        /* å»æ‰é™°å½± */
            padding: 0;              /* å»æ‰å…§è· */
            border: none;            /* å»æ‰é‚Šæ¡† */
        }

        /* --- æŒ‰éˆ•èˆ‡é€šç”¨å…ƒä»¶ --- */
        h1 { font-size: 2.5rem; color: #333; margin-bottom: 5px; }
        
        .icon-btn {
            background: white; border: 2px solid #ddd; width: 50px; height: 50px;
            border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }

        .btn-primary {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 30px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); transition: 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-action {
            background-color: var(--accent-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: auto; flex-shrink: 0;
        }

        .btn-test {
            background-color: #a4b0be; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; font-size: 0.9rem; cursor: pointer;
        }

        .btn-small { 
            padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; color: white; margin-left: 5px; 
        }
        .btn-dl { background: #27ae60; }
        .btn-dl-media { background: #e67e22; }
        .btn-del-cloud { background: #c0392b; }

        /* --- ä¸»ç•«é¢ --- */
        #home-screen {
            text-align: center; position: relative; width: 100%; max-width: 500px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        #settings-trigger { position: absolute; top: -80px; right: 20px; }
        #mute-home { position: absolute; top: -80px; left: 20px; }
        
        .theme-selector {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 80%;
        }
        select {
            padding: 10px; font-size: 1.2rem; border-radius: 8px;
            border: 1px solid #ccc; width: 100%; margin-top: 5px;
        }

        /* --- è¨­å®šå½ˆçª— (ä¸‰å¤§æ¬„ä½æ¨£å¼) --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            position: relative; animation: popUp 0.3s ease;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }

        /* åˆ†å€æ¨™é¡Œæ¨£å¼ */
        .section-title {
            font-size: 1.1rem; font-weight: bold; margin-top: 20px; margin-bottom: 10px;
            padding: 8px 12px; border-radius: 8px; color: white;
            display: flex; align-items: center; justify-content: space-between;
        }
        
        /* å€å¡Šå®¹å™¨ */
        .section-box {
            border: 1px solid #eee; padding: 15px; border-radius: 10px; background: #fff;
            margin-bottom: 15px;
        }

        .control-row { margin-bottom: 10px; }
        .control-row label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        
        /* æŠ˜ç–Šé¸å–® */
        details.music-settings {
            background: #fff0f6; border: 1px solid #ffadd2; border-radius: 10px; padding: 10px;
        }
        details.music-settings summary {
            cursor: pointer; font-weight: bold; color: #d63031; outline: none; list-style: none;
        }
        details.music-settings summary::-webkit-details-marker { display: none; }
        details.music-settings summary::after { content: "+"; font-size: 1.2em; }
        details.music-settings[open] summary::after { content: "-"; }
        .sub-control { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffadd2; }

        input[type="range"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; }
        
        /* --- é è¦½èˆ‡ç·¨è¼¯å€ --- */
        #preview-area {
            display: none; margin-top: 10px; background: #fdfdfd; border: 2px dashed #ddd; 
            padding: 10px; border-radius: 12px;
        }
        #preview-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px; }
        .preview-item { 
            position: relative; border: 1px solid #ddd; border-radius: 8px; 
            overflow: hidden; background: #fff; display: flex; flex-direction: column;
        }
        .preview-toolbar {
            display: flex; justify-content: flex-end; gap: 4px; padding: 4px;
            background: #f8f9fa; border-bottom: 1px solid #eee;
        }
        .btn-mini {
            color: white; border: none; border-radius: 4px; width: 28px; height: 28px;
            font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .preview-img { width: 100%; height: 140px; object-fit: contain; background: #fff; }
        .preview-edit { display: flex; border-top: 1px solid #eee; }
        .preview-input { flex: 1; border: none; padding: 5px; text-align: center; font-weight: bold; }
        .preview-btn-search { width: 30px; background: #eee; border:none; border-left:1px solid #ccc; cursor:pointer; }
        .preview-btn-search:hover { background: #ddd; }

        /* æ–‡å­—å¡ç”¢ç”Ÿå™¨ */
        .text-card-creator {
            display: flex; gap: 5px; background: #fff3cd; padding: 8px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 10px; align-items: center;
        }

        /* è£åˆ‡è¦–çª— */
        #cropper-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #cropper-container {
            position: relative; max-width: 90%; max-height: 80%;
            border: 2px solid #555; overflow: hidden; touch-action: none;
        }
        #crop-box {
            position: absolute; border: 2px dashed #fff;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            display: none; pointer-events: none;
        }

        /* --- éŠæˆ²ç•«é¢ --- */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; max-width: 800px; position: relative;
        }
        .top-bar {
            position: absolute; top: -80px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        #info-bar {
            font-size: 2.5rem;       /* å­—ç¨å¾®åŠ å¤§ä¸€é» */
            margin-bottom: 20px; 
            font-weight: 900; 
            color: #333;             /* å­—é«”ä¸»è‰² */
            
            /* â˜… ä¿®æ”¹ï¼šå»æ‰ç™½è‰²èƒŒæ™¯æ¡†èˆ‡é™°å½± */
            background: none; 
            box-shadow: none;
            padding: 0;
            border-radius: 0;
            
            /* â˜… æ–°å¢ï¼šå¼·åŠ›ç™½è‰²æé‚Š (è®“å­—åœ¨ä»»ä½•èƒŒæ™¯ä¸Šéƒ½æ¸…æ™°å¯è¦‹) */
            text-shadow: 
                3px 3px 0 #fff, 
                -3px -3px 0 #fff, 
                3px -3px 0 #fff, 
                -3px 3px 0 #fff,
                3px 0 0 #fff,
                -3px 0 0 #fff,
                0 3px 0 #fff,
                0 -3px 0 #fff;
        }
        /* 1. ä¿®æ”¹ç¶²æ ¼å®¹å™¨ (ç§»é™¤å¼·åˆ¶ 2:1 æ¯”ä¾‹ï¼Œè®“å®ƒè·Ÿéš¨å¡ç‰‡å¤§å°) */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            /* grid-template-rows: repeat(2, 1fr);  <-- é€™è¡Œå¯ä»¥æ‹¿æ‰ï¼Œè®“å®ƒè‡ªå‹•é•·é«˜ */
            gap: 15px; 
            width: 95%;
            /* aspect-ratio: 2/1; <-- â˜… åˆªé™¤é€™è¡Œï¼šä¸è¦å¼·åˆ¶é•·å¯¬æ¯”ï¼Œè®“å¡ç‰‡è‡ªå·±æ’é–‹ */
            margin: 0 auto; /* ç½®ä¸­ */
        }

        /* 2. ä¿®æ”¹å¡ç‰‡ (å¼·åˆ¶æ­£æ–¹å½¢) */
        .card {
            background-color: var(--box-bg); 
            border-radius: 12px; 
            display: flex;
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            border: 5px solid #eee;
            overflow: hidden; 
            position: relative;
            
            /* â˜… æ–°å¢ï¼šå¼·åˆ¶è®Šæˆæ­£æ–¹å½¢ */
            aspect-ratio: 1 / 1;
        }

        /* 3. ä¿®æ”¹åœ–ç‰‡ (ç­‰æ¯”ä¾‹ç¸®å…¥ï¼Œä¸è£åˆ‡) */
        .card img { 
            width: 100%; 
            height: 100%; 
            
            /* â˜… é—œéµï¼šcontain = åŒ…å« (å®Œæ•´é¡¯ç¤ºåœ–ç‰‡ï¼Œç•™ç™½é‚Šï¼Œä¸è®Šå½¢) */
            object-fit: contain; 
            
            /* é¸é …ï¼šåŠ ä¸€é»å…§è·ï¼Œè®“åœ–ä¸è¦è²¼æ­»é‚Šæ¡†ï¼Œæ¯”è¼ƒå¥½çœ‹ */
            padding: 5px; 
            box-sizing: border-box;
            background: white; /* åœ–ç‰‡èƒŒæ™¯è¨­ç‚ºç™½è‰²ï¼Œé€™æ¨£ç•™ç™½çš„åœ°æ–¹æœƒæ˜¯ç™½çš„ */
        }

        /* 4. é€™ä¸€è¡ŒèˆŠçš„å¯ä»¥åˆªæ‰æˆ–ä¿ç•™ï¼Œå› ç‚ºä¸Šé¢å·²ç¶“çµ±ä¸€è¨­å®šäº† */
        /* .card.contain-img img { object-fit: contain; width: 90%; height: 90%; } */
        .card.active {
            border-color: var(--primary-color) !important; transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.8); z-index: 5; background-color: #ffeaa7;
        }
        .answer-label {
            display: none; width: 100%; background: rgba(0,0,0,0.7); color: white;
            font-size: 1.2rem; padding: 5px 0; text-align: center;
            position: absolute; bottom: 0; left: 0; font-weight: bold;
        }
        .card.show-hint .answer-label { display: block; }

        /* --- çµæŸç•«é¢ --- */
        #end-screen {
            display: none; flex-direction: column; align-items: center; gap: 20px;
            background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .history-item {
            display: flex; flex-direction: column; align-items: center; 
            border: 1px solid #eee; border-radius: 5px; padding: 5px; background: white;
        }
        .history-thumb { 
            width: 100%; aspect-ratio: 1; object-fit: contain; display:flex; 
            align-items:center; justify-content:center; font-size:1.5rem;
        }
        .history-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }

        /* --- é›²ç«¯åˆ—è¡¨ --- */
        .cloud-list { max-height: 150px; overflow-y: auto; background: white; border: 1px solid #ccc; margin-top: 5px; border-radius: 5px; }
        .cloud-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }

        /* --- â˜… æ–°å¢ï¼šæŠ˜ç–Šé¸å–®æ¨£å¼ --- */
        details.main-section {
            margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 12px; overflow: hidden;
            background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        details.main-section summary {
            padding: 15px; font-size: 1.1rem; font-weight: bold; color: white;
            cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;
        }
        details.main-section summary::-webkit-details-marker { display: none; }
        details.main-section summary::after { content: '+'; font-size: 1.5rem; font-weight: bold; }
        details.main-section[open] summary::after { content: '-'; }

        .section-content { padding: 15px; background: #fff; border-top: 1px solid #eee; }

        /* ä¸åŒé¡è‰²çš„é…è‰² */
        .style-theme summary { background: #dd9a1e; }
        .style-music summary { background: #129e51; }
        .style-cloud summary { background: #2196f3; }
        .style-cloud .section-content { background: #e3f2fd; }

    </style>
</head>
<body>

    <div id="home-screen">
        <button id="mute-home" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
        <button id="settings-trigger" class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
        
        <h1>ğŸµ ç¯€å¥éŠæˆ² <span style="font-size:1rem; color:#888;">V10</span></h1>
        <p style="color: #888; font-size: 1rem; margin-top: -10px; font-weight: bold;">
            Created by weic58 and Google Gemini
        </p>
        
        <div class="theme-selector">
            <label style="font-weight:bold; color:#555;">é¸æ“‡ä¸»é¡Œ</label>
            <select id="theme-select" onchange="saveSettings()">
                </select>
        </div>

        <div class="theme-selector" style="margin-top:10px;">
            <label style="font-weight:bold; color:#555;">ç¸½å›åˆæ•¸</label>
            <select id="round-select" onchange="saveSettings()">
                <option value="3">3 å›åˆ</option>
                <option value="5">5 å›åˆ</option>
                <option value="10">10 å›åˆ</option>
                <option value="999">ç„¡é™ç·´ç¿’</option>
            </select>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:200px;" onclick="startGame()">START</button>
    </div>

    <div id="settings-modal" onclick="closeSettings(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
                <button class="close-btn" onclick="closeSettingsBtn()">âœ•</button>
            </div>

            <details class="main-section style-theme">
                <summary>ğŸ¨ è‡ªè¨‚ä¸»é¡Œèˆ‡å¡ç‰‡</summary>
                <div class="section-content">
                    <div style="margin-bottom:8px; display:flex; gap:5px;">
                        <select id="search-source" style="width: 35%; font-size: 0.9rem; padding: 5px;">
                            <option value="wiki">ğŸ“– ç™¾ç§‘æ¢ç›®</option>
                            <option value="commons">ğŸŒ å»£æ³›åœ–åº«</option>
                        </select>
                        <input type="text" id="custom-theme-title" style="width: 65%;" placeholder="ä¸»é¡Œåç¨± (ä¾‹å¦‚: æˆ‘çš„å–®å­—å¡)">
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom: 8px;">
                        <input type="text" id="search-input" style="flex:1;" placeholder="è¼¸å…¥é—œéµå­— (ä¾‹: æ­Œæ‰‹, å¯¶å¯å¤¢, å°è±¡æ´¾)">
                        
                        <button class="btn-action" onclick="searchImages(1)" style="min-width: 60px;">ğŸ” æœå°‹(1å¼µ)</button>
                        
                        <button class="btn-action" onclick="searchImages(5)" style="min-width: 80px; background:#a55eea;">ğŸ¨ ä¸»é¡Œ(5å¼µ)</button>
                    </div>

                    <div style="display:flex; gap:5px;">
                        <button class="btn-action" style="background:#2ecc71; flex:1;" onclick="startNewTheme()">â• æ–°å¢ä¸»é¡Œ</button>
                        <button class="btn-action" style="background:#48dbfb; flex:1;" onclick="editCurrentTheme()">âœï¸ ç·¨è¼¯ç›®å‰</button>
                        <button class="btn-action" style="background:#ff7675; flex:1;" onclick="deleteCustomTheme()">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>

                    <div style="margin-top: 10px; border-top:1px dashed #ccc; padding-top:10px;">
                        <input type="file" id="folder-input" webkitdirectory directory multiple style="display:none" onchange="handleFolderImport(this)">
                        <button class="btn-action" style="background:#e67e22; width:100%;" onclick="document.getElementById('folder-input').click()">ğŸ“ åŒ¯å…¥æœ¬æ©Ÿè³‡æ–™å¤¾ (è‡ªå‹•è½‰åœ–æª”)</button>
                        <div id="folder-import-status" style="font-size:0.8rem; color:#666; margin-top:5px; text-align:center;"></div>
                    </div>

                    <div id="preview-area">
                        <div style="font-weight:bold; color:#555; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ› ï¸ å¡ç‰‡ç·¨è¼¯å€</div>
                        
                        <div class="text-card-creator">
                            <span style="font-size:0.9rem; font-weight:bold;">ğŸ”¤ æ–‡å­—å¡:</span>
                            <input type="color" id="text-card-color" value="#ffffff" style="width:30px; height:30px; padding:0; border:none; cursor:pointer;" title="èƒŒæ™¯é¡è‰²">
                            <input type="text" id="text-card-content" placeholder="è¼¸å…¥æ–‡å­—..." style="flex:1;">
                            <button class="btn-small" style="background:#6c5ce7;" onclick="addTextSlot()">â• åŠ å…¥</button>
                        </div>

                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span id="search-status" style="font-size:0.8rem; color:#666;"></span>
                            <div>
                                <button class="btn-test" onclick="addPreviewSlot()">â• ç©ºç™½æ ¼</button>
                                <button class="btn-test" style="background:#ff6b6b; color:white;" onclick="clearPreviewSlots()">ğŸ—‘ï¸ æ¸…ç©º</button>
                            </div>
                        </div>

                        <div id="preview-grid"></div>
                        
                        <button class="btn-action" style="background:#2ed573; width:100%; font-size:1.1rem; padding:10px;" onclick="confirmSearchTheme()">âœ… ç¢ºèªä¸¦å„²å­˜ä¸»é¡Œ</button>
                    </div>
                </div>
            </details>


            <details class="main-section style-music">
                <summary>âš™ï¸ èƒŒæ™¯èˆ‡éŠæˆ²è¨­å®š</summary>
                <div class="section-content">
                
                    <div class="control-row">
                        <label>ğŸ–¼ï¸ éŠæˆ²èƒŒæ™¯åœ–</label>
                        <input type="file" id="bg-upload" accept="image/*" onchange="startCropper(this)">
                        <div style="margin-top:5px;">
                            <button class="btn-small" style="background:#ff7675;" onclick="clearBackground()">ğŸ—‘ï¸ æ¸…é™¤èƒŒæ™¯</button>
                        </div>
                    </div>

                    <div class="control-row">
                        <label>ğŸµ èƒŒæ™¯éŸ³æ¨‚</label>
                        <input type="file" id="music-file" accept="audio/*">
                        <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                            <span id="file-status" style="font-size:0.8rem; color:#2ed573;">æœªé¸æ“‡</span>
                            <button class="btn-test" onclick="testAudio()">ğŸ”Š è©¦è½</button>
                        </div>
                    </div>

                    <details class="music-settings">
                        <summary>ğŸ›ï¸ é€²éšéŸ³æ¨‚åƒæ•¸ (BPM/é€Ÿåº¦/é–“éš”)</summary>
                        <div class="sub-control">
                            <label>ğŸ¢â© å€é€Ÿ: <span id="rate-display" style="color:#d63031;">1.0</span>x</label>
                            <input type="range" id="rate-input" min="0.5" max="2.0" step="0.1" value="1.0" oninput="saveSettings()">
                        </div>
                        <div class="sub-control">
                            <label>â±ï¸ BPM: <span id="bpm-display" style="color:var(--primary-color);">165</span></label>
                            <input type="range" id="bpm-input" min="60" max="180" value="165" oninput="saveSettings()">
                        </div>
                        <div class="sub-control">
                            <label>â¯ï¸ èµ·é» (ç§’):</label>
                            <input type="number" id="offset-input" value="0" step="0.1" oninput="saveSettings()">
                        </div>
                        <div class="sub-control">
                            <label>â³ éŸ³æ¨‚å¾Œç­‰å¾… (ç§’):</label>
                            <input type="number" id="intro-seconds-input" value="2.5" step="0.1" oninput="saveSettings()">
                        </div>
                        <div class="sub-control">
                            <label>ğŸ›Œ å›åˆé–“éš” (ç§’): <span id="interval-display">0</span>s</label>
                            <input type="range" id="interval-input" min="0" max="5" value="0" step="0.5" oninput="saveSettings()">
                        </div>
                    </details>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="control-row">
                            <label>ğŸ’¡ æç¤ºæ¨¡å¼</label>
                            <select id="hint-mode" onchange="saveSettings()">
                                <option value="first">åƒ…ç¬¬ä¸€å›åˆ</option>
                                <option value="always">æ¯å›åˆé¡¯ç¤º</option>
                                <option value="none">éš±è— (è€ƒè©¦)</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>ğŸ™ï¸ éŠæˆ²éŒ„éŸ³</label>
                            <select id="record-toggle" onchange="saveSettings()">
                                <option value="off">é—œé–‰</option>
                                <option value="on">é–‹å•Ÿ</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <label>ğŸ”‚ å¡ç‰‡é‡è¤‡åº¦ (æ¯å›åˆ8å¼µ)</label>
                        <select id="unique-count" onchange="saveSettings()">
                            <option value="8">8 å¼µéƒ½ä¸ä¸€æ¨£</option>
                            <option value="4">4 ç¨®åœ– (å„å‡ºç¾2æ¬¡)</option>
                            <option value="2">2 ç¨®åœ– (å„å‡ºç¾4æ¬¡)</option>
                            <option value="1">1 ç¨®åœ– (å…¨éƒ¨ç›¸åŒ)</option>
                        </select>
                    </div>
                </div>
            </details>


            <details class="main-section style-cloud">
                <summary>â˜ï¸ é›²ç«¯è³‡æ–™åº«</summary>
                <div class="section-content">
                
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight:bold; color:#1565c0;">é€£ç·šç‹€æ…‹ï¼š</span>
                        <span id="firebase-status" style="font-weight:bold; color:red;">â³ é€£ç·šä¸­...</span>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #bbdefb;">
                        <label style="color:#1976d2; border-bottom:1px solid #eee; margin-bottom:5px; font-size:0.9rem; display:block; font-weight:bold;">ğŸ´ ä¸»é¡Œå¡ç‰‡ (ä¸å«éŸ³æ¨‚)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="upload-select" style="flex:1;"><option value="">-- è«‹é¸æ“‡ --</option></select>
                            <button class="btn-action" style="background:#2196f3;" onclick="uploadThemeOnly()">â¬†ï¸ ä¸Šå‚³</button>
                        </div>
                        
                        <button class="btn-action" style="background:#64b5f6; width:100%; font-size:0.8rem;" onclick="fetchCloudThemes()">ğŸ”„ æ•´ç†é›²ç«¯åˆ—è¡¨</button>
                        <div id="cloud-list-container" class="cloud-list"><div style="text-align:center; padding:10px; color:#999;">é»æ“Šæ•´ç†æŒ‰éˆ•</div></div>
                    </div>

                    <div style="background:white; padding:10px; border-radius:8px; border:1px solid #ffe0b2;">
                        <label style="color:#ef6c00; border-bottom:1px solid #eee; margin-bottom:5px; font-size:0.9rem; display:block; font-weight:bold;">ğŸµ åª’é«”åŒ… (èƒŒæ™¯åœ–+éŸ³æ¨‚)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <input type="text" id="media-pack-name" placeholder="è¼¸å…¥åç¨±..." style="flex:1;">
                            <button class="btn-action" style="background:#ff9800;" onclick="uploadMediaOnly()">â¬†ï¸ ä¸Šå‚³</button>
                        </div>
                        <button class="btn-action" style="background:#ffb74d; width:100%; font-size:0.8rem;" onclick="fetchCloudMedia()">ğŸ”„ æ•´ç†åª’é«”åˆ—è¡¨</button>
                        <div id="cloud-media-list" class="cloud-list"><div style="text-align:center; padding:10px; color:#999;">é»æ“Šæ•´ç†æŒ‰éˆ•</div></div>
                    </div>
                </div>
            </details>

            <button class="btn-primary" style="width:100%; font-size:1rem; margin-top:10px;" onclick="closeSettingsBtn()">å®Œæˆè¨­å®š</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goHome()" title="å›é¦–é ">ğŸ </button>
            <div style="display:flex; gap:10px;">
                <button id="mute-game" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
                <button class="icon-btn" id="pause-btn" onclick="togglePause()" title="æš«åœ">â¸</button>
                <button class="icon-btn" onclick="restartGame()" title="é‡ç½®">ğŸ”„</button>
            </div>
        </div>
        <div id="info-bar">Round <span id="current-round">1</span> / <span id="total-rounds">3</span></div>
        <div id="grid-container"></div>
    </div>

    <div id="pause-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:50; display:none; align-items:center; justify-content:center; flex-direction:column; backdrop-filter:blur(5px);">
        <h2 style="color:white; font-size:4rem; margin-bottom:20px;">PAUSED</h2>
        <button class="btn-primary" style="width:200px;" onclick="togglePause()">ç¹¼çºŒ</button>
    </div>

    <div id="end-screen">
        <h1>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h1>
        <div id="audio-player-container" style="width:100%; display:none; text-align:center; background:#f5f5f5; padding:10px; border-radius:10px;">
            <h3>ğŸ™ï¸ éŒ„éŸ³å›æ”¾</h3>
            <audio id="record-player" controls style="width:100%;"></audio>
        </div>
        <div style="width:100%;">
            <h3 style="margin-bottom:10px;">ğŸ“œ é¡Œç›®å›é¡§</h3>
            <div id="game-history" style="width:100%; background:#fafafa; padding:10px; border-radius:10px;"></div>
        </div>
        <div style="display:flex; gap:20px;">
            <button class="icon-btn" onclick="goHome()">ğŸ </button>
            <button class="btn-primary" onclick="restartGame()">å†ä¾†ä¸€æ¬¡</button>
        </div>
    </div>

    <div id="cropper-modal">
        <h3 style="color:white; margin-bottom:10px;">âœ‚ï¸ æ‹–æ›³é¸æ“‡ç¯„åœ</h3>
        <div id="cropper-container" onmousedown="cropDragStart(event)" onmousemove="cropDragMove(event)" onmouseup="cropDragEnd(event)"
             ontouchstart="cropDragStart(event)" ontouchmove="cropDragMove(event)" ontouchend="cropDragEnd(event)">
            <img id="cropper-img" src="">
            <div id="crop-box"></div>
        </div>
        <div style="margin-top:15px; display:flex; gap:15px;">
            <button class="btn-primary" onclick="confirmCrop()">âœ… ç¢ºèª</button>
            <button class="btn-action" style="background:#777;" onclick="closeCropper()">âŒ å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ============================================
        // 1. å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™è¨­å®š
        // ============================================
        let customData = {}; 
        let searchData = {}; 
        let tempSearchItems = []; 
        let adminPassword = "8888"; 
        let db = null;
        let currentMusicData = null; 
        let cropTargetType = 'bg'; 
        let cropTargetIndex = -1;
        let cropState = { startX:0, startY:0, isDragging:false, rect:{} };

        let gameState = {
            round: 0, maxRounds: 3, theme: 'flags', bpm: 165,
            offset: 0, interval: 0, introSeconds: 2.5, playbackRate: 1.0, 
            isPaused: false, abortController: null, selectedTheme: 'flags',
            isRecording: false, hintMode: 'first', uniqueCount: 8, isMuted: false, 
            history: [], activePool: [], currentRunTheme: ''
        };

        let bgmAudio = new Audio();
        let mediaRecorder, audioChunks = [];

        // å…§å»ºè³‡æ–™åº«
        const flagsData = [{c:'tw',n:'å°ç£'},{c:'jp',n:'æ—¥æœ¬'},{c:'us',n:'ç¾åœ‹'},{c:'kr',n:'éŸ“åœ‹'},{c:'gb',n:'è‹±åœ‹'},{c:'fr',n:'æ³•åœ‹'},{c:'de',n:'å¾·åœ‹'},{c:'cn',n:'ä¸­åœ‹'},{c:'it',n:'ç¾©å¤§åˆ©'},{c:'ca',n:'åŠ æ‹¿å¤§'},{c:'au',n:'æ¾³æ´²'},{c:'th',n:'æ³°åœ‹'}];
        const commonData = {
            pokemon: [
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png', n:'çš®å¡ä¸˜'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png', n:'å¦™è›™ç¨®å­'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png', n:'å°ç«é¾'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png', n:'å‚‘å°¼é¾œ'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png', n:'ä¼Šå¸ƒ'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png', n:'å¡æ¯”ç¸'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/150.png', n:'è¶…å¤¢'},
                {u:'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/54.png', n:'å¯é”é´¨'}
            ],
            animals: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ'],
            numbers: ['1','2','3','4','5','6','7','8','9','10','11','12'],
            colors: [{c:'#ff0000',n:'ç´…'},{c:'#00ff00',n:'ç¶ '},{c:'#0000ff',n:'è—'},{c:'#ffff00',n:'é»ƒ'},{c:'#000000',n:'é»‘'},{c:'#ffffff',n:'ç™½'}],
            math: ['+','-','Ã—','Ã·','=','â‰ ','>','<','Ï€','âˆš','âˆ'],
            food: [{u:'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38',n:'Pizza'},{u:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd',n:'Burger'}]
        };

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCZYi7QnXngx0FxoYY4vjJm0BeN1tYhn18",
            authDomain: "rythm-game-v9.firebaseapp.com",
            databaseURL: "https://rythm-game-v9-default-rtdb.firebaseio.com",
            projectId: "rythm-game-v9",
            storageBucket: "rythm-game-v9.firebasestorage.app",
            messagingSenderId: "597761558836",
            appId: "1:597761558836:web:e232dcd52f4946b8b1bd61",
            measurementId: "G-NT26BCBJRP"
        };

        // ============================================
        // 2. åˆå§‹åŒ–èˆ‡å­˜æª”è®€æª”
        // ============================================
        window.addEventListener('load', async () => {
            loadSearchData();
            loadSettings();
            applyBackground();
            updateThemeSelect();
            initFirebaseAuto();
            
            // æ¢å¾©éŸ³æ¨‚
            const savedMusic = localStorage.getItem('rg_bg_music');
            const savedName = localStorage.getItem('rg_bg_music_name');
            if (savedMusic) {
                bgmAudio.src = savedMusic;
                currentMusicData = savedMusic;
                bgmAudio.load();
                const status = document.getElementById('file-status');
                if(status) status.innerText = `âœ… å·²è¼‰å…¥: ${savedName || 'ä¸Šæ¬¡çš„éŸ³æ¨‚'}`;
            }
        });

        function saveSearchData() {
            try { localStorage.setItem('rg_search_data_v2', JSON.stringify(searchData)); } 
            catch(e) { console.error("LS Full", e); alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åˆªé™¤éƒ¨åˆ†ä¸»é¡Œ"); }
        }

        function loadSearchData() {
            const saved = localStorage.getItem('rg_search_data_v2');
            if (saved) { try { searchData = JSON.parse(saved); } catch(e){} }
        }

        function saveSettings() {
            const s = localStorage;
            s.setItem('rg_theme', document.getElementById('theme-select').value);
            s.setItem('rg_rounds', document.getElementById('round-select').value);
            s.setItem('rg_bpm', document.getElementById('bpm-input').value);
            s.setItem('rg_offset', document.getElementById('offset-input').value);
            s.setItem('rg_intro', document.getElementById('intro-seconds-input').value);
            s.setItem('rg_interval', document.getElementById('interval-input').value);
            s.setItem('rg_rate', document.getElementById('rate-input').value);
            s.setItem('rg_record', document.getElementById('record-toggle').value);
            s.setItem('rg_hint', document.getElementById('hint-mode').value);
            s.setItem('rg_unique', document.getElementById('unique-count').value);
            
            // UI Update
            document.getElementById('bpm-display').innerText = document.getElementById('bpm-input').value;
            document.getElementById('interval-display').innerText = document.getElementById('interval-input').value;
            document.getElementById('rate-display').innerText = document.getElementById('rate-input').value;
        }

        function loadSettings() {
            const s = localStorage;
            const setVal = (id, key) => { if(s.getItem(key)) document.getElementById(id).value = s.getItem(key); };
            setVal('theme-select', 'rg_theme');
            setVal('round-select', 'rg_rounds');
            setVal('bpm-input', 'rg_bpm');
            setVal('offset-input', 'rg_offset');
            setVal('intro-seconds-input', 'rg_intro');
            setVal('interval-input', 'rg_interval');
            setVal('rate-input', 'rg_rate');
            setVal('record-toggle', 'rg_record');
            setVal('hint-mode', 'rg_hint');
            setVal('unique-count', 'rg_unique');

            if(s.getItem('rg_bpm')) document.getElementById('bpm-display').innerText = s.getItem('rg_bpm');
            if(s.getItem('rg_rate')) document.getElementById('rate-display').innerText = s.getItem('rg_rate');
            if(s.getItem('rg_interval')) document.getElementById('interval-display').innerText = s.getItem('rg_interval');
        }

        // ============================================
        // 3. åœ–ç‰‡å£“ç¸®å·¥å…·èˆ‡è³‡æ–™å¤¾åŒ¯å…¥
        // ============================================
        
        function compressImage(file, maxWidth = 500, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleFolderImport(input) {
            const files = input.files;
            const statusDiv = document.getElementById('folder-import-status');
            const btn = input.nextElementSibling;
            
            if (!files || files.length === 0) { if(statusDiv) statusDiv.innerText = "âŒ æœªé¸æ“‡"; return; }
            if(btn) btn.innerText = "â³ æ­£åœ¨å£“ç¸®åœ–ç‰‡ä¸­...";
            
            const validExts = ['.jpg','.jpeg','.png','.gif','.webp','.bmp'];
            const newImages = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const name = file.name.toLowerCase();
                if (validExts.some(ext => name.endsWith(ext))) {
                    try {
                        const base64 = await compressImage(file);
                        newImages.push({ url: base64, label: file.name.split('.')[0] });
                    } catch(e) {}
                }
            }

            if (newImages.length === 0) {
                alert("âŒ æ‰¾ä¸åˆ°æ”¯æ´çš„åœ–ç‰‡");
                if(btn) btn.innerText = "ğŸ“ åŒ¯å…¥æœ¬æ©Ÿè³‡æ–™å¤¾";
                return;
            }

            let folderName = "æœ¬æ©Ÿè³‡æ–™å¤¾";
            if (files[0].webkitRelativePath) {
                const parts = files[0].webkitRelativePath.split('/');
                if(parts.length>0) folderName = parts[0];
            }

            const newId = "search_" + Date.now();
            searchData[newId] = { title: folderName, images: newImages, imported: true };

            saveSearchData();
            updateThemeSelect();
            updateUploadSelect();
            document.getElementById('theme-select').value = newId;
            saveSettings();

            if(btn) btn.innerText = "ğŸ“ åŒ¯å…¥æœ¬æ©Ÿè³‡æ–™å¤¾";
            if(statusDiv) {
                statusDiv.innerHTML = `âœ… æˆåŠŸåŒ¯å…¥ <b>${newImages.length}</b> å¼µåœ–ç‰‡ (å·²å­˜æª”)`;
                statusDiv.style.color = "green";
            }
            alert(`âœ… åŒ¯å…¥æˆåŠŸï¼\nå…± ${newImages.length} å¼µåœ–ç‰‡ã€‚`);
            input.value = '';
        }

        // ============================================
        // 4. è‡ªè¨‚æœå°‹ã€é è¦½ã€ç´”æ–‡å­—å¡
        // ============================================
        // --- ä¿®æ­£ç‰ˆï¼šæœå°‹åŠŸèƒ½ (æ”¯æ´å–®å¼µç²¾æº– / å¤šå¼µä¸»é¡Œæ¨¡å¼) ---
        async function searchImages(count = 1) {
            const inputVal = document.getElementById('search-input').value.trim();
            if (!inputVal) return alert("è«‹è¼¸å…¥é—œéµå­—");
            
            const keywords = inputVal.split(/[,ï¼Œã€]|\s+(?=[\u4e00-\u9fa5])|(?<=[\u4e00-\u9fa5])\s+/).map(k=>k.trim()).filter(k=>k);
            if (keywords.length===0) return;

            document.getElementById('preview-area').style.display = 'block';
            document.getElementById('preview-grid').innerHTML = '<div style="grid-column:1/-1;text-align:center;">ğŸ” æœå°‹ä¸­...</div>';
            tempSearchItems = [];
            const source = document.getElementById('search-source').value;

            for (let k of keywords) {
                // åƒæ•¸ count: æ±ºå®šè¦æŠ“å¹¾å¼µ
                // åƒæ•¸ true: ä»£è¡¨ä½¿ç”¨ç²¾æº–æ¨™é¡Œæ¨¡å¼ (æ¯”è¼ƒä¸æœƒæœåˆ°å¥‡æ€ªçš„é—œè¯åœ–)
                const items = await fetchWikiSmart(k, source, count, true);
                
                if(items.length > 0) {
                    // å¦‚æœæ˜¯ä¸»é¡Œæœå°‹(5å¼µ)ï¼Œitems è£¡é¢æœƒæœ‰ 5 å€‹ä¸åŒçš„çµæœ (ä¾‹å¦‚äº”ä½ä¸åŒçš„æ­Œæ‰‹)
                    // æˆ‘å€‘æŠŠå®ƒå€‘å…¨éƒ¨åŠ é€²å»
                    items.forEach(item => {
                        tempSearchItems.push(item);
                    });
                } else {
                    // æ²’æœåˆ°ä¹Ÿè¦ä½”ä¸€æ ¼
                    tempSearchItems.push({label:k, images:[`https://placehold.co/200?text=${k}`], currentIndex:0});
                }
            }
            
            renderPreviewGrid();
            
            const modeText = count > 1 ? "ğŸ¨ ä¸»é¡Œæ¨¡å¼" : "ğŸ” ç²¾æº–æ¨¡å¼";
            document.getElementById('search-status').innerText = `âœ… ${modeText}: å·²è¼‰å…¥ ${tempSearchItems.length} å¼µå¡ç‰‡`;
        }

        async function fetchWikiSmart(keyword, source, limit, useWikiTitle) {
            try {
                const isWiki = source === 'wiki';
                const baseUrl = isWiki ? 'https://zh.wikipedia.org/w/api.php' : 'https://commons.wikimedia.org/w/api.php';
                const searchUrl = isWiki 
                    ? `${baseUrl}?action=query&generator=search&gsrsearch=${encodeURIComponent(keyword)}&gsrlimit=${limit*3}&prop=pageimages|info&pithumbsize=400&format=json&origin=*`
                    : `${baseUrl}?action=query&generator=search&gsrsearch=${encodeURIComponent(keyword)}%20filetype:bitmap&gsrlimit=${limit*3}&prop=imageinfo&iiprop=url&iiurlwidth=400&format=json&origin=*`;
                
                const res = await fetch(searchUrl);
                const data = await res.json();
                const items = [];
                const seen = new Set();
                
                if(data.query && data.query.pages) {
                    const pages = Object.values(data.query.pages);
                    for(let p of pages) {
                        let img = null, title = p.title;
                        if(isWiki && p.thumbnail) img = p.thumbnail.source;
                        else if(!isWiki && p.imageinfo && p.imageinfo[0]) img = p.imageinfo[0].thumburl || p.imageinfo[0].url;
                        
                        if(img && !seen.has(img) && !img.includes('.svg')) {
                            seen.add(img);
                            items.push({
                                label: useWikiTitle ? title : keyword,
                                images: [img],
                                currentIndex: 0
                            });
                        }
                    }
                }
                
                if(limit===1 && items.length>0) {
                    const allImgs = items.map(i=>i.images[0]);
                    return [{ label: keyword, images: allImgs, currentIndex:0 }];
                }
                return items.slice(0, limit);
            } catch(e) { return []; }
        }

        // --- ç´”æ–‡å­—å­—å¡åŠŸèƒ½ (æ–°) ---
        function addTextSlot() {
            const text = document.getElementById('text-card-content').value.trim();
            const color = document.getElementById('text-card-color').value;
            if(!text) return alert("è«‹è¼¸å…¥æ–‡å­—");

            // 1. å»ºç«‹ Canvas
            const canvas = document.createElement('canvas');
            canvas.width = 400; canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // 2. ç•«èƒŒæ™¯
            ctx.fillStyle = color;
            ctx.fillRect(0,0,400,400);
            
            // 3. åˆ¤æ–·æ–‡å­—é¡è‰² (é»‘/ç™½å°æ¯”)
            const hex = color.replace('#','');
            const r = parseInt(hex.substr(0,2),16);
            const g = parseInt(hex.substr(2,2),16);
            const b = parseInt(hex.substr(4,2),16);
            const yiq = ((r*299)+(g*587)+(b*114))/1000;
            ctx.fillStyle = (yiq >= 128) ? '#000000' : '#ffffff';

            // 4. ç•«æ–‡å­—
            ctx.font = 'bold 80px Microsoft JhengHei';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // è‡ªå‹•ç¸®å°å­—é«”ä»¥é©æ‡‰
            let fontSize = 80;
            do {
                ctx.font = `bold ${fontSize}px Microsoft JhengHei`;
                fontSize -= 5;
            } while (ctx.measureText(text).width > 360 && fontSize > 10);
            
            ctx.fillText(text, 200, 200);

            // 5. è½‰ç‚º Base64 åœ–ç‰‡
            const base64 = canvas.toDataURL('image/jpeg');

            // 6. åŠ å…¥åˆ—è¡¨
            tempSearchItems.push({
                label: text,
                images: [base64],
                currentIndex: 0
            });
            renderPreviewGrid();
            document.getElementById('text-card-content').value = ""; // æ¸…ç©º
        }

        // --- å–®æ ¼ AI ç”Ÿåœ– (å¾©åŸ) ---
        async function generateSingleSlotAI(index) {
            const inputEl = document.getElementById(`input-${index}`);
            const keyword = inputEl.value.trim();
            if (!keyword) return alert("è«‹å…ˆè¼¸å…¥é—œéµå­—");
            const imgEl = document.getElementById(`prev-img-${index}`);
            imgEl.style.opacity = 0.5;
            const seed = Math.floor(Math.random() * 100000);
            const newUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(keyword)}?seed=${seed}&nologo=true`;
            
            // é è¼‰
            const temp = new Image();
            temp.onload = () => {
                tempSearchItems[index].images = [newUrl];
                tempSearchItems[index].currentIndex = 0;
                imgEl.src = newUrl; imgEl.style.opacity = 1;
            };
            temp.onerror = () => { alert("AI ç”Ÿåœ–å¤±æ•—"); imgEl.style.opacity = 1; };
            temp.src = newUrl;
        }

        // --- å–®æ ¼æœå°‹ (å¾©åŸ) ---
        // --- ä¿®æ­£ç‰ˆï¼šå–®æ ¼æœå°‹ (é–å®šä¸­æ–‡ç¶­åŸºï¼Œæ”¯æ´è‹±æ–‡æŸ¥æ‰¾) ---
        // --- ä¿®æ­£ç‰ˆï¼šå–®æ ¼æœå°‹ (å¼·åŠ›æŒ–åœ– + Proxy + æ›åœ–ä¿®å¾©) ---
        // --- ä¿®æ­£ç‰ˆï¼šå–®æ ¼æœå°‹ (æ”¹ç”¨ ID æŠ“å–å…ƒç´ ï¼Œè§£æ±ºæ²’åæ‡‰çš„ Bug) ---
        async function updateSingleSlot(index) {
            const inputEl = document.getElementById(`input-${index}`);
            if(!inputEl) return; // é˜²å‘†
            
            const userKeyword = inputEl.value.trim(); 
            if (!userKeyword) return alert("è«‹è¼¸å…¥é—œéµå­—");
            
            tempSearchItems[index].label = userKeyword;
            const sourceEl = document.getElementById('search-source');
            const source = sourceEl ? sourceEl.value : 'wiki'; // é˜²å‘†
            
            // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šç›´æ¥ç”¨ ID æŠ“å–æ ¼å­ï¼Œä¸å†ç”¨ children[index] çŒœæ¸¬ â˜…â˜…â˜…
            const slotDiv = document.getElementById(`preview-slot-${index}`);
            if(!slotDiv) return; // æ‰¾ä¸åˆ°æ ¼å­å°±çµæŸï¼Œä¸æœƒå ±éŒ¯

            // æ¸…é™¤èˆŠé®ç½©
            const oldOverlay = slotDiv.querySelector('.selection-overlay');
            if(oldOverlay) oldOverlay.remove();

            // å»ºç«‹æ–°é®ç½©
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'selection-overlay';
            loadingOverlay.style.cssText = `
                position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(255,255,255,0.98); z-index: 10;
                display: flex; flex-direction: column; padding: 5px; box-sizing: border-box;
                border-radius: 8px; border: 2px solid #54a0ff;
            `;
            loadingOverlay.innerHTML = '<div style="margin:auto; color:#666;">ğŸ” æœå°‹æ¨™é¡Œä¸­...</div>';
            slotDiv.appendChild(loadingOverlay);

            // Fetch å·¥å…·
            const fetchWithTimeout = async (url, ms = 6000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), ms);
                try {
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(id);
                    return response;
                } catch (error) { clearTimeout(id); throw error; }
            };

            const tryFetchJson = async (url) => {
                try {
                    const res = await fetchWithTimeout(url);
                    if (!res.ok) throw new Error("Fail");
                    return await res.json();
                } catch (e) {
                    loadingOverlay.innerHTML = '<div style="margin:auto; color:#666;">âš ï¸ å•Ÿç”¨å‚™ç”¨ç·šè·¯...</div>';
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                    const resProxy = await fetchWithTimeout(proxyUrl);
                    return await resProxy.json();
                }
            };

            // æ·±å±¤æŒ–åœ–
            const fetchBestImageForTitle = async (exactTitle) => {
                loadingOverlay.innerHTML = '<div style="margin:auto; color:#666;">ğŸ“¸ æ­£åœ¨æŒ–æ˜åœ–ç‰‡...</div>';
                const baseUrl = (source === 'wiki') ? 'https://zh.wikipedia.org/w/api.php?variant=zh-tw' : 'https://commons.wikimedia.org/w/api.php';

                try {
                    let imgUrl = null;
                    if (source === 'wiki') {
                        const targetUrl = `${baseUrl}&action=query&titles=${encodeURIComponent(exactTitle)}&generator=images&gimlimit=10&prop=imageinfo&iiprop=url&format=json&origin=*`;
                        const data = await tryFetchJson(targetUrl);
                        if (data.query && data.query.pages) {
                            const pages = Object.values(data.query.pages);
                            const validImgs = pages.filter(p => {
                                if(!p.imageinfo || !p.imageinfo[0]) return false;
                                const u = p.imageinfo[0].url;
                                return !u.endsWith('.svg') && !u.includes('Icon') && !u.includes('Ambox');
                            });
                            if(validImgs.length > 0) imgUrl = validImgs[0].imageinfo[0].url;
                        }
                    }
                    if (!imgUrl) {
                        const targetUrl = `${baseUrl}&action=query&titles=${encodeURIComponent(exactTitle)}&prop=pageimages&pithumbsize=600&format=json&origin=*`;
                        const data = await tryFetchJson(targetUrl);
                        if (data.query && data.query.pages) {
                            const p = Object.values(data.query.pages)[0];
                            if (p.thumbnail) imgUrl = p.thumbnail.source;
                        }
                    }
                    return imgUrl;
                } catch (e) { return null; }
            };

            const processData = (data) => {
                loadingOverlay.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                        <span style="font-size:0.8rem; font-weight:bold; color:#555;">é»é¸ä»¥å¥—ç”¨</span>
                        <button class="btn-small" style="background:#ff6b6b;" onclick="this.closest('.selection-overlay').remove()">âœ•</button>
                    </div>
                    <div class="result-list" style="overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:4px;"></div>
                `;
                const listDiv = loadingOverlay.querySelector('.result-list');
                let foundCount = 0;

                if (data.query && data.query.pages) {
                    let pages = Object.values(data.query.pages);
                    pages.sort((a, b) => (a.index || 999) - (b.index || 999));

                    pages.forEach(page => {
                        let title = page.title;
                        if (source !== 'wiki') title = title.replace(/^File:/, '').replace(/\.[^/.]+$/, "").replace(/_/g, ' ');

                        let thumbUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Text_document_with_red_question_mark.svg/50px-Text_document_with_red_question_mark.svg.png';
                        if (source === 'wiki') { if (page.thumbnail) thumbUrl = page.thumbnail.source; } 
                        else { if (page.imageinfo && page.imageinfo[0]) thumbUrl = page.imageinfo[0].thumburl || page.imageinfo[0].url; }

                        foundCount++;
                        const item = document.createElement('div');
                        item.style.cssText = `display: flex; align-items: center; gap: 8px; padding: 4px; border: 1px solid #eee; border-radius: 5px; cursor: pointer; background:white;`;
                        item.onmouseover = () => item.style.background = "#f0f8ff";
                        item.onmouseout = () => item.style.background = "white";

                        item.innerHTML = `
                            <img src="${thumbUrl}" style="width:40px; height:40px; object-fit:contain; border-radius:4px; background:#f0f0f0; border:1px solid #ccc;">
                            <div style="font-size:0.8rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1;">${title}</div>
                        `;
                        
                        item.onclick = async () => {
                            let finalImg = null;
                            if (source === 'wiki') finalImg = await fetchBestImageForTitle(page.title);
                            if (!finalImg && !thumbUrl.includes('Text_document')) finalImg = thumbUrl;

                            if (finalImg) {
                                tempSearchItems[index].images = [finalImg];
                                tempSearchItems[index].currentIndex = 0;
                                renderPreviewGrid(); 
                            } else {
                                alert(`æŠ±æ­‰ï¼Œæ¢ç›®ã€Œ${title}ã€æ‰¾ä¸åˆ°é©åˆçš„åœ–ç‰‡...`);
                                renderPreviewGrid(); 
                            }
                        };
                        listDiv.appendChild(item);
                    });
                }
                if (foundCount === 0) {
                    loadingOverlay.innerHTML = `<div style="text-align:center; padding:20px; color:red;">æ‰¾ä¸åˆ°ã€Œ${userKeyword}ã€<br><button class="btn-small" style="background:#777; margin-top:10px;" onclick="this.closest('.selection-overlay').remove()">é—œé–‰</button></div>`;
                }
            };

            let targetUrl = '';
            if (source === 'wiki') {
                targetUrl = `https://zh.wikipedia.org/w/api.php?variant=zh-tw&action=query&generator=prefixsearch&gpssearch=${encodeURIComponent(userKeyword)}&gpslimit=10&prop=pageimages|info&pithumbsize=100&format=json&origin=*`;
            } else {
                targetUrl = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(userKeyword)}%20filetype:bitmap&gsrnamespace=6&gsrlimit=10&prop=imageinfo&iiprop=url&iiurlwidth=100&format=json&origin=*`;
            }

            try {
                const data = await tryFetchJson(targetUrl);
                processData(data);
            } catch(e) {
                console.error(e);
                loadingOverlay.innerHTML = `<div style="margin:auto; text-align:center; color:red;">é€£ç·šå¤±æ•—<br><button class="btn-small" style="background:#777; margin-top:10px;" onclick="this.closest('.selection-overlay').remove()">é—œé–‰</button></div>`;
            }
        }

        // --- ä¿®æ­£ç‰ˆï¼šæ¸²æŸ“é è¦½æ ¼ (åŠ ä¸Š ID æ¨™ç±¤ï¼Œé˜²æ­¢é †åºéŒ¯äº‚) ---
        function renderPreviewGrid() {
            const grid = document.getElementById('preview-grid');
            if(!grid) return;
            grid.innerHTML = '';
            
            tempSearchItems.forEach((slot, idx) => {
                if(slot.deleted) return;
                
                // ç¢ºä¿æœ‰åœ–ç‰‡ï¼Œæ²’åœ–å°±çµ¦ç©ºå­—ä¸²
                const img = (slot.images && slot.images.length>0) ? slot.images[(slot.currentIndex||0)%slot.images.length] : '';
                
                const div = document.createElement('div');
                div.className = 'preview-item';
                
                // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šçµ¦æ¯ä¸€æ ¼ä¸€å€‹å›ºå®šçš„ ID (preview-slot-ç·¨è™Ÿ) â˜…â˜…â˜…
                div.id = `preview-slot-${idx}`; 
                
                div.innerHTML = `
                    <div class="preview-toolbar">
                        <button class="btn-mini" onclick="generateSingleSlotAI(${idx})" title="AIç”Ÿåœ–" style="background:#a55eea;">âœ¨</button>
                        <button class="btn-mini" onclick="triggerCrop(${idx})" title="è£åˆ‡" style="background:orange;">âœ‚ï¸</button>
                        <button class="btn-mini" onclick="swapPreview(${idx})" title="æ›ä¸€å¼µ" style="background:#54a0ff;">ğŸ”„</button>
                        <button class="btn-mini" onclick="removePreview(${idx})" title="ç§»é™¤" style="background:#ff6b6b;">âŒ</button>
                    </div>
                    <img src="${img}" class="preview-img" id="prev-img-${idx}">
                    <div class="preview-edit">
                        <input type="text" class="preview-input" value="${slot.label}" id="input-${idx}" oninput="tempSearchItems[${idx}].label=this.value">
                        <button class="preview-btn-search" onclick="updateSingleSlot(${idx})" title="æœå°‹æ­¤é—œéµå­—">ğŸ”</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function swapPreview(i) {
            const s = tempSearchItems[i];
            if(s.images.length>1) {
                s.currentIndex++;
                document.getElementById(`prev-img-${i}`).src = s.images[s.currentIndex%s.images.length];
            }
        }
        function removePreview(i) { tempSearchItems[i].deleted = true; renderPreviewGrid(); }
        function addPreviewSlot() { tempSearchItems.push({label:'New', images:[], currentIndex:0}); renderPreviewGrid(); }
        function clearPreviewSlots() { if(confirm("æ¸…ç©ºï¼Ÿ")) { tempSearchItems=[]; renderPreviewGrid(); } }

        function startNewTheme() {
            tempSearchItems = [];
            document.getElementById('custom-theme-title').value = "";
            document.getElementById('theme-select').value = "flags";
            document.getElementById('preview-area').style.display = 'block';
            renderPreviewGrid();
            document.getElementById('search-status').innerText = "ğŸ†• æ–°ä¸»é¡Œæ¨¡å¼";
        }

        function editCurrentTheme() {
            const k = document.getElementById('theme-select').value;
            if(!k.startsWith('search_') || !searchData[k]) return alert("åƒ…èƒ½ç·¨è¼¯è‡ªè¨‚ä¸»é¡Œ");
            const d = searchData[k];
            document.getElementById('custom-theme-title').value = d.title;
            tempSearchItems = d.images.map(img => ({ label:img.label, images:[img.url], currentIndex:0 }));
            document.getElementById('preview-area').style.display = 'block';
            renderPreviewGrid();
            document.getElementById('search-status').innerText = `âœï¸ ç·¨è¼¯: ${d.title}`;
        }

        // ä¿®æ­£ç‰ˆï¼šç¢ºèªä¸¦å„²å­˜
        function confirmSearchTheme() {
            const active = tempSearchItems.filter(i => !i.deleted);
            if(active.length < 1) return alert("âŒ è«‹è‡³å°‘ç•™ä¸€å¼µåœ–");
            
            const finalImages = active.map(i => ({
                url: (i.images && i.images.length>0) ? i.images[(i.currentIndex||0)%i.images.length] : 'https://placehold.co/200?text=NoImg',
                label: i.label
            }));
            
            const inputTitle = document.getElementById('custom-theme-title').value.trim();
            const title = inputTitle || active[0].label;
            
            let key = "search_" + Date.now();
            const curr = document.getElementById('theme-select').value;
            if(curr.startsWith('search_') && searchData[curr]) key = curr; // è¦†è“‹æ¨¡å¼

            searchData[key] = { title: title, images: finalImages };
            saveSearchData();
            updateThemeSelect();
            updateUploadSelect();
            
            document.getElementById('theme-select').value = key;
            saveSettings();
            document.getElementById('preview-area').style.display = 'none';
            alert("âœ… ä¸»é¡Œå·²å„²å­˜ï¼");
        }

        // --- ä¿®æ­£ç‰ˆï¼šåˆªé™¤è‡ªè¨‚ä¸»é¡Œ (ç§»é™¤å¯†ç¢¼ï¼Œæ”¹ç‚ºç¢ºèªè¦–çª—) ---
        function deleteCustomTheme() {
            const k = document.getElementById('theme-select').value;
            
            // 1. é˜²å‘†ï¼šä¸èƒ½åˆªé™¤å…§å»ºä¸»é¡Œ
            if(!k.startsWith('search_')) {
                return alert("ç„¡æ³•åˆªé™¤å…§å»ºä¸»é¡Œ");
            }

            // 2. æ”¹ç‚ºã€Œç¢ºèªè¦–çª—ã€ï¼Œä¸éœ€è¦å¯†ç¢¼
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¸»é¡Œå—ï¼Ÿ\n(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)")) {
                return; // å¦‚æœæŒ‰å–æ¶ˆï¼Œå°±ç›´æ¥çµæŸ
            }

            // 3. åŸ·è¡Œåˆªé™¤
            delete searchData[k];
            saveSearchData(); 
            updateThemeSelect();
            
            // 4. åˆªå®Œå¾Œè‡ªå‹•åˆ‡æ›å›é è¨­ä¸»é¡Œ
            document.getElementById('theme-select').value = "flags"; 
            saveSettings();
            
            alert("ğŸ—‘ï¸ ä¸»é¡Œå·²åˆªé™¤");
        }

        // ============================================
        // 5. é›²ç«¯ Firebase åŠŸèƒ½
        // ============================================
        function initFirebaseAuto() {
            try {
                if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                document.getElementById('firebase-status').innerText = "ğŸŸ¢ å·²é€£ç·š";
                document.getElementById('firebase-status').style.color = "green";
                updateUploadSelect();
            } catch(e) { console.error(e); }
        }

        function updateUploadSelect() {
            const sel = document.getElementById('upload-select');
            sel.innerHTML = '<option value="">-- æœ¬æ©Ÿä¸»é¡Œ --</option>';
            for(let k in searchData) {
                let name = searchData[k].title;
                const opt = document.createElement('option');
                opt.value = k; opt.innerText = name;
                sel.appendChild(opt);
            }
        }

        async function uploadThemeOnly() {
            if(!db) return alert("æœªé€£ç·š");
            const k = document.getElementById('upload-select').value;
            if(!k) return alert("è«‹é¸æ“‡");
            const d = searchData[k];
            if(prompt(`ä¸Šå‚³ã€Œ${d.title}ã€éœ€å¯†ç¢¼:`) !== adminPassword) return alert("å¯†ç¢¼éŒ¯èª¤");
            const btn = document.querySelector('button[onclick="uploadThemeOnly()"]');
            const old = btn.innerText; btn.innerText="â³..."; btn.disabled=true;
            try {
                await db.ref('public_themes/'+k).set({
                    title: d.title, images: d.images, author: "User", date: new Date().toLocaleString(), type: "cards_only"
                });
                alert("âœ… ä¸Šå‚³æˆåŠŸ"); fetchCloudThemes();
            } catch(e) { alert("å¤±æ•—:"+e.message); }
            finally { btn.innerText=old; btn.disabled=false; }
        }

        function fetchCloudThemes() {
            if(!db) return;
            const div = document.getElementById('cloud-list-container');
            div.innerHTML = 'â³...';
            db.ref('public_themes').once('value').then(snap=>{
                const v = snap.val(); div.innerHTML = '';
                if(!v) { div.innerHTML='ç„¡è³‡æ–™'; return; }
                Object.keys(v).forEach(k=>{
                    const t = v[k];
                    const el = document.createElement('div'); el.className = 'cloud-item';
                    el.innerHTML = `<span>${t.title}</span> <div><button class="btn-small btn-dl" onclick="downloadCloud('${k}')">ğŸ“¥</button><button class="btn-small btn-del-cloud" onclick="deleteAny('${k}','public_themes')">ğŸ—‘ï¸</button></div>`;
                    div.appendChild(el);
                });
            });
        }

        function downloadCloud(k) {
            if(!confirm("ä¸‹è¼‰?")) return;
            db.ref('public_themes/'+k).once('value').then(s=>{
                const v = s.val();
                if(v) {
                    const nk = "search_"+Date.now();
                    searchData[nk] = { title:v.title, images:v.images };
                    saveSearchData(); updateThemeSelect(); updateUploadSelect();
                    document.getElementById('theme-select').value = nk; saveSettings();
                    alert("âœ… å·²ä¸‹è¼‰ä¸¦å¥—ç”¨");
                }
            });
        }

        function uploadMediaOnly() {
            if(!db) return alert("æœªé€£ç·š");
            const bg = localStorage.getItem('rg_bg_image');
            if(!bg && !currentMusicData) return alert("ç„¡èƒŒæ™¯æˆ–éŸ³æ¨‚");
            const name = document.getElementById('media-pack-name').value.trim();
            if(!name) return alert("è«‹å‘½å");
            let size = 0; if(bg) size += bg.length; if(currentMusicData) size += currentMusicData.length;
            if(size > 8*1024*1024) return alert("æª”æ¡ˆå¤ªå¤§ (>8MB)ï¼Œç„¡æ³•ä¸Šå‚³");
            if(prompt("å¯†ç¢¼:")!==adminPassword) return alert("éŒ¯èª¤");
            const mid = "media_"+Date.now();
            const btn = document.querySelector('button[onclick="uploadMediaOnly()"]');
            btn.innerText="â³..."; btn.disabled=true;
            db.ref('public_media/'+mid).set({
                title: name, bgImage: bg||null, bgMusic: currentMusicData||null, date: new Date().toLocaleString()
            }).then(()=>{ alert("âœ… ä¸Šå‚³æˆåŠŸ"); fetchCloudMedia(); document.getElementById('media-pack-name').value=""; })
              .catch(e=>alert("å¤±æ•—")).finally(()=>{ btn.innerText="â¬†ï¸ä¸Šå‚³"; btn.disabled=false; });
        }

        function fetchCloudMedia() {
            if(!db) return;
            const div = document.getElementById('cloud-media-list'); div.innerHTML = 'â³...';
            db.ref('public_media').once('value').then(snap=>{
                const v = snap.val(); div.innerHTML = '';
                if(!v) { div.innerHTML='ç„¡è³‡æ–™'; return; }
                Object.keys(v).forEach(k=>{
                    const m = v[k];
                    let info = []; if(m.bgImage) info.push("åœ–"); if(m.bgMusic) info.push("éŸ³");
                    const el = document.createElement('div'); el.className = 'cloud-item';
                    el.innerHTML = `<span>${m.title} (${info.join('+')})</span> <div><button class="btn-small btn-dl-media" onclick="dlMedia('${k}')">ğŸ“¥</button><button class="btn-small btn-del-cloud" onclick="deleteAny('${k}','public_media')">ğŸ—‘ï¸</button></div>`;
                    div.appendChild(el);
                });
            });
        }

        function dlMedia(k) {
            if(!confirm("å¥—ç”¨åª’é«”åŒ… (å°‡è¦†è“‹ç›®å‰èƒŒæ™¯/éŸ³æ¨‚)?")) return;
            db.ref('public_media/'+k).once('value').then(s=>{
                const v = s.val();
                if(v) {
                    if(v.bgImage) { localStorage.setItem('rg_bg_image', v.bgImage); applyBackground(); }
                    if(v.bgMusic) { 
                        currentMusicData = v.bgMusic; localStorage.setItem('rg_bg_music', v.bgMusic);
                        bgmAudio.src = v.bgMusic; bgmAudio.load(); 
                        document.getElementById('file-status').innerText="âœ… å·²è¼‰å…¥é›²ç«¯éŸ³æ¨‚";
                    }
                    alert("âœ… å·²å¥—ç”¨");
                }
            });
        }

        function deleteAny(k, node) {
            if(prompt("å¯†ç¢¼:")!==adminPassword) return;
            db.ref(node+'/'+k).remove().then(()=>{ alert("å·²åˆªé™¤"); if(node==='public_themes') fetchCloudThemes(); else fetchCloudMedia(); });
        }

        // ============================================
        // 6. UI èˆ‡ éŠæˆ²é‚è¼¯
        // ============================================
        function updateThemeSelect() {
            const sel = document.getElementById('theme-select');
            const saved = sel.value; 
            sel.innerHTML = `
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–)</option>
            `;
            const grp = document.createElement('optgroup'); grp.label = "ğŸ” è‡ªè¨‚èˆ‡åŒ¯å…¥";
            for(let k in searchData) {
                const opt = document.createElement('option');
                opt.value = k; opt.innerText = searchData[k].title;
                grp.appendChild(opt);
            }
            sel.appendChild(grp);
            sel.innerHTML += `
                <optgroup label="å…§å»º">
                    <option value="flags">ğŸ—ºï¸ åœ‹æ——</option>
                    <option value="animals">ğŸ¦ å‹•ç‰©</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                    <option value="math">â— æ•¸å­¸</option>
                    <option value="food">ğŸ” ç¾é£Ÿ</option>
                    <option value="pokemon">ğŸ± å¯¶å¯å¤¢</option>
                </optgroup>
            `;
            if(saved && sel.querySelector(`option[value="${saved}"]`)) sel.value = saved;
        }

        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettingsBtn() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeSettings(e) { if(e.target.id==='settings-modal') closeSettingsBtn(); }
        
        function goHome() {
            // â˜… æ–°å¢ï¼šå¼·åˆ¶ä¸­æ­¢éŠæˆ²è¿´åœˆï¼Œé˜²æ­¢èƒŒæ™¯ç¹¼çºŒè·‘
            if(gameState.abortController) gameState.abortController.abort();
            
            // â˜… æ–°å¢ï¼šé‡ç½®éŸ³æ¨‚é€²åº¦
            bgmAudio.pause();
            bgmAudio.currentTime = 0;

            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
        }

        document.getElementById('music-file').addEventListener('change', function(e) {
            const f = e.target.files[0];
            if(!f) return;
            if(f.size > 2.5*1024*1024) return alert("æª”æ¡ˆå¤ªå¤§ (>2.5MB)ï¼Œè«‹ä½¿ç”¨å‰ªè¼¯ç‰ˆ");
            const r = new FileReader();
            document.getElementById('file-status').innerText = "è®€å–ä¸­...";
            r.onload = (ev) => {
                const d = ev.target.result;
                bgmAudio.src = d; bgmAudio.load();
                currentMusicData = d;
                try { localStorage.setItem('rg_bg_music', d); localStorage.setItem('rg_bg_music_name', f.name); } catch(e){}
                document.getElementById('file-status').innerText = "âœ… " + f.name;
            };
            r.readAsDataURL(f);
        });

        function testAudio() {
            if(!bgmAudio.src) return alert("ç„¡éŸ³æ¨‚");
            bgmAudio.volume = gameState.isMuted ? 0 : 1;
            bgmAudio.playbackRate = document.getElementById('rate-input').value;
            bgmAudio.play().then(()=>setTimeout(()=>{bgmAudio.pause();bgmAudio.currentTime=0;},3000));
        }
        function toggleMute() {
            gameState.isMuted = !gameState.isMuted;
            bgmAudio.muted = gameState.isMuted;
            const t = gameState.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            document.getElementById('mute-home').innerText = t;
            document.getElementById('mute-game').innerText = t;
        }

        // è£åˆ‡ç›¸é—œ
        function startCropper(input) {
            if(!input.files[0]) return;
            cropTargetType = 'bg';
            const r = new FileReader();
            r.onload = e => {
                const img = document.getElementById('cropper-img');
                img.src = e.target.result;
                img.onload = () => {
                    document.getElementById('cropper-modal').style.display = 'flex';
                    document.getElementById('crop-box').style.display = 'none';
                    document.getElementById('bg-upload').value = '';
                };
            };
            r.readAsDataURL(input.files[0]);
        }
        function triggerCrop(idx) {
            const s = tempSearchItems[idx];
            if(!s || !s.images[0]) return alert("ç„¡åœ–ç‰‡");
            startCropperForWiki(s.images[(s.currentIndex||0)%s.images.length], idx);
        }
        async function startCropperForWiki(url, idx) {
            try {
                let blob = null;
                const fetchBlob = async(u) => { const r = await fetch(u); if(!r.ok)throw 0; return r.blob(); };
                try { blob = await fetchBlob(url); } 
                catch(e) { blob = await fetchBlob(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`); }
                const objUrl = URL.createObjectURL(blob);
                cropTargetType = 'card'; cropTargetIndex = idx;
                const img = document.getElementById('cropper-img');
                img.src = objUrl;
                img.onload = () => {
                    document.getElementById('cropper-modal').style.display = 'flex';
                    document.getElementById('crop-box').style.display = 'none';
                    cropState = { startX:0, startY:0, isDragging:false, rect:{} };
                };
            } catch(e) { alert("åœ–ç‰‡ç„¡æ³•ä¸‹è¼‰ï¼Œè«‹æ›ä¸€å¼µ"); }
        }
        function closeCropper() { document.getElementById('cropper-modal').style.display = 'none'; }
        
        function getPos(e) {
            const r = document.getElementById('cropper-container').getBoundingClientRect();
            const cx = e.touches?e.touches[0].clientX:e.clientX;
            const cy = e.touches?e.touches[0].clientY:e.clientY;
            return { x: cx-r.left, y: cy-r.top };
        }
        function cropDragStart(e) {
            e.preventDefault(); cropState.isDragging=true;
            const p = getPos(e);
            cropState.startX=p.x; cropState.startY=p.y;
            const b = document.getElementById('crop-box');
            b.style.display='block'; b.style.left=p.x+'px'; b.style.top=p.y+'px'; b.style.width='0'; b.style.height='0';
        }
        function cropDragMove(e) {
            if(!cropState.isDragging) return;
            e.preventDefault();
            const p = getPos(e);
            const w = Math.abs(p.x - cropState.startX);
            const h = Math.abs(p.y - cropState.startY);
            const l = Math.min(p.x, cropState.startX);
            const t = Math.min(p.y, cropState.startY);
            const b = document.getElementById('crop-box');
            b.style.width=w+'px'; b.style.height=h+'px'; b.style.left=l+'px'; b.style.top=t+'px';
            cropState.rect = {left:l, top:t, width:w, height:h};
        }
        function cropDragEnd() { cropState.isDragging=false; }
        
        // --- ä¿®æ­£ç‰ˆï¼šè£åˆ‡ç¢ºèª (è§£æ±º PNG é€æ˜è®Šé»‘å•é¡Œ) ---
        function confirmCrop() {
            const r = cropState.rect;
            if(!r.width) return alert("è«‹æ‹‰æ¡†");
            
            const img = document.getElementById('cropper-img');
            const scaleX = img.naturalWidth / img.offsetWidth;
            const scaleY = img.naturalHeight / img.offsetHeight;
            
            const cvs = document.createElement('canvas');
            let tw = r.width * scaleX; 
            let th = r.height * scaleY;
            
            // é™åˆ¶æœ€å¤§è§£æåº¦ (é¿å…å¡é “)
            if(tw>1000 || th>1000) { const ratio = Math.min(1000/tw, 1000/th); tw*=ratio; th*=ratio; }
            
            cvs.width = tw; 
            cvs.height = th;
            const ctx = cvs.getContext('2d');

            // â˜… é—œéµä¿®æ­£ï¼šå…ˆç•«ä¸€å€‹ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, tw, th);

            // å†ç•«åœ–ç‰‡
            ctx.drawImage(img, r.left*scaleX, r.top*scaleY, r.width*scaleX, r.height*scaleY, 0, 0, tw, th);
            
            const base64 = cvs.toDataURL('image/jpeg', 0.85);
            
            if(cropTargetType==='bg') {
                try { localStorage.setItem('rg_bg_image', base64); applyBackground(); } catch(e){alert("èƒŒæ™¯å¤ªå¤§");}
            } else {
                if(tempSearchItems[cropTargetIndex]) {
                    const old = tempSearchItems[cropTargetIndex].images;
                    // æŠŠæ–°è£åˆ‡çš„åœ–æ”¾åœ¨ç¬¬ä¸€å¼µ
                    tempSearchItems[cropTargetIndex].images = [base64, ...old];
                    tempSearchItems[cropTargetIndex].currentIndex = 0;
                    renderPreviewGrid();
                }
            }
            closeCropper();
        }

        function applyBackground() {
            const bg = localStorage.getItem('rg_bg_image');
            if(bg) { document.body.style.backgroundImage = `url('${bg}')`; document.body.classList.add('has-custom-bg'); }
            else { document.body.style.backgroundImage = ''; document.body.classList.remove('has-custom-bg'); }
        }
        function clearBackground() { if(confirm("æ¸…é™¤èƒŒæ™¯?")) { localStorage.removeItem('rg_bg_image'); applyBackground(); } }

        // ============================================
        // 7. éŠæˆ²æ ¸å¿ƒé‚è¼¯
        // ============================================
        // --- â˜… æ–°å¢ï¼šå¾ API éš¨æ©ŸæŠ“å–å¯¶å¯å¤¢ (æ”¯æ´ä¸­æ–‡å) ---
        async function fetchRandomPokemonPool(count) {
            const btn = document.querySelector('.btn-primary'); // å–å¾—é–‹å§‹æŒ‰éˆ•
            const oldText = btn.innerText;
            btn.innerText = "ğŸ” æ­£åœ¨å¬å–šå¯¶å¯å¤¢..."; // é¡¯ç¤ºè¼‰å…¥ä¸­
            btn.disabled = true;

            const newPool = [];
            const usedIds = new Set();
            
            // éš¨æ©Ÿç”¢ç”Ÿ ID (é¿é–‹é‡è¤‡)
            while(newPool.length < count) {
                // ç›®å‰åœ–é‘‘ç´„åˆ° 1025 è™Ÿ
                const id = Math.floor(Math.random() * 1025) + 1; 
                if(!usedIds.has(id)) {
                    usedIds.add(id);
                    newPool.push(id);
                }
            }

            // åŒæ­¥ç™¼é€è«‹æ±‚ (åŠ å¿«é€Ÿåº¦)
            try {
                const promises = newPool.map(async (id) => {
                    // 1. æŠ“å–ä¸­æ–‡åç¨± (Species API)
                    const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
                    const data = await res.json();
                    
                    // 2. æ‰¾åˆ°ç¹é«”ä¸­æ–‡ (zh-Hant) æˆ– ç°¡é«” (zh-Hans) æˆ– æ—¥æ–‡ (ja)
                    let nameObj = data.names.find(n => n.language.name === 'zh-Hant');
                    if(!nameObj) nameObj = data.names.find(n => n.language.name === 'zh-Hans');
                    if(!nameObj) nameObj = data.names.find(n => n.language.name === 'ja'); // æ²’ä¸­æ–‡å°±ç”¨æ—¥æ–‡
                    const name = nameObj ? nameObj.name : `No.${id}`;

                    // 3. åœ–ç‰‡ç¶²å€ (ç›´æ¥ç”¨ ID æ‹¼æ¹Šï¼Œä¸ç”¨å† fetch)
                    const img = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

                    return { content: img, label: name };
                });

                const results = await Promise.all(promises);
                btn.innerText = oldText;
                btn.disabled = false;
                return results;

            } catch (e) {
                console.error("æŠ“å¯¶å¤±æ•—", e);
                alert("ç¶²è·¯é€£ç·šå•é¡Œï¼Œå°‡ä½¿ç”¨å…§å»ºå‚™ç”¨æ¸…å–®");
                btn.innerText = oldText;
                btn.disabled = false;
                return null; // å¤±æ•—å›å‚³ nullï¼Œæœƒè‡ªå‹•åˆ‡æ›å›å…§å»ºæ¸…å–®
            }
        }

        // --- ä¿®æ­£ç‰ˆï¼šé–‹å§‹éŠæˆ² (æ•´åˆéš¨æ©Ÿå¯¶å¯å¤¢ API) ---
        async function startGame() {
            gameState.maxRounds = parseInt(document.getElementById('round-select').value);
            gameState.selectedTheme = document.getElementById('theme-select').value;
            gameState.bpm = parseInt(document.getElementById('bpm-input').value);
            gameState.offset = parseFloat(document.getElementById('offset-input').value);
            gameState.interval = parseFloat(document.getElementById('interval-input').value);
            gameState.introSeconds = parseFloat(document.getElementById('intro-seconds-input').value);
            gameState.playbackRate = parseFloat(document.getElementById('rate-input').value);
            gameState.hintMode = document.getElementById('hint-mode').value;
            gameState.uniqueCount = parseInt(document.getElementById('unique-count').value);
            
            gameState.round = 0; gameState.abortController = new AbortController(); gameState.history = [];
            
            let theme = gameState.selectedTheme;
            
            // è™•ç†éš¨æ©Ÿä¸»é¡Œé‚è¼¯
            if(theme === 'random_locked') theme = getRandomTheme();

            // â˜…â˜…â˜… é—œéµä¿®æ”¹å€å¡Šï¼šå¦‚æœæ˜¯å¯¶å¯å¤¢ï¼Œç›´æ¥å¾ API æŠ“æ–°çš„ â˜…â˜…â˜…
            if (theme === 'pokemon') {
                // å˜—è©¦å¾ API æŠ“ 8 éš»æ–°çš„
                // å¦‚æœæŠ“å¤±æ•— (ä¾‹å¦‚æ²’ç¶²è·¯)ï¼Œæœƒå›å‚³ nullï¼Œé‚£å°±è·‘ä¸‹é¢çš„ initPool ç”¨å…§å»ºçš„
                const apiPool = await fetchRandomPokemonPool(8);
                if (apiPool) {
                    gameState.activePool = apiPool;
                } else {
                    gameState.activePool = initPool('pokemon');
                }
            } else if (theme !== 'random_mixed' && theme !== 'random_round') {
                // å…¶ä»–æ™®é€šä¸»é¡Œ
                gameState.activePool = initPool(theme);
            }
            // â˜…â˜…â˜… ä¿®æ”¹çµæŸ â˜…â˜…â˜…

            gameState.currentRunTheme = theme;

            bgmAudio.muted = gameState.isMuted;
            if(bgmAudio.src) { try { bgmAudio.volume=0; await bgmAudio.play(); bgmAudio.pause(); bgmAudio.currentTime=0; if(!gameState.isMuted) bgmAudio.volume=1; } catch(e){} }

            document.getElementById('home-screen').style.display='none';
            document.getElementById('end-screen').style.display='none';
            document.getElementById('game-screen').style.display='flex';
            document.getElementById('total-rounds').innerText = gameState.maxRounds;
            
            startRec(); 
            runLoop();
        }

        function initPool(t) {
            let pool = [];
            if(t==='flags') pool = flagsData.map(f=>({content:`https://flagcdn.com/w640/${f.c}.png`, label:f.n}));
            else if(t.startsWith('search_')) pool = searchData[t].images.map(i=>({content:i.url, label:i.label}));
            else if(commonData[t]) pool = commonData[t].map(i=>({content:i.u||i.c||i, label:i.n||i}));
            
            if(pool.length>0 && pool.length<8) { while(pool.length<8) pool = pool.concat(pool); }
            const uCount = gameState.uniqueCount || 8;
            const unique = pool.sort(()=>0.5-Math.random()).slice(0, uCount);
            let final = [];
            while(final.length<8) final = final.concat(unique);
            return final.slice(0,8);
        }

        function getRandomTheme() {
            let keys = ['flags','animals','colors','numbers'];
            for(let k in searchData) keys.push(k);
            return keys[Math.floor(Math.random()*keys.length)];
        }

        async function runLoop() {
            try {
                bgmAudio.playbackRate = gameState.playbackRate;
                while(gameState.round < gameState.maxRounds) {
                    gameState.round++;
                    document.getElementById('current-round').innerText = gameState.round;
                    
                    if(bgmAudio.src) {
                        bgmAudio.currentTime = (gameState.offset<0) ? 0 : gameState.offset;
                        if(gameState.offset<0) await wait(Math.abs(gameState.offset)*1000);
                        bgmAudio.play().catch(e=>{});
                    }

                    let items = [];
                    if(gameState.currentRunTheme==='random_mixed') {
                        for(let i=0; i<8; i++) items.push(initPool(getRandomTheme())[0]);
                    } else if(gameState.currentRunTheme==='random_round') {
                        items = initPool(getRandomTheme());
                    } else {
                        items = [...gameState.activePool].sort(()=>0.5-Math.random());
                    }
                    gameState.history.push({round:gameState.round, items:items});

                    const grid = document.getElementById('grid-container');
                    grid.innerHTML = '';
                    let showHint = (gameState.hintMode==='always' || (gameState.hintMode==='first' && gameState.round===1));

                    items.forEach(obj => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        if(showHint) card.classList.add('show-hint');
                        
                        const isImg = (typeof obj.content==='string' && (obj.content.startsWith('http') || obj.content.startsWith('data:')));
                        
                        let html = '';
                        if(obj.content && obj.content.startsWith && obj.content.startsWith('#')) {
                            card.style.backgroundColor = obj.content; 
                        } else if(isImg) {
                            card.classList.add('contain-img');
                            html = `<img src="${obj.content}">`;
                        } else {
                            html = `<div style="font-size:3rem;">${obj.content}</div>`;
                        }
                        
                        card.innerHTML = `${html}<div class="answer-label">${obj.label}</div>`;
                        grid.appendChild(card);
                    });

                    if(gameState.introSeconds>0) await wait(gameState.introSeconds*1000);
                    
                    const beat = (60000/gameState.bpm)/gameState.playbackRate;
                    const cards = document.querySelectorAll('.card');
                    for(let i=0; i<8; i++) {
                        if(i>0) cards[i-1].classList.remove('active');
                        cards[i].classList.add('active');
                        await wait(beat);
                    }
                    if(cards.length>0) cards[7].classList.remove('active');

                    if(bgmAudio.src) bgmAudio.pause();
                    if(gameState.round < gameState.maxRounds) await wait(gameState.interval*1000);
                }
                showEnd();
            } catch(e) { if(e.message!=='Abort') console.error(e); }
        }

        // --- ä¿®æ­£ç‰ˆï¼šç­‰å¾…å‡½å¼ (æ”¯æ´æš«åœèˆ‡ä¸­æ–·) ---
        function wait(ms) {
            return new Promise((resolve, reject) => {
                let elapsed = 0;
                const checkInterval = 50; // æ¯ 50 æ¯«ç§’æª¢æŸ¥ä¸€æ¬¡ç‹€æ…‹
                
                const timerId = setInterval(() => {
                    // 1. å¦‚æœæŒ‰ä¸‹é¦–é éµ (Abort)ï¼Œç›´æ¥åœæ­¢ä¸¦å ±éŒ¯é€€å‡º
                    if (gameState.abortController.signal.aborted) {
                        clearInterval(timerId);
                        reject(new Error('Abort'));
                        return;
                    }
                    
                    // 2. å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œå°±ã€Œç©ºè½‰ã€ï¼Œä¸å¢åŠ ç¶“éæ™‚é–“
                    if (gameState.isPaused) {
                        return; 
                    }
                    
                    // 3. æ­£å¸¸è¨ˆæ™‚
                    elapsed += checkInterval;
                    if (elapsed >= ms) {
                        clearInterval(timerId);
                        resolve(); // æ™‚é–“åˆ°ï¼Œç¹¼çºŒå¾€ä¸‹åŸ·è¡Œ
                    }
                }, checkInterval);
            });
        }
        
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const ov = document.getElementById('pause-overlay');
            if(gameState.isPaused) { ov.style.display='flex'; bgmAudio.pause(); }
            else { ov.style.display='none'; bgmAudio.play(); }
        }
        function restartGame() {
            if(gameState.abortController) gameState.abortController.abort();
            bgmAudio.pause();
            setTimeout(startGame, 100);
        }

        function showEnd() {
            stopRec();
            document.getElementById('game-screen').style.display='none';
            document.getElementById('end-screen').style.display='flex';
            const hDiv = document.getElementById('game-history');
            hDiv.innerHTML = '';
            gameState.history.forEach(h => {
                const r = document.createElement('div');
                r.style.marginBottom = "15px";
                r.innerHTML = `<div style="font-weight:bold; color:#ff4757; margin-bottom:5px;">Round ${h.round}</div>`;
                const g = document.createElement('div'); g.className = 'history-grid';
                h.items.forEach(i => {
                    const d = document.createElement('div'); d.className='history-item';
                    const isImg = (typeof i.content==='string' && (i.content.startsWith('http') || i.content.startsWith('data:')));
                    let vis = isImg ? `<img class="history-thumb" src="${i.content}">` : `<div class="history-thumb">${i.content}</div>`;
                    if(i.content.startsWith && i.content.startsWith('#')) vis = `<div class="history-thumb" style="background:${i.content}"></div>`;
                    d.innerHTML = `${vis}<div style="font-size:0.8rem; margin-top:2px;">${i.label}</div>`;
                    g.appendChild(d);
                });
                r.appendChild(g); hDiv.appendChild(r);
            });
        }

        async function startRec() {
            if(document.getElementById('record-toggle').value!=='on') return;
            try {
                const s = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRecorder = new MediaRecorder(s); audioChunks=[];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
            } catch(e){console.error(e);}
        }
        function stopRec() {
            if(mediaRecorder && mediaRecorder.state!=='inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, {type:'audio/webm'});
                    document.getElementById('record-player').src = URL.createObjectURL(blob);
                    document.getElementById('audio-player-container').style.display='block';
                };
            }
        }
    </script>
</body>
</html>

