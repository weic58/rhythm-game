<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯€å¥éŠæˆ² (éŒ„éŸ³+æœå°‹ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #ff4757;
            --secondary-color: #2ed573;
            --accent-color: #54a0ff;
            --bg-color: #f1f2f6;
            --box-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* é€šç”¨æŒ‰éˆ• */
        .icon-btn {
            background: white; border: 2px solid #ddd; width: 50px; height: 50px;
            border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); }

        .btn-primary {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 30px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); transition: 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-action {
            background-color: var(--accent-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: 100%; margin-top: 5px;
        }

        .btn-upload {
            background-color: var(--secondary-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: 100%; margin-top: 5px;
        }

        .btn-test {
            background-color: #a4b0be; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-left: 5px;
        }

        /* ä¸»ç•«é¢ */
        #home-screen {
            text-align: center; position: relative; width: 100%; max-width: 500px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        #settings-trigger { position: absolute; top: -80px; right: 20px; }
        h1 { font-size: 2.5rem; color: #333; margin-bottom: 5px; }

        /* è¨­å®šé¸å–® */
        .theme-selector {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 80%;
        }
        select {
            padding: 10px; font-size: 1.2rem; border-radius: 8px;
            border: 1px solid #ccc; width: 100%; margin-top: 5px;
        }

        /* å½ˆçª— */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 420px; max-height: 85vh; overflow-y: auto;
            position: relative; animation: popUp 0.3s ease;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }

        .control-group {
            margin-bottom: 15px; text-align: left; background: #f8f9fa;
            padding: 12px; border-radius: 10px;
        }
        .control-group label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="range"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; }
        input[type="text"] { border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        
        #file-status { color: #2ed573; font-weight: bold; font-size: 0.85rem; margin-top: 5px; word-break: break-all; }
        #upload-status { font-size: 0.85rem; color: #2ed573; margin-top: 5px; }
        #search-status { font-size: 0.85rem; color: var(--accent-color); margin-top: 5px; font-weight: bold; }

        /* éŠæˆ²ç•«é¢ */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; max-width: 800px; position: relative;
        }
        .top-bar {
            position: absolute; top: -80px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .top-right-controls { display: flex; gap: 10px; }
        #info-bar {
            font-size: 2rem; margin-bottom: 20px; font-weight: 900; color: #555;
            background: white; padding: 5px 20px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #grid-container {
            display: grid; grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 15px; width: 95%; aspect-ratio: 2/1;
        }
        .card {
            background-color: var(--box-bg); border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 4rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 5px solid #eee;
            transition: transform 0.1s; overflow: hidden;
        }
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card.contain-img img { object-fit: contain; width: 90%; height: 90%; }
        .card.chinese-mode { font-family: "Microsoft JhengHei", sans-serif; font-weight: 900; color: #d63031; }
        .card.math-mode { font-family: 'Times New Roman', serif; font-weight: bold; color: #0984e3; }
        .card.active {
            border-color: var(--primary-color) !important; transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.8); z-index: 5;
        }
        .card.active:not(.color-card) { background-color: #ffeaa7; }

        #pause-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50; display: none;
            align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        #pause-overlay h2 { color: white; font-size: 4rem; margin: 0 0 20px 0; }

        /* çµæŸç•«é¢ */
        #end-screen {
            display: none; flex-direction: column; align-items: center; gap: 20px;
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 85%; max-width: 400px;
        }
        
        #audio-player-container {
            width: 100%; background: #f1f2f6; padding: 15px; border-radius: 10px;
            text-align: center; display: none; /* é è¨­éš±è— */
        }
        audio { width: 100%; margin-top: 10px; }

        .hidden { display: none !important; }
        #folder-input { display: none; }
    </style>
</head>
<body>

    <div id="home-screen">
        <button id="settings-trigger" class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
        <h1>ğŸµ ç¯€å¥éŠæˆ²</h1>
        
        <div class="theme-selector">
            <label style="font-weight:bold; color:#555;">é¸æ“‡ä¸»é¡Œ</label>
            <select id="theme-select" onchange="saveSettings()">
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
                
                <optgroup label="ğŸ” è‡ªè¨‚æœå°‹">
                    </optgroup>

                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>
            </select>
        </div>

        <div class="theme-selector" style="margin-top:10px;">
            <label style="font-weight:bold; color:#555;">ç¸½å›åˆæ•¸</label>
            <select id="round-select" onchange="saveSettings()">
                <option value="3">3 å›åˆ</option>
                <option value="5">5 å›åˆ</option>
                <option value="10">10 å›åˆ</option>
                <option value="999">ç„¡é™ç·´ç¿’</option>
            </select>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:200px;" onclick="startGame()">START</button>
    </div>

    <div id="settings-modal" onclick="closeSettings(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
                <button class="close-btn" onclick="closeSettingsBtn()">âœ•</button>
            </div>

            <div class="control-group" style="border: 2px solid #54a0ff; background: #f0f8ff;">
                <label style="color:#54a0ff;">ğŸ” æœå°‹ä¸¦å»ºç«‹ä¸»é¡Œ</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: Batman)">
                    <button class="btn-action" style="width:auto; margin:0;" onclick="createSearchTheme()">æœå°‹</button>
                </div>
                <div id="search-status">è¼¸å…¥è‹±æ–‡é—œéµå­—æ•ˆæœè¼ƒå¥½</div>
            </div>

            <div class="control-group" style="border: 2px dashed #2ed573; background: #eafff2;">
                <label>ğŸ“‚ ä¸Šå‚³è‡ªè¨‚ä¸»é¡Œè³‡æ–™å¤¾</label>
                <input type="file" id="folder-input" webkitdirectory directory multiple>
                <button class="btn-upload" onclick="document.getElementById('folder-input').click()">
                    é»æ“Šé¸æ“‡è³‡æ–™å¤¾...
                </button>
                <div id="upload-status">å¯é¸å–å«åœ–ç‰‡çš„è³‡æ–™å¤¾ (åç¨±å³ä¸»é¡Œ)</div>
            </div>

            <div class="control-group">
                <label>ğŸµ èƒŒæ™¯éŸ³æ¨‚</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size:0.85rem; color:#666;">1. ä¸Šå‚³æª”æ¡ˆ (MP3/WAV):</label>
                    <input type="file" id="music-file">
                </div>
                <div>
                    <label style="font-size:0.85rem; color:#666;">2. æˆ– Google Drive é€£çµ:</label>
                    <input type="text" id="drive-input" placeholder="https://drive.google.com/..." oninput="handleDriveLink(this.value)">
                </div>
                <div style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                    <span id="file-status">æœªé¸æ“‡æª”æ¡ˆ</span>
                    <button class="btn-test" onclick="testAudio()">ğŸ”Š è©¦è½</button>
                </div>
            </div>

            <div class="control-group">
                <label>ğŸ™ï¸ éŠæˆ²éŒ„éŸ³ (çµæŸå¾Œå›æ”¾):</label>
                <select id="record-toggle" onchange="saveSettings()">
                    <option value="off">é—œé–‰</option>
                    <option value="on">é–‹å•Ÿ (éœ€éº¥å…‹é¢¨æ¬Šé™)</option>
                </select>
                <small style="color:#888;">*æˆ´è€³æ©Ÿæ•ˆæœæœ€ä½³ï¼Œé¿å…éŒ„åˆ°èƒŒæ™¯éŸ³æ¨‚</small>
            </div>

            <div class="control-group">
                <label>ğŸ¢â© éŸ³æ¨‚å€é€Ÿ: <span id="rate-display" style="color:#e056fd;">1.0</span>x</label>
                <input type="range" id="rate-input" min="0.5" max="2.0" step="0.1" value="1.0" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â±ï¸ åŸæ›²é€Ÿåº¦ (BPM): <span id="bpm-display" style="color:var(--primary-color);">165</span></label>
                <input type="range" id="bpm-input" min="60" max="180" value="165" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â¯ï¸ éŸ³æ¨‚èµ·é» (ç§’):</label>
                <input type="number" id="offset-input" value="0" step="0.1" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â³ éŸ³æ¨‚å¾Œç­‰å¾… (ç§’):</label>
                <input type="number" id="intro-seconds-input" value="2.4" step="0.1" placeholder="ä¾‹å¦‚: 2.5" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>ğŸ›Œ å›åˆé–“éš” (ç§’):</label>
                <input type="range" id="interval-input" min="0" max="5" value="0" step="0.5" oninput="saveSettings()">
                <div style="text-align:right; font-weight:bold; color:#555;"><span id="interval-display">0</span> ç§’</div>
            </div>
            
            <button class="btn-primary" style="width:100%; font-size:1rem;" onclick="closeSettingsBtn()">å®Œæˆ</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goHome()" title="å›é¦–é ">ğŸ </button>
            <div class="top-right-controls">
                <button class="icon-btn" id="pause-btn" onclick="togglePause()" title="æš«åœ">â¸</button>
                <button class="icon-btn" onclick="restartGame()" title="é‡ç½®">ğŸ”„</button>
            </div>
        </div>
        <div id="info-bar">Round <span id="current-round">1</span> / <span id="total-rounds">3</span></div>
        <div id="grid-container"></div>
    </div>

    <div id="pause-overlay">
        <h2>PAUSED</h2>
        <button class="btn-primary" style="width: 200px;" onclick="togglePause()">ç¹¼çºŒ</button>
    </div>

    <div id="end-screen">
        <h1>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h1>
        
        <div id="audio-player-container">
            <h3>ğŸ™ï¸ ä½ çš„è¡¨ç¾å›æ”¾</h3>
            <audio id="record-player" controls></audio>
            <div style="font-size:0.8rem; color:#666; margin-top:5px;">(è½è½çœ‹æœ‰æ²’æœ‰å°åœ¨æ‹å­ä¸Šï¼)</div>
        </div>

        <div style="display:flex; gap:20px;">
            <button class="icon-btn" onclick="goHome()">ğŸ </button>
            <button class="btn-primary" onclick="restartGame()">å†ä¾†ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // è³‡æ–™åº«
        const commonData = {
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'],
            numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#000000', '#ffffff', '#ff00ff', '#00ffff', '#808080', '#ffa500'],
            math: ['+','-','Ã—','Ã·','=','â‰ ','â‰ˆ','>','<','Ï€','âˆš','âˆ','âˆ«','âˆ†','âˆ‘','Î©'],
            food: [
                'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&q=80',
                'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&q=80',
                'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=400&q=80',
                'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80',
                'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=400&q=80',
                'https://images.unsplash.com/photo-1529042410759-befb1204b468?w=400&q=80',
                'https://images.unsplash.com/photo-1551024709-8f23befc6f87?w=400&q=80',
                'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&q=80'
            ]
        };

        const chineseGroups = {
            'shi': ['æ˜¯','äº‹','ä¸–','å¸‚','å¼','è©¦','å£«','ç¤º','è¦–','èª“','æ–½','æ¿•','ç…','å¤±','å²','ä½¿','å§‹','çŸ³','é£Ÿ','å','å¯¦'],
            'ji': ['æ©Ÿ','é›','åŸº','ç©','ç¸¾','è·¡','æ¿€','æ¥µ','æ€¥','å‰','å³','é›†','æ“Š','è¨ˆ','è¨˜','å­£','æŠ€','æ—¢','æ¿Ÿ','ç¹¼'],
            'yi': ['ä¸€','é†«','è¡£','ä¾','ä¼Š','ç§»','ç–‘','å„€','å®œ','éº','ä¹™','å·²','ä»¥','èŸ»','å€š','æ„','ç¾©','è­°','ç›Š','è—'],
            'fu': ['å¤«','è†š','ç¦','æœ','å¹…','åºœ','çˆ¶','ä»˜','è² ','å©¦','å¯Œ','å‰¯','å¾©','è…¹','è¦†','æµ®','æ‰¶','ç¬¦'],
            'yu': ['é­š','æ¼','æ–¼','é¤˜','å¨›','æ„š','é›¨','èˆ‡','äºˆ','èª','ç¾½','ç‰','è‚²','é ','é‡','æ¬²','ç„','åŸŸ']
        };

        let customData = {}; // æœ¬åœ°è³‡æ–™å¤¾åœ–ç‰‡
        let searchData = {}; // æœå°‹çš„åœ–ç‰‡

        let gameState = {
            round: 0, maxRounds: 3, theme: 'pokemon', bpm: 165,
            offset: 0, interval: 0, introSeconds: 2.4, playbackRate: 1.0, 
            isPaused: false, abortController: null, selectedTheme: 'pokemon',
            isRecording: false, lockedTheme: null
        };

        let audioCtx;
        let bgmAudio = new Audio();
        bgmAudio.preload = "auto"; 
        
        // éŒ„éŸ³ç›¸é—œè®Šæ•¸
        let mediaRecorder;
        let audioChunks = [];

        // --- 1. æœå°‹åŠŸèƒ½ (Pollinations AI) ---
        function createSearchTheme() {
            const keyword = document.getElementById('search-input').value.trim();
            if (!keyword) return;

            const themeKey = "search_" + keyword;
            searchData[themeKey] = [];

            // ç”¢ç”Ÿ 8 å€‹å¸¶éš¨æ©Ÿæ•¸ç¨®çš„ URLï¼Œè®“ AI ç”Ÿæˆè©²é—œéµå­—çš„ä¸åŒåœ–ç‰‡
            for (let i = 0; i < 8; i++) {
                // Pollinations URL æ ¼å¼: https://image.pollinations.ai/prompt/{keyword} {seed}
                const seed = Math.floor(Math.random() * 1000);
                // encodeURIComponent ç¢ºä¿ä¸­æ–‡æˆ–ç©ºæ ¼è¢«æ­£ç¢ºè™•ç†
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(keyword)}%20${seed}?nologo=true`;
                searchData[themeKey].push(url);
            }

            updateThemeSelect();
            // è‡ªå‹•é¸ä¸­å‰›å»ºç«‹çš„ä¸»é¡Œ
            document.getElementById('theme-select').value = themeKey;
            saveSettings();
            document.getElementById('search-status').innerText = `âœ… å·²å»ºç«‹ä¸»é¡Œ: ${keyword}`;
        }

        // --- 2. è³‡æ–™å¤¾ & éŸ³æ¨‚é¸å– ---
        document.getElementById('folder-input').addEventListener('change', function(e) {
            const files = e.target.files;
            let count = 0;
            customData = {}; 
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;
                const pathParts = file.webkitRelativePath.split('/');
                let themeName = (pathParts.length > 1) ? pathParts[pathParts.length - 2] : "è‡ªè¨‚ç›¸ç°¿";
                if (!customData[themeName]) customData[themeName] = [];
                customData[themeName].push(URL.createObjectURL(file));
                count++;
            }
            updateThemeSelect();
            document.getElementById('upload-status').innerText = `âœ… æˆåŠŸè¼‰å…¥ ${Object.keys(customData).length} å€‹ä¸»é¡Œï¼Œå…± ${count} å¼µåœ–ç‰‡`;
        });

        document.getElementById('music-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('drive-input').value = "";
            document.getElementById('file-status').innerText = `âŒ› è®€å–ä¸­...`;

            const reader = new FileReader();
            reader.onload = function(evt) {
                bgmAudio.src = evt.target.result;
                bgmAudio.load();
                document.getElementById('file-status').innerText = `âœ… æœ¬åœ°æª”æ¡ˆ: ${file.name}`;
            };
            reader.onerror = function() { alert("è®€å–å¤±æ•—"); };
            reader.readAsDataURL(file);
            this.value = ''; 
        });

        function handleDriveLink(url) {
            if (!url) return;
            let id = "";
            const parts = url.match(/[-\w]{25,}/);
            if (parts) id = parts[0];
            if (id) {
                const directUrl = `https://drive.google.com/uc?export=download&id=${id}`;
                bgmAudio.src = directUrl;
                bgmAudio.load();
                document.getElementById('file-status').innerText = `â˜ï¸ Drive ID: ${id.substring(0,5)}...`;
                document.getElementById('music-file').value = "";
                localStorage.setItem('rg_drive_url', url);
            }
        }

        function testAudio() {
            if (!bgmAudio.src) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
            bgmAudio.volume = 1.0;
            bgmAudio.playbackRate = parseFloat(document.getElementById('rate-input').value);
            
            const playPromise = bgmAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    document.getElementById('file-status').innerText += " (æ’­æ”¾ä¸­)";
                    setTimeout(() => { bgmAudio.pause(); bgmAudio.currentTime = 0; }, 3000); 
                })
                .catch(error => {
                    alert(`æ’­æ”¾å¤±æ•— (Error: ${error.name})\nè«‹ç¢ºèªï¼š\n1. æ‰‹æ©ŸæœªéœéŸ³\n2. æª”æ¡ˆéæå£`);
                });
            }
        }

        // --- 3. UI æ§åˆ¶ ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettingsBtn() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeSettings(e) { if(e.target.id === 'settings-modal') closeSettingsBtn(); }

        function saveSettings() {
            localStorage.setItem('rg_theme', document.getElementById('theme-select').value);
            localStorage.setItem('rg_rounds', document.getElementById('round-select').value);
            localStorage.setItem('rg_bpm', document.getElementById('bpm-input').value);
            localStorage.setItem('rg_offset', document.getElementById('offset-input').value);
            localStorage.setItem('rg_intro', document.getElementById('intro-seconds-input').value);
            localStorage.setItem('rg_interval', document.getElementById('interval-input').value);
            localStorage.setItem('rg_rate', document.getElementById('rate-input').value);
            localStorage.setItem('rg_record', document.getElementById('record-toggle').value);
            
            document.getElementById('bpm-display').innerText = document.getElementById('bpm-input').value;
            document.getElementById('interval-display').innerText = document.getElementById('interval-input').value;
            document.getElementById('rate-display').innerText = document.getElementById('rate-input').value;
        }

        function loadSettings() {
            const s = localStorage;
            if(s.getItem('rg_rounds')) document.getElementById('round-select').value = s.getItem('rg_rounds');
            if(s.getItem('rg_bpm')) {
                document.getElementById('bpm-input').value = s.getItem('rg_bpm');
                document.getElementById('bpm-display').innerText = s.getItem('rg_bpm');
            }
            if(s.getItem('rg_offset')) document.getElementById('offset-input').value = s.getItem('rg_offset');
            if(s.getItem('rg_intro')) document.getElementById('intro-seconds-input').value = s.getItem('rg_intro');
            if(s.getItem('rg_interval')) {
                document.getElementById('interval-input').value = s.getItem('rg_interval');
                document.getElementById('interval-display').innerText = s.getItem('rg_interval');
            }
            if(s.getItem('rg_rate')) {
                document.getElementById('rate-input').value = s.getItem('rg_rate');
                document.getElementById('rate-display').innerText = s.getItem('rg_rate');
            }
            if(s.getItem('rg_record')) document.getElementById('record-toggle').value = s.getItem('rg_record');
            if(s.getItem('rg_drive_url')) {
                document.getElementById('drive-input').value = s.getItem('rg_drive_url');
                handleDriveLink(s.getItem('rg_drive_url'));
            }
        }

        function updateThemeSelect() {
            const select = document.getElementById('theme-select');
            
            // ä¿ç•™çš„å›ºå®šé¸é … (éš¨æ©Ÿç³»åˆ—)
            select.innerHTML = `
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
            `;

            // æœå°‹çµæœå€ (æ–°)
            const searchGroup = document.createElement('optgroup');
            searchGroup.label = "ğŸ” è‡ªè¨‚æœå°‹çµæœ";
            for (let theme in searchData) {
                const opt = document.createElement('option');
                opt.value = theme;
                opt.innerText = `ğŸ” ${theme.replace('search_', '')}`;
                searchGroup.appendChild(opt);
            }
            select.appendChild(searchGroup);

            // æœ¬åœ°è³‡æ–™å¤¾
            if (Object.keys(customData).length > 0) {
                const group = document.createElement('optgroup');
                group.label = "ğŸ“‚ æœ¬åœ°è³‡æ–™å¤¾";
                for (let theme in customData) {
                    if (customData[theme].length > 0) {
                        const opt = document.createElement('option');
                        opt.value = "custom_" + theme;
                        opt.innerText = `ğŸ“ ${theme} (${customData[theme].length}å¼µ)`;
                        group.appendChild(opt);
                    }
                }
                select.appendChild(group);
            }

            // éœæ…‹é¸é …
            select.innerHTML += `
                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>
            `;
            
            const lastTheme = localStorage.getItem('rg_theme');
            if (lastTheme && select.querySelector(`option[value="${lastTheme}"]`)) {
                select.value = lastTheme;
            }
        }

        window.addEventListener('load', async () => {
            loadSettings();
            updateThemeSelect();
        });

        // --- 4. éŒ„éŸ³åŠŸèƒ½ ---
        async function startRecording() {
            if (document.getElementById('record-toggle').value !== 'on') return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.start();
                gameState.isRecording = true;
            } catch (err) {
                console.error("Mic Error:", err);
                alert("ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™ã€‚\n(å¦‚æœæ˜¯åœ¨ App å…§ç€è¦½å™¨é–‹å•Ÿï¼Œè«‹æ”¹ç”¨ Chrome/Safari)");
                document.getElementById('record-toggle').value = 'off';
            }
        }

        function stopRecording() {
            if (gameState.isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // webm åœ¨ Chrome/Android æ”¯æ´å¥½
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const player = document.getElementById('record-player');
                    player.src = audioUrl;
                    document.getElementById('audio-player-container').style.display = 'block';
                };
                gameState.isRecording = false;
            }
        }

        // --- 5. éŠæˆ²æ ¸å¿ƒ ---
        class SmartTimer {
            constructor(callback, delay) {
                this.remaining = delay; this.callback = callback;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), delay);
            }
            pause() {
                window.clearTimeout(this.timerId); this.timerId = null;
                this.remaining -= Date.now() - this.start;
            }
            resume() {
                if (this.timerId) return;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), this.remaining);
            }
            finish() { this.callback(); }
        }

        function wait(ms) {
            if (ms <= 0) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const timer = new SmartTimer(resolve, ms);
                if (!window.currentTimers) window.currentTimers = [];
                window.currentTimers.push(timer);
                if (gameState.abortController.signal.aborted) reject(new Error("Aborted"));
                gameState.abortController.signal.addEventListener('abort', () => {
                    window.clearTimeout(timer.timerId); reject(new Error("Aborted"));
                });
            });
        }

        async function startGame() {
            gameState.maxRounds = parseInt(document.getElementById('round-select').value);
            gameState.selectedTheme = document.getElementById('theme-select').value;
            gameState.bpm = parseInt(document.getElementById('bpm-input').value);
            gameState.offset = parseFloat(document.getElementById('offset-input').value);
            gameState.interval = parseFloat(document.getElementById('interval-input').value);
            gameState.introSeconds = parseFloat(document.getElementById('intro-seconds-input').value) || 0;
            gameState.playbackRate = parseFloat(document.getElementById('rate-input').value) || 1.0;
            gameState.round = 0;
            gameState.abortController = new AbortController();
            gameState.lockedTheme = null; // é‡ç½®é–å®šä¸»é¡Œ
            window.currentTimers = [];

            // è™•ç†ã€Œéš¨æ©Ÿ(æ•´å±€é–å®š)ã€é‚è¼¯
            if (gameState.selectedTheme === 'random_locked') {
                const allT = getAllThemes().filter(t => !t.startsWith('random')); // æ’é™¤éš¨æ©Ÿé¸é …
                gameState.lockedTheme = allT[Math.floor(Math.random() * allT.length)];
            }

            // Audio Unlock
            if (bgmAudio.src) {
                try {
                    bgmAudio.volume = 0; 
                    await bgmAudio.play();
                    bgmAudio.pause();
                    bgmAudio.currentTime = 0;
                    bgmAudio.volume = 1; 
                } catch (e) { console.log("Unlock failed"); }
            }

            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('audio-player-container').style.display = 'none'; // éš±è—æ’­æ”¾å™¨
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('total-rounds').innerText = gameState.maxRounds;

            // å•Ÿå‹•éŒ„éŸ³
            startRecording();

            runGameLoop();
        }

        function getItem(theme) {
            // æœå°‹çµæœ
            if (theme.startsWith('search_')) {
                const pool = searchData[theme];
                if (pool) return pool[Math.floor(Math.random() * pool.length)];
            }
            // æœ¬åœ°
            if (theme.startsWith('custom_')) {
                const real = theme.replace('custom_', '');
                if (customData[real]) return customData[real][Math.floor(Math.random() * customData[real].length)];
            }
            if (theme === 'pokemon') {
                const id = Math.floor(Math.random() * 151) + 1;
                return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
            }
            if (theme === 'robots') {
                const txt = Math.random().toString(36).substring(7);
                return `https://robohash.org/${txt}?set=set1`;
            }
            if (theme === 'chinese_phonetic') {
                const keys = Object.keys(chineseGroups);
                const k = keys[Math.floor(Math.random() * keys.length)];
                return chineseGroups[k][Math.floor(Math.random() * chineseGroups[k].length)];
            }
            if (commonData[theme]) return commonData[theme][Math.floor(Math.random() * commonData[theme].length)];
            return "ğŸ¶";
        }

        function getAllThemes() {
            let t = ['pokemon', 'robots', 'food', 'math', 'chinese_phonetic', 'animals', 'numbers', 'colors'];
            for (let k in customData) t.push('custom_' + k);
            for (let k in searchData) t.push(k);
            return t;
        }

        async function runGameLoop() {
            try {
                bgmAudio.playbackRate = gameState.playbackRate;

                while (gameState.round < gameState.maxRounds) {
                    gameState.round++;
                    document.getElementById('current-round').innerText = gameState.round;
                    
                    let curTheme = gameState.selectedTheme;
                    const allT = getAllThemes();

                    // ä¸»é¡Œé¸æ“‡é‚è¼¯
                    if (gameState.selectedTheme === 'random_locked') {
                        curTheme = gameState.lockedTheme; // ä½¿ç”¨éŠæˆ²é–‹å§‹æ™‚é–å®šçš„ä¸»é¡Œ
                    } else if (gameState.selectedTheme === 'random_round') {
                        curTheme = allT[Math.floor(Math.random() * allT.length)];
                    }

                    if (bgmAudio.src) {
                        if (gameState.offset < 0) {
                            bgmAudio.currentTime = 0;
                            await wait(Math.abs(gameState.offset) * 1000);
                            bgmAudio.play().catch(e=>console.log(e));
                        } else {
                            bgmAudio.currentTime = gameState.offset;
                            bgmAudio.play().catch(e=>console.log(e));
                        }
                    }

                    const grid = document.getElementById('grid-container');
                    grid.innerHTML = '';
                    let items = [];

                    if (gameState.selectedTheme === 'random_mixed') {
                        for(let i=0; i<8; i++) {
                            const rt = allT[Math.floor(Math.random() * allT.length)];
                            items.push({ val: getItem(rt), theme: rt });
                        }
                    } else {
                        // å–®ä¸€ä¸»é¡Œ
                        if (curTheme === 'chinese_phonetic') {
                            const keys = Object.keys(chineseGroups);
                            const k = keys[Math.floor(Math.random() * keys.length)];
                            const slice = chineseGroups[k].sort(() => 0.5 - Math.random()).slice(0, 8);
                            items = slice.map(v => ({ val: v, theme: curTheme }));
                        } else if (curTheme.startsWith('custom_')) {
                            const real = curTheme.replace('custom_', '');
                            const pool = customData[real];
                            for(let i=0; i<8; i++) items.push({ val: pool[Math.floor(Math.random()*pool.length)], theme: curTheme });
                        } else if (curTheme.startsWith('search_')) {
                            const pool = searchData[curTheme];
                            for(let i=0; i<8; i++) items.push({ val: pool[Math.floor(Math.random()*pool.length)], theme: curTheme });
                        } else if (['pokemon','robots'].includes(curTheme)) {
                            for(let i=0; i<8; i++) items.push({ val: getItem(curTheme), theme: curTheme });
                        } else {
                            const pool = commonData[curTheme] || commonData['animals'];
                            const slice = [...pool].sort(()=>0.5-Math.random()).slice(0,8);
                            items = slice.map(v => ({ val: v, theme: curTheme }));
                        }
                    }

                    items.forEach(obj => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        const isUrl = typeof obj.val === 'string' && (obj.val.startsWith('http') || obj.val.startsWith('blob:'));
                        
                        if (isUrl) {
                            card.classList.add('contain-img');
                            card.innerHTML = `<img src="${obj.val}">`;
                        } else if (obj.theme === 'colors') {
                            card.classList.add('color-card');
                            card.style.backgroundColor = obj.val;
                            if(obj.val === '#ffffff') card.style.borderColor = '#ddd';
                        } else {
                            card.innerText = obj.val;
                            if(obj.theme === 'numbers') card.classList.add('number-mode');
                            if(obj.theme === 'math') card.classList.add('math-mode');
                            if(obj.theme === 'chinese_phonetic') card.classList.add('chinese-mode');
                        }
                        grid.appendChild(card);
                    });

                    if (gameState.introSeconds > 0) await wait(gameState.introSeconds * 1000);

                    const msPerBeat = (60000 / gameState.bpm) / gameState.playbackRate;
                    const cards = document.querySelectorAll('.card');
                    for (let i = 0; i < 8; i++) {
                        if (i>0) cards[i-1].classList.remove('active');
                        cards[i].classList.add('active');
                        await wait(msPerBeat);
                    }
                    if(cards.length>0) cards[7].classList.remove('active');

                    if (bgmAudio.src) bgmAudio.pause();
                    if (gameState.round < gameState.maxRounds) await wait(gameState.interval * 1000);
                }
                showEndScreen();
            } catch (error) {
                if (error.message !== "Aborted") console.error(error);
            }
        }

        function showEndScreen() {
            stopRecording(); // åœæ­¢éŒ„éŸ³
            bgmAudio.pause();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('home-screen').classList.add('hidden');
        }

        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const overlay = document.getElementById('pause-overlay');
            const btn = document.getElementById('pause-btn');
            if (gameState.isPaused) {
                overlay.style.display = 'flex'; btn.innerText = 'â–¶ï¸';
                bgmAudio.pause(); 
                if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.pause();
                window.currentTimers.forEach(t => t.pause());
            } else {
                overlay.style.display = 'none'; btn.innerText = 'â¸';
                bgmAudio.play(); 
                if(mediaRecorder && mediaRecorder.state === 'paused') mediaRecorder.resume();
                window.currentTimers.forEach(t => t.resume());
            }
        }

        function resetLogic() {
            if (gameState.abortController) gameState.abortController.abort();
            bgmAudio.pause(); gameState.isPaused = false;
            stopRecording();
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('pause-btn').innerText = 'â¸';
        }

        function restartGame() { resetLogic(); setTimeout(startGame, 100); }
        function goHome() {
            resetLogic();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('home-screen').style.display = 'flex';
        }
    </script>
</body>
</html>
