<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¯€å¥éŠæˆ² Plus</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    <style>
        :root {
            --primary-color: #ff4757;
            --secondary-color: #2ed573;
            --accent-color: #54a0ff;
            --danger-color: #ff6b6b;
            --bg-color: #f1f2f6;
            --box-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* é€šç”¨æŒ‰éˆ• */
        .icon-btn {
            background: white; border: 2px solid #ddd; width: 50px; height: 50px;
            border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); }

        .btn-primary {
            background-color: var(--primary-color); color: white; border: none;
            padding: 12px 30px; border-radius: 30px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4); transition: 0.2s;
        }
        .btn-primary:hover { transform: translateY(-2px); }

        .btn-action {
            background-color: var(--accent-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: auto; flex-shrink: 0;
        }

        .btn-upload {
            background-color: var(--secondary-color); color: white; border: none;
            padding: 8px 15px; border-radius: 8px; font-size: 0.95rem; font-weight: bold;
            cursor: pointer; width: 100%; margin-top: 5px;
        }

        .btn-test {
            background-color: #a4b0be; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; font-size: 0.9rem; cursor: pointer; margin-left: 5px;
        }

        /* é è¦½å€çš„å°æŒ‰éˆ•ç¾¤ (æ¢å¾©æ­¤æ¨£å¼) */
        .preview-actions {
            position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 10;
        }
        .btn-mini {
            color: white; border: none; border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .btn-swap { background: rgba(84, 160, 255, 0.9); }
        .btn-remove { background: rgba(255, 107, 107, 0.9); }
        .btn-mini:hover { transform: scale(1.1); }

        /* ä¸»ç•«é¢ */
        #home-screen {
            text-align: center; position: relative; width: 100%; max-width: 500px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        #settings-trigger { position: absolute; top: -80px; right: 20px; }
        #mute-home { position: absolute; top: -80px; left: 20px; }
        
        h1 { font-size: 2.5rem; color: #333; margin-bottom: 5px; }

        /* è¨­å®šé¸å–® */
        .theme-selector {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 80%;
        }
        select {
            padding: 10px; font-size: 1.2rem; border-radius: 8px;
            border: 1px solid #ccc; width: 100%; margin-top: 5px;
        }

        /* å½ˆçª— */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto;
            position: relative; animation: popUp 0.3s ease;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }

        .control-group {
            margin-bottom: 15px; text-align: left; background: #f8f9fa;
            padding: 12px; border-radius: 10px;
        }
        .control-group label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="range"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; }
        input[type="text"] { border: 1px solid #ccc; border-radius: 5px; padding: 8px; }
        
        #file-status { color: #2ed573; font-weight: bold; font-size: 0.85rem; margin-top: 5px; word-break: break-all; }
        #upload-status { font-size: 0.85rem; color: #2ed573; margin-top: 5px; }
        #search-status { font-size: 0.85rem; color: var(--accent-color); margin-top: 5px; font-weight: bold; }

        /* é è¦½å€åŸŸ */
        #preview-area {
            display: none; margin-top: 10px;
            background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px;
        }
        #preview-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px;
        }
        .preview-item { position: relative; border: 1px solid #eee; border-radius: 4px; overflow: hidden; background: #f9f9f9; aspect-ratio: 1; }
        .preview-img {
            width: 100%; height: 100%; object-fit: contain; display: block;
        }
        .preview-label {
            position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6);
            color: white; font-size: 0.6rem; text-align: center; overflow: hidden; white-space: nowrap; padding: 2px 0;
        }
        .preview-controls { display: flex; gap: 10px; justify-content: flex-end; }

        /* éŠæˆ²ç•«é¢ */
        #game-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; max-width: 800px; position: relative;
        }
        .top-bar {
            position: absolute; top: -80px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .top-right-controls { display: flex; gap: 10px; }
        #info-bar {
            font-size: 2rem; margin-bottom: 20px; font-weight: 900; color: #555;
            background: white; padding: 5px 20px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #grid-container {
            display: grid; grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr); gap: 15px; width: 95%; aspect-ratio: 2/1;
        }
        .card {
            background-color: var(--box-bg); border-radius: 12px; display: flex;
            align-items: center; justify-content: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 5px solid #eee;
            transition: transform 0.1s; overflow: hidden; position: relative;
            flex-direction: column; 
        }
        
        .card-content {
            flex: 1; width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center; overflow: hidden;
            font-size: 4rem; 
        }
        
        .card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card.contain-img img { object-fit: contain; width: 90%; height: 90%; }
        
        .card.chinese-mode .card-content { font-family: "Microsoft JhengHei", sans-serif; font-weight: 900; color: #d63031; }
        .card.math-mode .card-content { font-family: 'Times New Roman', serif; font-weight: bold; color: #0984e3; }

        /* ç­”æ¡ˆæ¨™ç±¤ */
        .answer-label {
            display: none; 
            width: 100%; background: rgba(0,0,0,0.7); color: white;
            font-size: 1.2rem; padding: 5px 0; text-align: center;
            position: absolute; bottom: 0; left: 0; font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        .card.show-hint .answer-label { display: block; }

        .card.active {
            border-color: var(--primary-color) !important; transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.8); z-index: 5;
        }
        .card.active:not(.color-card) { background-color: #ffeaa7; }

        #pause-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 50; display: none;
            align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(5px);
        }
        #pause-overlay h2 { color: white; font-size: 4rem; margin: 0 0 20px 0; }

        /* çµæŸç•«é¢ */
        #end-screen {
            display: none; flex-direction: column; align-items: center; gap: 20px;
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
        }
        
        #audio-player-container {
            width: 100%; background: #f1f2f6; padding: 10px; border-radius: 10px;
            text-align: center; display: none; margin-bottom: 10px;
        }
        audio { width: 100%; margin-top: 5px; }

        /* éŠæˆ²æ­·å²æ¸…å–® */
        #game-history {
            width: 100%; text-align: left; background: #fafafa; padding: 10px;
            border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px;
        }
        .history-round { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #ddd; }
        .history-title { font-weight:bold; color: var(--primary-color); margin-bottom: 5px; }
        .history-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        .history-item {
            display: flex; flex-direction: column; align-items: center; 
            border: 1px solid #eee; border-radius: 5px; padding: 5px; background: white;
        }
        .history-thumb { 
            width: 100%; aspect-ratio: 1; object-fit: contain; 
            display:flex; align-items:center; justify-content:center; font-size:1.5rem;
        }
        .history-name { font-size: 0.8rem; color: #555; text-align: center; margin-top: 2px; font-weight: bold; overflow-wrap: break-word; word-break: break-all; width: 100%;}

        .hidden { display: none !important; }
        #folder-input { display: none; }
    </style>
</head>
<body>

    <div id="home-screen">
        <button id="mute-home" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
        <button id="settings-trigger" class="icon-btn" onclick="openSettings()" title="è¨­å®š">âš™ï¸</button>
        <h1>ğŸµ ç¯€å¥éŠæˆ²</h1>
        <p style="color: #888; font-size: 1rem; margin-top: -10px; font-weight: bold;">
    Created by weic58 and Google Gemini
	</p>
        <div class="theme-selector">
            <label style="font-weight:bold; color:#555;">é¸æ“‡ä¸»é¡Œ</label>
            <select id="theme-select" onchange="saveSettings()">
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
                
                <optgroup label="ğŸ” è‡ªè¨‚æœå°‹">
                    </optgroup>

                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="flags">ğŸ—ºï¸ åœ‹æ——æŒ‘æˆ°</option>
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>

                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
            </select>
        </div>

        <div class="theme-selector" style="margin-top:10px;">
            <label style="font-weight:bold; color:#555;">ç¸½å›åˆæ•¸</label>
            <select id="round-select" onchange="saveSettings()">
                <option value="3">3 å›åˆ</option>
                <option value="5">5 å›åˆ</option>
                <option value="10">10 å›åˆ</option>
                <option value="999">ç„¡é™ç·´ç¿’</option>
            </select>
        </div>

        <button class="btn-primary" style="margin-top:20px; width:200px;" onclick="startGame()">START</button>
    </div>

    <div id="settings-modal" onclick="closeSettings(event)">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
                <button class="close-btn" onclick="closeSettingsBtn()">âœ•</button>
            </div>

            <div class="control-group" style="border: 2px solid #54a0ff; background: #f0f8ff;">
                <label style="color:#54a0ff;">ğŸ” ç¶­åŸºç™¾ç§‘æœå°‹ (æ”¯æ´æ›åœ–/åˆªé™¤)</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="search-input" placeholder="è¼¸å…¥: é¦™è•‰,è˜‹æœ (ä»¥é€—è™Ÿæˆ–ç©ºæ ¼åˆ†éš”)">
                    <button class="btn-action" onclick="searchWikiImages()">æœå°‹</button>
                </div>
                
                <div id="preview-area">
                    <div style="font-size:0.8rem; margin-bottom:5px; color:#555;">é è¦½ (æŒ‰ğŸ”„æ›åœ–, âŒåˆªé™¤):</div>
                    <div id="preview-grid"></div>
                    <div class="preview-controls">
                        <button class="btn-action" style="background:#2ed573;" onclick="confirmSearchTheme()">âœ… ç¢ºèªä½¿ç”¨</button>
                    </div>
                </div>
            </div>

            <div class="control-group" style="border: 2px dashed #2ed573; background: #eafff2;">
                <label>ğŸ“‚ ä¸Šå‚³è‡ªè¨‚ä¸»é¡Œè³‡æ–™å¤¾</label>
                <input type="file" id="folder-input" webkitdirectory directory multiple>
                <button class="btn-upload" onclick="document.getElementById('folder-input').click()">
                    é»æ“Šé¸æ“‡è³‡æ–™å¤¾...
                </button>
                <div id="upload-status">æª”åå³ç‚ºç­”æ¡ˆ (ä¾‹: çš®å¡ä¸˜.jpg)</div>
            </div>

            <div class="control-group">
                <label>ğŸµ èƒŒæ™¯éŸ³æ¨‚</label>
                <div style="margin-bottom: 10px;">
                    <label style="font-size:0.85rem; color:#666;">ä¸Šå‚³æª”æ¡ˆ (MP3/WAV):</label>
                    <input type="file" id="music-file">
                </div>
                <div style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                    <span id="file-status">æœªé¸æ“‡æª”æ¡ˆ</span>
                    <button class="btn-test" onclick="testAudio()">ğŸ”Š è©¦è½</button>
                </div>
            </div>

            <div class="control-group">
                <label>ğŸ’¡ ç­”æ¡ˆæç¤º (æ¼¸é€²å¼è¨˜æ†¶):</label>
                <select id="hint-mode" onchange="saveSettings()">
                    <option value="first">åƒ…ç¬¬ä¸€å›åˆ (è¨˜æ†¶æ¨¡å¼)</option>
                    <option value="always">æ¯å›åˆéƒ½é¡¯ç¤º (ç·´ç¿’)</option>
                    <option value="none">éš±è— (è€ƒè©¦)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ”‚ åŒä¸€å›åˆé¡Œç›®é‡è¤‡åº¦:</label>
                <select id="unique-count" onchange="saveSettings()">
                    <option value="8">8 å¼µéƒ½ä¸ä¸€æ¨£ (é è¨­)</option>
                    <option value="4">4 ç¨®åœ– (å„å‡ºç¾2æ¬¡)</option>
                    <option value="2">2 ç¨®åœ– (å„å‡ºç¾4æ¬¡)</option>
                    <option value="1">1 ç¨®åœ– (å…¨éƒ¨ç›¸åŒ)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ™ï¸ éŠæˆ²éŒ„éŸ³ (çµæŸå¾Œå›æ”¾):</label>
                <select id="record-toggle" onchange="saveSettings()">
                    <option value="off">é—œé–‰</option>
                    <option value="on">é–‹å•Ÿ (éœ€éº¥å…‹é¢¨æ¬Šé™)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ¢â© éŸ³æ¨‚å€é€Ÿ: <span id="rate-display" style="color:#e056fd;">1.0</span>x</label>
                <input type="range" id="rate-input" min="0.5" max="2.0" step="0.1" value="1.0" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â±ï¸ åŸæ›²é€Ÿåº¦ (BPM): <span id="bpm-display" style="color:var(--primary-color);">165</span></label>
                <input type="range" id="bpm-input" min="60" max="180" value="165" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â¯ï¸ éŸ³æ¨‚èµ·é» (ç§’):</label>
                <input type="number" id="offset-input" value="0" step="0.1" oninput="saveSettings()">
            </div>

            <div class="control-group">
                <label>â³ éŸ³æ¨‚å¾Œç­‰å¾… (ç§’):</label>
                <input type="number" id="intro-seconds-input" value="2.5" step="0.1" placeholder="ä¾‹å¦‚: 2.5" oninput="saveSettings()">
                <div style="text-align:right; font-weight:bold; color:#555;">0.5å€é€Ÿè«‹èª¿æˆ5.0/5.5ç§’(é›»è…¦/æ‰‹æ©Ÿ)</div>
            </div>

            <div class="control-group">
                <label>ğŸ›Œ å›åˆé–“éš” (ç§’):</label>
                <input type="range" id="interval-input" min="0" max="5" value="0" step="0.5" oninput="saveSettings()">
                <div style="text-align:right; font-weight:bold; color:#555;"><span id="interval-display">0</span> ç§’</div>
            </div>
            
            <button class="btn-primary" style="width:100%; font-size:1rem;" onclick="closeSettingsBtn()">å®Œæˆ</button>
        </div>
    </div>

    <div id="game-screen">
        <div class="top-bar">
            <button class="icon-btn" onclick="goHome()" title="å›é¦–é ">ğŸ </button>
            <div class="top-right-controls">
                <button id="mute-game" class="icon-btn" onclick="toggleMute()" title="éœéŸ³">ğŸ”Š</button>
                <button class="icon-btn" id="pause-btn" onclick="togglePause()" title="æš«åœ">â¸</button>
                <button class="icon-btn" onclick="restartGame()" title="é‡ç½®">ğŸ”„</button>
            </div>
        </div>
        <div id="info-bar">Round <span id="current-round">1</span> / <span id="total-rounds">3</span></div>
        <div id="grid-container"></div>
    </div>

    <div id="pause-overlay">
        <h2>PAUSED</h2>
        <button class="btn-primary" style="width: 200px;" onclick="togglePause()">ç¹¼çºŒ</button>
    </div>

    <div id="end-screen">
        <h1>ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h1>
        
        <div id="audio-player-container">
            <h3>ğŸ™ï¸ ä½ çš„è¡¨ç¾å›æ”¾</h3>
            <audio id="record-player" controls></audio>
        </div>

        <div style="width:100%;">
            <h3 style="margin-bottom:10px;">ğŸ“œ æœ¬å±€é¡Œç›®å›é¡§ (æ‰€æœ‰ç­”æ¡ˆ)</h3>
            <div id="game-history"></div>
        </div>

        <div style="display:flex; gap:20px; margin-top:10px;">
            <button class="icon-btn" onclick="goHome()">ğŸ </button>
            <button class="btn-primary" onclick="restartGame()">å†ä¾†ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« ---
        // åœ‹æ—— (FlagCDN)
        const flagsData = [
            { c: 'tw', n: 'å°ç£' }, { c: 'jp', n: 'æ—¥æœ¬' }, { c: 'us', n: 'ç¾åœ‹' }, { c: 'kr', n: 'éŸ“åœ‹' },
            { c: 'cn', n: 'ä¸­åœ‹' }, { c: 'gb', n: 'è‹±åœ‹' }, { c: 'fr', n: 'æ³•åœ‹' }, { c: 'de', n: 'å¾·åœ‹' },
            { c: 'it', n: 'ç¾©å¤§åˆ©' }, { c: 'ca', n: 'åŠ æ‹¿å¤§' }, { c: 'au', n: 'æ¾³æ´²' }, { c: 'br', n: 'å·´è¥¿' },
            { c: 'in', n: 'å°åº¦' }, { c: 'th', n: 'æ³°åœ‹' }, { c: 'vn', n: 'è¶Šå—' }, { c: 'ph', n: 'è²å¾‹è³“' },
            { c: 'my', n: 'é¦¬ä¾†è¥¿äº' }, { c: 'sg', n: 'æ–°åŠ å¡' }, { c: 'ch', n: 'ç‘å£«' }, { c: 'es', n: 'è¥¿ç­ç‰™' },
            { c: 'ru', n: 'ä¿„ç¾…æ–¯' }, { c: 'id', n: 'å°å°¼' }, { c: 'mx', n: 'å¢¨è¥¿å“¥' }, { c: 'tr', n: 'åœŸè€³å…¶' }
        ];

        const commonData = {
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ'],
            numbers: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
            colors: [
                {c:'#ff0000', n:'ç´…'}, {c:'#00ff00', n:'ç¶ '}, {c:'#0000ff', n:'è—'}, 
                {c:'#ffff00', n:'é»ƒ'}, {c:'#000000', n:'é»‘'}, {c:'#ffffff', n:'ç™½'}, 
                {c:'#ff00ff', n:'ç´«'}, {c:'#00ffff', n:'é’'}, {c:'#ffa500', n:'æ©˜'}
            ],
            math: ['+','-','Ã—','Ã·','=','â‰ ','â‰ˆ','>','<','Ï€','âˆš','âˆ','âˆ«','âˆ†','âˆ‘','Î©'],
            food: [
                { u: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=400&q=80', n: 'Pizza' },
                { u: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&q=80', n: 'Burger' },
                { u: 'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=400&q=80', n: 'Sushi' },
                { u: 'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80', n: 'Pancake' },
                { u: 'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=400&q=80', n: 'Pasta' },
                { u: 'https://images.unsplash.com/photo-1529042410759-befb1204b468?w=400&q=80', n: 'Meatball' },
                { u: 'https://images.unsplash.com/photo-1551024709-8f23befc6f87?w=400&q=80', n: 'Drink' },
                { u: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&q=80', n: 'BBQ' }
            ]
        };

        const chineseGroups = {
            'shi': ['æ˜¯','äº‹','ä¸–','å¸‚','å¼','è©¦','å£«','ç¤º','è¦–','èª“','æ–½','æ¿•','ç…','å¤±','å²','ä½¿','å§‹','çŸ³','é£Ÿ','å','å¯¦'],
            'ji': ['æ©Ÿ','é›','åŸº','ç©','ç¸¾','è·¡','æ¿€','æ¥µ','æ€¥','å‰','å³','é›†','æ“Š','è¨ˆ','è¨˜','å­£','æŠ€','æ—¢','æ¿Ÿ','ç¹¼'],
            'yi': ['ä¸€','é†«','è¡£','ä¾','ä¼Š','ç§»','ç–‘','å„€','å®œ','éº','ä¹™','å·²','ä»¥','èŸ»','å€š','æ„','ç¾©','è­°','ç›Š','è—'],
            'fu': ['å¤«','è†š','ç¦','æœ','å¹…','åºœ','çˆ¶','ä»˜','è² ','å©¦','å¯Œ','å‰¯','å¾©','è…¹','è¦†','æµ®','æ‰¶','ç¬¦'],
            'yu': ['é­š','æ¼','æ–¼','é¤˜','å¨›','æ„š','é›¨','èˆ‡','äºˆ','èª','ç¾½','ç‰','è‚²','é ','é‡','æ¬²','ç„','åŸŸ']
        };

        let customData = {}; 
        let searchData = {}; 
        let tempSearchItems = []; // {label, images[], currentIndex}

        let gameState = {
            round: 0, maxRounds: 3, theme: 'flags', bpm: 165,
            offset: 0, interval: 0, introSeconds: 2.4, playbackRate: 1.0, 
            isPaused: false, abortController: null, selectedTheme: 'flags',
            isRecording: false, 
            activePool: [], 
            hintMode: 'first',
            uniqueCount: 8, 
            isMuted: false, 
            history: [] 
        };

        let audioCtx;
        let bgmAudio = new Audio();
        bgmAudio.preload = "auto"; 
        
        let mediaRecorder;
        let audioChunks = [];

        // --- 1. æœå°‹ (æ”¹å› Wikipedia API - è¼ƒç²¾æº–) ---
        async function searchWikiImages() {
            const inputVal = document.getElementById('search-input').value.trim();
            if (!inputVal) return;

            // [,ï¼Œ\s] ä»£è¡¨ï¼šé€—è™Ÿ OR å…¨å½¢é€—è™Ÿ OR ä»»ä½•ç©ºç™½(åŒ…å«å…¨å½¢ç©ºæ ¼)
            // + ä»£è¡¨ï¼šå¦‚æœé€£çºŒè¼¸å…¥å¤šå€‹ç©ºæ ¼ï¼Œè¦–ç‚ºä¸€å€‹åˆ†éš”ç¬¦
            const keywords = inputVal.split(/[,ï¼Œ\s]+/).map(k => k.trim()).filter(k => k);

            if (keywords.length === 0) return;

            const previewArea = document.getElementById('preview-area');
            const grid = document.getElementById('preview-grid');
            
            previewArea.style.display = 'block';
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">æœå°‹ç¶­åŸºç™¾ç§‘æ¢ç›®ä¸­...</div>';
            tempSearchItems = [];

            let fullKeywords = [];
            while(fullKeywords.length < 8) {
                fullKeywords = fullKeywords.concat(keywords);
            }
            fullKeywords = fullKeywords.slice(0, 8); 

            for (let i = 0; i < 8; i++) {
                tempSearchItems.push({
                    label: fullKeywords[i],
                    images: [],
                    currentIndex: 0
                });
            }

            const uniqueKeywords = [...new Set(keywords)];
            const keywordImageMap = {}; 

            for (let kw of uniqueKeywords) {
                try {
                    // æ”¹å› zh.wikipedia.orgï¼ŒæŠ“å–æ¢ç›®ç¸®åœ– (pageimages)
                    const url = `https://zh.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(kw)}&gsrlimit=20&prop=pageimages&pithumbsize=400&format=json&origin=*`;
                    
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    keywordImageMap[kw] = [];
                    
                    if (data.query && data.query.pages) {
                        Object.values(data.query.pages).forEach(page => {
                            // åˆ¤æ–·æ˜¯å¦æœ‰ç¸®åœ–
                            if (page.thumbnail && page.thumbnail.source) {
                                keywordImageMap[kw].push(page.thumbnail.source);
                            }
                        });
                    }
                    
                    if (keywordImageMap[kw].length === 0) {
                        keywordImageMap[kw].push(`https://placehold.co/200x200?text=${kw}`);
                    }
                } catch(e) { console.error(e); }
            }

            tempSearchItems.forEach(slot => {
                if (keywordImageMap[slot.label]) {
                    slot.images = keywordImageMap[slot.label];
                }
            });

            renderPreviewGrid();
        }

        function renderPreviewGrid() {
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            tempSearchItems.forEach((slot, index) => {
                if (slot.deleted) return;

                const div = document.createElement('div');
                div.className = 'preview-item';
                
                const currentImg = slot.images[slot.currentIndex % slot.images.length] || 'https://placehold.co/200x200?text=NoImg';
                
                div.innerHTML = `
                    <div class="preview-actions">
                        <button class="btn-mini btn-swap" onclick="swapPreviewImage(${index})" title="æ›ä¸€å¼µ">ğŸ”„</button>
                        <button class="btn-mini btn-remove" onclick="removePreviewImage(${index})" title="ç§»é™¤">âŒ</button>
                    </div>
                    <img src="${currentImg}" class="preview-img" id="prev-img-${index}">
                    <div class="preview-label">${slot.label}</div>
                `;
                grid.appendChild(div);
            });
        }

        function swapPreviewImage(index) {
            const slot = tempSearchItems[index];
            if (slot && slot.images.length > 1) {
                slot.currentIndex++;
                const newImg = slot.images[slot.currentIndex % slot.images.length];
                document.getElementById(`prev-img-${index}`).src = newImg;
            }
        }

        function removePreviewImage(index) {
            if(tempSearchItems[index]) {
                tempSearchItems[index].deleted = true;
                renderPreviewGrid();
            }
        }

        function confirmSearchTheme() {
            const activeItems = tempSearchItems.filter(item => !item.deleted);
            if (activeItems.length === 0) {
                alert("è«‹è‡³å°‘ä¿ç•™ä¸€å¼µåœ–ç‰‡ï¼");
                return;
            }

            const finalImages = activeItems.map(slot => ({
                url: slot.images[slot.currentIndex % slot.images.length],
                label: slot.label
            }));

            const keyword = document.getElementById('search-input').value.trim().substring(0, 10);
            const themeKey = "search_" + Date.now();
            searchData[themeKey] = finalImages;

            updateThemeSelect();
            document.getElementById('theme-select').value = themeKey;
            saveSettings();
            
            document.getElementById('preview-area').style.display = 'none'; 
            document.getElementById('search-status').innerText = `âœ… å·²å¥—ç”¨ä¸»é¡Œ (å…±${finalImages.length}å¼µ)`;
        }

        // --- 2. è³‡æ–™å¤¾ & éŸ³æ¨‚ ---
        document.getElementById('folder-input').addEventListener('change', function(e) {
            const files = e.target.files;
            let count = 0;
            customData = {}; 
            for (let file of files) {
                if (!file.type.startsWith('image/')) continue;
                const pathParts = file.webkitRelativePath.split('/');
                let themeName = (pathParts.length > 1) ? pathParts[pathParts.length - 2] : "è‡ªè¨‚ç›¸ç°¿";
                if (!customData[themeName]) customData[themeName] = [];
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                customData[themeName].push({ url: URL.createObjectURL(file), label: fileName });
                count++;
            }
            updateThemeSelect();
            document.getElementById('upload-status').innerText = `âœ… æˆåŠŸè¼‰å…¥ ${Object.keys(customData).length} å€‹ä¸»é¡Œï¼Œå…± ${count} å¼µåœ–ç‰‡`;
        });

        document.getElementById('music-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('file-status').innerText = `âŒ› è®€å–ä¸­...`;

            const reader = new FileReader();
            reader.onload = function(evt) {
                bgmAudio.src = evt.target.result;
                bgmAudio.load();
                document.getElementById('file-status').innerText = `âœ… æœ¬åœ°æª”æ¡ˆ: ${file.name}`;
            };
            reader.onerror = function() { alert("è®€å–å¤±æ•—"); };
            reader.readAsDataURL(file);
            this.value = ''; 
        });

        function testAudio() {
            if (!bgmAudio.src) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
            bgmAudio.volume = gameState.isMuted ? 0 : 1.0;
            bgmAudio.playbackRate = parseFloat(document.getElementById('rate-input').value);
            
            const playPromise = bgmAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    document.getElementById('file-status').innerText += " (æ’­æ”¾ä¸­)";
                    setTimeout(() => { bgmAudio.pause(); bgmAudio.currentTime = 0; }, 3000); 
                })
                .catch(error => {
                    alert(`æ’­æ”¾å¤±æ•— (Error: ${error.name})`);
                });
            }
        }

        // --- éœéŸ³åŠŸèƒ½ ---
        function toggleMute() {
            gameState.isMuted = !gameState.isMuted;
            bgmAudio.muted = gameState.isMuted;
            const icon = gameState.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            document.getElementById('mute-home').innerText = icon;
            document.getElementById('mute-game').innerText = icon;
        }

        // --- 3. éŒ„éŸ³ ---
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            // HTTPS warning
        }

        async function startRecording() {
            if (document.getElementById('record-toggle').value !== 'on') return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4'; 
                }
                const options = mimeType ? { mimeType } : undefined;
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.start();
                gameState.isRecording = true;
            } catch (err) {
                console.error("Mic Error:", err);
                document.getElementById('record-toggle').value = 'off';
            }
        }

        function stopRecording() {
            if (gameState.isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    const audioUrl = URL.createObjectURL(blob);
                    const player = document.getElementById('record-player');
                    player.src = audioUrl;
                    document.getElementById('audio-player-container').style.display = 'block';
                };
                gameState.isRecording = false;
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        // --- 4. UI æ§åˆ¶ ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettingsBtn() { document.getElementById('settings-modal').style.display = 'none'; }
        function closeSettings(e) { if(e.target.id === 'settings-modal') closeSettingsBtn(); }

        function saveSettings() {
            localStorage.setItem('rg_theme', document.getElementById('theme-select').value);
            localStorage.setItem('rg_rounds', document.getElementById('round-select').value);
            localStorage.setItem('rg_bpm', document.getElementById('bpm-input').value);
            localStorage.setItem('rg_offset', document.getElementById('offset-input').value);
            localStorage.setItem('rg_intro', document.getElementById('intro-seconds-input').value);
            localStorage.setItem('rg_interval', document.getElementById('interval-input').value);
            localStorage.setItem('rg_rate', document.getElementById('rate-input').value);
            localStorage.setItem('rg_record', document.getElementById('record-toggle').value);
            localStorage.setItem('rg_hint', document.getElementById('hint-mode').value);
            localStorage.setItem('rg_unique', document.getElementById('unique-count').value);
            
            document.getElementById('bpm-display').innerText = document.getElementById('bpm-input').value;
            document.getElementById('interval-display').innerText = document.getElementById('interval-input').value;
            document.getElementById('rate-display').innerText = document.getElementById('rate-input').value;
        }

        function loadSettings() {
            const s = localStorage;
            if(s.getItem('rg_rounds')) document.getElementById('round-select').value = s.getItem('rg_rounds');
            if(s.getItem('rg_bpm')) {
                document.getElementById('bpm-input').value = s.getItem('rg_bpm');
                document.getElementById('bpm-display').innerText = s.getItem('rg_bpm');
            }
            if(s.getItem('rg_offset')) document.getElementById('offset-input').value = s.getItem('rg_offset');
            if(s.getItem('rg_intro')) document.getElementById('intro-seconds-input').value = s.getItem('rg_intro');
            if(s.getItem('rg_interval')) {
                document.getElementById('interval-input').value = s.getItem('rg_interval');
                document.getElementById('interval-display').innerText = s.getItem('rg_interval');
            }
            if(s.getItem('rg_rate')) {
                document.getElementById('rate-input').value = s.getItem('rg_rate');
                document.getElementById('rate-display').innerText = s.getItem('rg_rate');
            }
            if(s.getItem('rg_record')) document.getElementById('record-toggle').value = s.getItem('rg_record');
            if(s.getItem('rg_hint')) document.getElementById('hint-mode').value = s.getItem('rg_hint');
            if(s.getItem('rg_unique')) document.getElementById('unique-count').value = s.getItem('rg_unique');
        }

        function updateThemeSelect() {
            const select = document.getElementById('theme-select');
            
            select.innerHTML = `
                <option value="random_mixed">ğŸ§ª å¤§é›œç‡´ (å…¨éƒ¨æ··åˆ)</option>
                <option value="random_round">ğŸ² éš¨æ©Ÿ (æ¯å›åˆæ›)</option>
                <option value="random_locked">ğŸ”’ éš¨æ©Ÿ (æ•´å±€é–å®š)</option>
            `;

            const searchGroup = document.createElement('optgroup');
            searchGroup.label = "ğŸ” è‡ªè¨‚æœå°‹çµæœ";
            for (let theme in searchData) {
                const opt = document.createElement('option');
                opt.value = theme;
                opt.innerText = `ğŸ” è‡ªè¨‚: ${searchData[theme][0].label}...`;
                searchGroup.appendChild(opt);
            }
            select.appendChild(searchGroup);

            if (Object.keys(customData).length > 0) {
                const group = document.createElement('optgroup');
                group.label = "ğŸ“‚ æœ¬åœ°è³‡æ–™å¤¾";
                for (let theme in customData) {
                    if (customData[theme].length > 0) {
                        const opt = document.createElement('option');
                        opt.value = "custom_" + theme;
                        opt.innerText = `ğŸ“ ${theme} (${customData[theme].length}å¼µ)`;
                        group.appendChild(opt);
                    }
                }
                select.appendChild(group);
            }

            select.innerHTML += `
                <optgroup label="å…§å»ºä¸»é¡Œ">
                    <option value="flags">ğŸ—ºï¸ åœ‹æ——æŒ‘æˆ°</option>
                    <option value="math">â— æ•¸å­¸ç¬¦è™Ÿ</option>
                    <option value="chinese_phonetic">ğŸ€„ï¸ ä¸­æ–‡å­— (ç¹å£ä»¤)</option>
                    <option value="animals">ğŸ¦ å‹•ç‰© Emoji</option>
                    <option value="numbers">ğŸ”¢ æ•¸å­—</option>
                    <option value="colors">ğŸ¨ é¡è‰²</option>
                </optgroup>
                <optgroup label="API / é€£ç¶²ä¸»é¡Œ">
                    <option value="pokemon">âš¡ï¸ å¯¶å¯å¤¢ (PokeAPI)</option>
                    <option value="robots">ğŸ¤– æ©Ÿå™¨äºº (RoboHash)</option>
                    <option value="food">ğŸ” ç™‚ç™’ç¾é£Ÿ (ç²¾é¸)</option>
                </optgroup>
            `;
            
            const lastTheme = localStorage.getItem('rg_theme');
            if (lastTheme && select.querySelector(`option[value="${lastTheme}"]`)) {
                select.value = lastTheme;
            }
        }

        window.addEventListener('load', async () => {
            loadSettings();
            updateThemeSelect();
        });

        // --- 5. éŠæˆ²æ ¸å¿ƒ ---
        class SmartTimer {
            constructor(callback, delay) {
                this.remaining = delay; this.callback = callback;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), delay);
            }
            pause() {
                window.clearTimeout(this.timerId); this.timerId = null;
                this.remaining -= Date.now() - this.start;
            }
            resume() {
                if (this.timerId) return;
                this.start = Date.now();
                this.timerId = setTimeout(this.finish.bind(this), this.remaining);
            }
            finish() { this.callback(); }
        }

        function wait(ms) {
            if (ms <= 0) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const timer = new SmartTimer(resolve, ms);
                if (!window.currentTimers) window.currentTimers = [];
                window.currentTimers.push(timer);
                if (gameState.abortController.signal.aborted) reject(new Error("Aborted"));
                gameState.abortController.signal.addEventListener('abort', () => {
                    window.clearTimeout(timer.timerId); reject(new Error("Aborted"));
                });
            });
        }

        // --- æ•¸æ“šæ± åˆå§‹åŒ– ---
        function initActivePool(theme) {
            let pool = [];
            
            if (theme === 'flags') {
                pool = flagsData.map(f => ({ content: `https://flagcdn.com/w640/${f.c}.png`, label: f.n, theme: 'flags' }));
            } else if (theme.startsWith('search_')) {
                // ä½¿ç”¨æœå°‹çµæœ
                pool = searchData[theme].map(item => ({ content: item.url, label: item.label, theme: 'search' }));
            } else if (theme.startsWith('custom_')) {
                const real = theme.replace('custom_', '');
                if (customData[real]) pool = customData[real].map(i => ({ content: i.url, label: i.label, theme: 'custom' }));
            } else if (theme === 'pokemon') {
                for(let i=0; i<30; i++) {
                    const id = Math.floor(Math.random() * 151) + 1;
                    pool.push({ content: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`, label: 'Pokemon', theme: 'pokemon' });
                }
            } else if (theme === 'robots') {
                for(let i=0; i<30; i++) {
                    const txt = Math.random().toString(36).substring(7);
                    pool.push({ content: `https://robohash.org/${txt}?set=set1`, label: 'Robot', theme: 'robots' });
                }
            } else if (theme === 'food') {
                pool = commonData.food.map(f => ({ content: f.u, label: f.n, theme: 'food' }));
            } else if (theme === 'colors') {
                pool = commonData.colors.map(c => ({ content: c.c, label: c.n, theme: 'colors' }));
            } else if (theme === 'chinese_phonetic') {
                const keys = Object.keys(chineseGroups);
                const k = keys[Math.floor(Math.random() * keys.length)];
                pool = chineseGroups[k].map(word => ({ content: word, label: word, theme: 'chinese_phonetic' }));
            } else if (commonData[theme]) {
                pool = commonData[theme].map(item => ({ content: item, label: item, theme: theme }));
            } else {
                pool = commonData.animals.map(item => ({ content: item, label: 'Animal', theme: 'animals' }));
            }

            // é˜²å‘†è£œæ»¿
            if (pool.length > 0 && pool.length < 8) {
                while (pool.length < 8) {
                    pool = pool.concat(pool);
                }
            }

            // è™•ç†ã€Œé‡è¤‡å‡ºé¡Œæ•¸ã€
            const uCount = parseInt(gameState.uniqueCount) || 8;
            const uniqueItems = pool.sort(() => 0.5 - Math.random()).slice(0, uCount);
            
            let final8 = [];
            while(final8.length < 8) {
                final8 = final8.concat(uniqueItems);
            }
            return final8.slice(0, 8);
        }

        async function startGame() {
            gameState.maxRounds = parseInt(document.getElementById('round-select').value);
            gameState.selectedTheme = document.getElementById('theme-select').value;
            gameState.bpm = parseInt(document.getElementById('bpm-input').value);
            gameState.offset = parseFloat(document.getElementById('offset-input').value);
            gameState.interval = parseFloat(document.getElementById('interval-input').value);
            gameState.introSeconds = parseFloat(document.getElementById('intro-seconds-input').value) || 0;
            gameState.playbackRate = parseFloat(document.getElementById('rate-input').value) || 1.0;
            gameState.hintMode = document.getElementById('hint-mode').value;
            gameState.uniqueCount = parseInt(document.getElementById('unique-count').value);
            
            gameState.round = 0;
            gameState.abortController = new AbortController();
            gameState.history = []; 
            window.currentTimers = [];

            let finalTheme = gameState.selectedTheme;
            if (finalTheme === 'random_locked') {
                const allT = getAllThemes().filter(t => !t.startsWith('random'));
                finalTheme = allT[Math.floor(Math.random() * allT.length)];
            }
            
            if (finalTheme !== 'random_mixed' && finalTheme !== 'random_round') {
                gameState.activePool = initActivePool(finalTheme);
            }
            gameState.currentRunTheme = finalTheme;

            // éœéŸ³æ§åˆ¶
            bgmAudio.muted = gameState.isMuted;

            if (bgmAudio.src) {
                try {
                    bgmAudio.volume = 0; 
                    await bgmAudio.play();
                    bgmAudio.pause();
                    bgmAudio.currentTime = 0;
                    if (!gameState.isMuted) bgmAudio.volume = 1;
                } catch (e) { console.log("Unlock failed"); }
            }

            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('audio-player-container').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('total-rounds').innerText = gameState.maxRounds;

            startRecording();
            runGameLoop();
        }

        function getAllThemes() {
            let t = ['flags', 'pokemon', 'robots', 'food', 'math', 'chinese_phonetic', 'animals', 'numbers', 'colors'];
            for (let k in customData) t.push('custom_' + k);
            for (let k in searchData) t.push(k);
            return t;
        }

        function getMixedItems() {
            const allT = getAllThemes();
            let items = [];
            for(let i=0; i<8; i++) {
                const t = allT[Math.floor(Math.random() * allT.length)];
                const pool = initActivePool(t);
                items.push(pool[0]);
            }
            return items;
        }

        async function runGameLoop() {
            try {
                bgmAudio.playbackRate = gameState.playbackRate;

                while (gameState.round < gameState.maxRounds) {
                    gameState.round++;
                    document.getElementById('current-round').innerText = gameState.round;
                    
                    if (bgmAudio.src) {
                        if (gameState.offset < 0) {
                            bgmAudio.currentTime = 0;
                            await wait(Math.abs(gameState.offset) * 1000);
                            bgmAudio.play().catch(e=>console.log(e));
                        } else {
                            bgmAudio.currentTime = gameState.offset;
                            bgmAudio.play().catch(e=>console.log(e));
                        }
                    }

                    const grid = document.getElementById('grid-container');
                    grid.innerHTML = '';
                    let items = [];

                    if (gameState.currentRunTheme === 'random_mixed') {
                        items = getMixedItems();
                    } else if (gameState.currentRunTheme === 'random_round') {
                        const allT = getAllThemes();
                        const t = allT[Math.floor(Math.random() * allT.length)];
                        items = initActivePool(t);
                    } else {
                        items = [...gameState.activePool].sort(() => 0.5 - Math.random());
                    }
                    
                    gameState.history.push({ round: gameState.round, items: items });

                    let showHint = false;
                    if (gameState.hintMode === 'always') showHint = true;
                    if (gameState.hintMode === 'first' && gameState.round === 1) showHint = true;

                    items.forEach(obj => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        if (showHint) card.classList.add('show-hint');

                        const content = document.createElement('div');
                        content.className = 'card-content';

                        const isUrl = typeof obj.content === 'string' && (obj.content.startsWith('http') || obj.content.startsWith('blob:'));
                        
                        if (isUrl) {
                            card.classList.add('contain-img');
                            content.innerHTML = `<img src="${obj.content}" onerror="this.src='https://placehold.co/200x200?text=Error'">`;
                        } else if (obj.theme === 'colors') {
                            card.classList.add('color-card');
                            card.style.backgroundColor = obj.content;
                            if(obj.content === '#ffffff') card.style.borderColor = '#ddd';
                        } else {
                            content.innerText = obj.content;
                            if(obj.theme === 'numbers') card.classList.add('number-mode');
                            if(obj.theme === 'math') card.classList.add('math-mode');
                            if(obj.theme === 'chinese_phonetic') card.classList.add('chinese-mode');
                        }
                        
                        const label = document.createElement('div');
                        label.className = 'answer-label';
                        label.innerText = obj.label;

                        card.appendChild(content);
                        card.appendChild(label);
                        grid.appendChild(card);
                    });

                    if (gameState.introSeconds > 0) await wait(gameState.introSeconds * 1000);

                    const msPerBeat = (60000 / gameState.bpm) / gameState.playbackRate;
                    const cards = document.querySelectorAll('.card');
                    for (let i = 0; i < 8; i++) {
                        if (i>0) cards[i-1].classList.remove('active');
                        cards[i].classList.add('active');
                        await wait(msPerBeat);
                    }
                    if(cards.length>0) cards[7].classList.remove('active');

                    if (bgmAudio.src) bgmAudio.pause();
                    if (gameState.round < gameState.maxRounds) await wait(gameState.interval * 1000);
                }
                showEndScreen();
            } catch (error) {
                if (error.message !== "Aborted") console.error(error);
            }
        }

        function showEndScreen() {
            stopRecording();
            bgmAudio.pause();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('home-screen').classList.add('hidden');

            const historyDiv = document.getElementById('game-history');
            historyDiv.innerHTML = '';
            
            gameState.history.forEach(h => {
                const roundBlock = document.createElement('div');
                roundBlock.className = 'history-round';
                
                const title = document.createElement('div');
                title.className = 'history-title';
                title.innerText = `Round ${h.round}`;
                roundBlock.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'history-grid';

                h.items.forEach(item => {
                    const cell = document.createElement('div');
                    cell.className = 'history-item';
                    
                    let visual = '';
                    if (item.theme === 'colors') {
                        visual = `<div class="history-thumb" style="background:${item.content};"></div>`;
                    } else if (item.content.startsWith && (item.content.startsWith('http') || item.content.startsWith('blob:'))) {
                        visual = `<img class="history-thumb" src="${item.content}">`;
                    } else {
                        visual = `<div class="history-thumb">${item.content}</div>`;
                    }
                    
                    cell.innerHTML = `${visual}<div class="history-name">${item.label}</div>`;
                    grid.appendChild(cell);
                });

                roundBlock.appendChild(grid);
                historyDiv.appendChild(roundBlock);
            });
        }

        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            const overlay = document.getElementById('pause-overlay');
            const btn = document.getElementById('pause-btn');
            if (gameState.isPaused) {
                overlay.style.display = 'flex'; btn.innerText = 'â–¶ï¸';
                bgmAudio.pause(); 
                if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.pause();
                window.currentTimers.forEach(t => t.pause());
            } else {
                overlay.style.display = 'none'; btn.innerText = 'â¸';
                bgmAudio.play(); 
                if(mediaRecorder && mediaRecorder.state === 'paused') mediaRecorder.resume();
                window.currentTimers.forEach(t => t.resume());
            }
        }

        function resetLogic() {
            if (gameState.abortController) gameState.abortController.abort();
            bgmAudio.pause(); gameState.isPaused = false;
            stopRecording();
            document.getElementById('pause-overlay').style.display = 'none';
            document.getElementById('pause-btn').innerText = 'â¸';
        }

        function restartGame() { resetLogic(); setTimeout(startGame, 100); }
        function goHome() {
            resetLogic();
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('home-screen').style.display = 'flex';
        }
    </script>
</body>
</html>
